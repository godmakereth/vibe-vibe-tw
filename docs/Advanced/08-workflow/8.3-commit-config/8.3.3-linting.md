---
title: "8.3.3 機器人幫檢查格式——自動化：commitlint 與 husky 鉤子"
typora-root-url: ../../public
---

# 8.3.3 機器人幫檢查格式——自動化檢查

靠人記住規範是不可靠的——用工具自動檢查，提交前就攔住不規範的信息。

## 工具鏈概覽

```mermaid
flowchart LR
    A[git commit] --> B[husky]
    B --> C[commit-msg hook]
    C --> D[commitlint]
    D -->|通過| E[提交成功]
    D -->|失敗| F[拒絕提交]
```

| 工具 | 作用 |
|------|------|
| husky | Git hooks 管理工具 |
| commitlint | 檢查提交信息是否符合規範 |
| lint-staged | 只對暫存文件運行 linter |

## 安裝配置

### 1. 安裝依賴

```bash
# 安裝 husky 和 commitlint
pnpm add -D husky @commitlint/cli @commitlint/config-conventional

# 初始化 husky
pnpm exec husky init
```

### 2. 配置 commitlint

創建 `commitlint.config.js`：

```javascript
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    // type 必須是以下之一
    'type-enum': [
      2,
      'always',
      [
        'feat',     // 新功能
        'fix',      // 修復
        'docs',     // 文檔
        'style',    // 格式
        'refactor', // 重構
        'perf',     // 性能
        'test',     // 測試
        'build',    // 構建
        'ci',       // CI
        'chore',    // 雜項
        'revert',   // 回滾
      ],
    ],
    // type 不能爲空
    'type-empty': [2, 'never'],
    // subject 不能爲空
    'subject-empty': [2, 'never'],
    // subject 最大長度 100
    'subject-max-length': [2, 'always', 100],
  },
};
```

### 3. 配置 husky hook

```bash
# 創建 commit-msg hook
echo "pnpm exec commitlint --edit \$1" > .husky/commit-msg
```

或手動編輯 `.husky/commit-msg`：

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

pnpm exec commitlint --edit $1
```

## 驗證配置

```bash
# 測試：不規範的提交會被拒絕
git commit -m "update code"
# ⧗   input: update code
# ✖   subject may not be empty [subject-empty]
# ✖   type may not be empty [type-empty]

# 測試：規範的提交會通過
git commit -m "feat: 添加用戶登錄"
# ✔ Commit successful!
```

## 進階配置

### 自定義 scope

```javascript
// commitlint.config.js
module.exports = {
  extends: ['@commitlint/config-conventional'],
  rules: {
    'scope-enum': [
      2,
      'always',
      [
        'auth',      // 認證模塊
        'user',      // 用戶模塊
        'api',       // API 相關
        'ui',        // UI 組件
        'database',  // 數據庫
        'config',    // 配置
      ],
    ],
  },
};
```

### 支持中文

默認配置支持中文 subject，無需額外配置：

```bash
git commit -m "feat(auth): 添加用戶登錄功能"  # ✅ 通過
```

### 集成 lint-staged

在提交前同時檢查代碼質量：

```bash
pnpm add -D lint-staged
```

在 `package.json` 中配置：

```json
{
  "lint-staged": {
    "*.{ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{json,md}": [
      "prettier --write"
    ]
  }
}
```

配置 pre-commit hook：

```bash
echo "pnpm exec lint-staged" > .husky/pre-commit
```

## 完整配置示例

### package.json

```json
{
  "scripts": {
    "prepare": "husky"
  },
  "devDependencies": {
    "@commitlint/cli": "^18.0.0",
    "@commitlint/config-conventional": "^18.0.0",
    "husky": "^9.0.0",
    "lint-staged": "^15.0.0"
  },
  "lint-staged": {
    "*.{ts,tsx}": ["eslint --fix", "prettier --write"]
  }
}
```

### 目錄結構

```
project/
├── .husky/
│   ├── _/
│   ├── commit-msg      # commitlint 檢查
│   └── pre-commit      # lint-staged 檢查
├── commitlint.config.js
└── package.json
```

## 常見問題

### Q: hook 沒有執行？

```bash
# 確保 husky 已初始化
pnpm exec husky init

# 檢查 hook 文件權限
chmod +x .husky/commit-msg
```

### Q: 如何跳過檢查？

```bash
# 緊急情況可以跳過（不推薦）
git commit -m "feat: xxx" --no-verify
```

### Q: CI 中如何檢查？

```yaml
# .github/workflows/ci.yml
- name: Validate commits
  run: |
    pnpm exec commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }}
```

## AI 協作指南

**示例 Prompt**：
> "請幫我配置 commitlint，要求：
> 1. 使用 Conventional Commits 規範
> 2. scope 限制爲 auth、user、api、ui
> 3. subject 最大長度 80 字符"

## 驗收清單

- [ ] 成功安裝 husky 和 commitlint
- [ ] 配置了 commit-msg hook
- [ ] 不規範的提交會被拒絕
- [ ] 可選：配置了 lint-staged
