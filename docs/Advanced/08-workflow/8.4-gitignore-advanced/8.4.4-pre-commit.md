---
title: "8.4.4 ä»£ç¢¼æäº¤å‰è‡ªå‹•æª¢æŸ¥â€”â€”é˜²èª¤æäº¤é‰¤å­èˆ‡ CI è¯å‹•"
typora-root-url: ../../public
---

# 8.4.4 ä»£ç¢¼æäº¤å‰è‡ªå‹•æª¢æŸ¥â€”â€”é˜²èª¤æäº¤

.gitignore æ˜¯ç¬¬ä¸€é“é˜²ç·šï¼Œpre-commit æª¢æŸ¥æ˜¯ç¬¬äºŒé“â€”â€”é›™é‡ä¿éšªé˜²æ­¢æ•æ„Ÿæ–‡ä»¶é€²å…¥å€‰åº«ã€‚

## çˆ²ä»€éº¼éœ€è¦ pre-commit æª¢æŸ¥

| å ´æ™¯ | å•é¡Œ | è§£æ±ºæ–¹æ¡ˆ |
|------|------|----------|
| å¿˜è¨˜æ·»åŠ  .gitignore | æ–°æ–‡ä»¶é¡å‹è¢«æäº¤ | è‡ªå‹•æƒææ•æ„Ÿæ¨¡å¼ |
| ç¹é .gitignore | git add -f å¼·åˆ¶æ·»åŠ  | hook æ””æˆª |
| å¤§æ–‡ä»¶æ„å¤–æäº¤ | å€‰åº«è®Šè‡ƒè…« | æ–‡ä»¶å¤§å°æª¢æŸ¥ |
| æ•æ„Ÿä¿¡æ¯ç¡¬ç·¨ç¢¼ | å¯†é‘°å¯«åœ¨ä»£ç¢¼è£ | æ¨¡å¼åŒ¹é…æª¢æŸ¥ |

## ä½¿ç”¨ husky é…ç½® pre-commit

### å®‰è£é…ç½®

```bash
# åˆå§‹åŒ– husky
pnpm add -D husky
pnpm exec husky init
```

### å‰µå»ºæ•æ„Ÿæ–‡ä»¶æª¢æŸ¥è…³æœ¬

å‰µå»º `scripts/check-secrets.sh`ï¼š

```bash
#!/bin/bash

# æª¢æŸ¥æ˜¯å¦æœ‰æ•æ„Ÿæ–‡ä»¶è¢«æš«å­˜
SENSITIVE_PATTERNS=(
  "\.env$"
  "\.env\.local$"
  "\.pem$"
  "\.key$"
  "id_rsa"
  "\.p12$"
  "credentials\.json"
  "firebase.*\.json"
)

STAGED_FILES=$(git diff --cached --name-only)
FOUND_ISSUES=0

for file in $STAGED_FILES; do
  for pattern in "${SENSITIVE_PATTERNS[@]}"; do
    if [[ $file =~ $pattern ]]; then
      echo "âŒ æ•æ„Ÿæ–‡ä»¶è¢«æš«å­˜: $file"
      FOUND_ISSUES=1
    fi
  done
done

if [ $FOUND_ISSUES -eq 1 ]; then
  echo ""
  echo "è«‹ä½¿ç”¨ 'git reset HEAD <file>' ç§»é™¤æ•æ„Ÿæ–‡ä»¶"
  echo "å¦‚æœç¢ºå¯¦éœ€è¦æäº¤ï¼Œè«‹ä½¿ç”¨ 'git commit --no-verify'"
  exit 1
fi

echo "âœ… æ•æ„Ÿæ–‡ä»¶æª¢æŸ¥é€šé"
```

### é…ç½® pre-commit hook

ç·¨è¼¯ `.husky/pre-commit`ï¼š

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# æ•æ„Ÿæ–‡ä»¶æª¢æŸ¥
bash scripts/check-secrets.sh

# lint-stagedï¼ˆå¦‚æœé…ç½®äº†ï¼‰
pnpm exec lint-staged
```

## æª¢æŸ¥ç¡¬ç·¨ç¢¼çš„å¯†é‘°

### ä½¿ç”¨ gitleaks

```bash
# å®‰è£ gitleaks
brew install gitleaks

# åœ¨ pre-commit ä¸­æ·»åŠ æª¢æŸ¥
gitleaks protect --staged
```

### é…ç½® .gitleaks.toml

```toml
title = "Gitleaks Config"

[[rules]]
description = "AWS Access Key"
regex = '''AKIA[0-9A-Z]{16}'''
tags = ["aws", "key"]

[[rules]]
description = "OpenAI API Key"
regex = '''sk-[a-zA-Z0-9]{48}'''
tags = ["openai", "key"]

[[rules]]
description = "Generic Password"
regex = '''(?i)(password|pwd|pass)\s*[:=]\s*['"][^'"]{8,}['"]'''
tags = ["password"]
```

## å¤§æ–‡ä»¶æª¢æŸ¥

```bash
#!/bin/bash
# scripts/check-file-size.sh

MAX_SIZE=5000000  # 5MB

STAGED_FILES=$(git diff --cached --name-only)

for file in $STAGED_FILES; do
  if [ -f "$file" ]; then
    SIZE=$(wc -c < "$file")
    if [ $SIZE -gt $MAX_SIZE ]; then
      echo "âŒ æ–‡ä»¶éå¤§: $file ($(( SIZE / 1000000 ))MB)"
      echo "è€ƒæ…®ä½¿ç”¨ Git LFS æˆ–æ·»åŠ åˆ° .gitignore"
      exit 1
    fi
  fi
done

echo "âœ… æ–‡ä»¶å¤§å°æª¢æŸ¥é€šé"
```

## CI å±¤é¢çš„æª¢æŸ¥

å³ä½¿æœ¬åœ°ç¹éäº† hookï¼ŒCI ä¹Ÿè¦æœ‰æœ€å¾Œä¸€é“é˜²ç·šã€‚

### GitHub Actions æª¢æŸ¥

```yaml
# .github/workflows/security.yml
name: Security Check

on: [push, pull_request]

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  check-ignored-files:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for sensitive files
        run: |
          SENSITIVE_FILES=$(find . -type f \( \
            -name ".env" \
            -o -name ".env.local" \
            -o -name "*.pem" \
            -o -name "*.key" \
            -o -name "id_rsa" \
          \) 2>/dev/null)
          
          if [ -n "$SENSITIVE_FILES" ]; then
            echo "::error::Found sensitive files in repository:"
            echo "$SENSITIVE_FILES"
            exit 1
          fi
```

## å®Œæ•´ pre-commit é…ç½®

```bash
#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# 1. æ•æ„Ÿæ–‡ä»¶æª¢æŸ¥
echo "Checking for sensitive files..."
bash scripts/check-secrets.sh || exit 1

# 2. å¤§æ–‡ä»¶æª¢æŸ¥
echo "Checking file sizes..."
bash scripts/check-file-size.sh || exit 1

# 3. å¯†é‘°æƒæï¼ˆå¦‚æœå®‰è£äº† gitleaksï¼‰
if command -v gitleaks &> /dev/null; then
  echo "Scanning for secrets..."
  gitleaks protect --staged || exit 1
fi

# 4. ä»£ç¢¼æ ¼å¼åŒ–å’Œ lint
echo "Running lint-staged..."
pnpm exec lint-staged || exit 1

echo "âœ… All pre-commit checks passed!"
```

## é©—æ”¶æ¸…å–®

- [ ] é…ç½®äº†æ•æ„Ÿæ–‡ä»¶çš„ pre-commit æª¢æŸ¥
- [ ] å¯é¸ï¼šé…ç½®äº† gitleaks å¯†é‘°æƒæ
- [ ] å¯é¸ï¼šé…ç½®äº†å¤§æ–‡ä»¶æª¢æŸ¥
- [ ] é…ç½®äº† CI å±¤é¢çš„å®‰å…¨æƒæ
