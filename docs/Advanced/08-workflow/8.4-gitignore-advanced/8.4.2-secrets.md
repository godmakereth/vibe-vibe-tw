---
title: "8.4.2 密碼千萬別提交——敏感文件：`.env*` 忽略；用 `.env.example` 傳達配置"
typora-root-url: ../../public
---

# 8.4.2 密碼千萬別提交——敏感文件管理

一旦密鑰進了 Git 歷史，即使刪除也還在——所以第一步就要攔住。

## 敏感信息類型

| 類型 | 示例 | 風險 |
|------|------|------|
| 數據庫密碼 | DATABASE_URL | 數據泄露 |
| API 密鑰 | OPENAI_API_KEY | 費用損失 |
| 認證密鑰 | JWT_SECRET | 身份僞造 |
| 雲服務憑證 | AWS_SECRET_KEY | 資源被盜用 |
| 私鑰證書 | *.pem, *.key | 安全漏洞 |

## .env 文件忽略策略

### 基本配置

```gitignore
# 忽略所有環境變量文件
.env
.env.local
.env.development.local
.env.test.local
.env.production.local

# 但保留示例文件
!.env.example
!.env.template
```

### Next.js 環境變量規則

```gitignore
# 本地環境變量（不提交）
.env.local
.env.*.local

# 通用環境變量（按需提交）
# .env              # 可能包含默認非敏感值
# .env.development  # 開發環境默認值
# .env.production   # 生產環境默認值
```

## .env.example 模板

創建 `.env.example` 告訴隊友需要哪些配置：

```bash
# 數據庫
DATABASE_URL=postgresql://user:password@localhost:5432/mydb

# 認證
NEXTAUTH_SECRET=your-secret-here
NEXTAUTH_URL=http://localhost:3000

# 第三方服務
OPENAI_API_KEY=sk-xxx
STRIPE_SECRET_KEY=sk_test_xxx

# 可選配置
# REDIS_URL=redis://localhost:6379
```

**原則**：
- 保留變量名和格式
- 用佔位符替代真實值
- 添加簡要註釋說明用途

## 私鑰與證書

```gitignore
# SSL/TLS 證書
*.pem
*.key
*.crt
*.p12
*.pfx

# SSH 密鑰
id_rsa
id_ed25519
*.pub  # 公鑰可能也要保護

# GPG 密鑰
*.gpg
*.asc
```

## Firebase 和雲服務

```gitignore
# Firebase
firebase-adminsdk-*.json
*-firebase-adminsdk-*.json
firebase-config.json

# Google Cloud
service-account.json
*-credentials.json

# AWS
.aws/credentials
```

## 意外提交怎麼辦

### 情況 1：還沒推送

```bash
# 1. 從暫存區移除
git rm --cached .env

# 2. 添加到 .gitignore
echo ".env" >> .gitignore

# 3. 修改上一次提交
git commit --amend
```

### 情況 2：已經推送

```bash
# 1. 立即更換所有泄露的密鑰！

# 2. 使用 git-filter-repo 清理歷史（推薦）
pip install git-filter-repo
git filter-repo --path .env --invert-paths

# 3. 強制推送
git push --force-with-lease

# 4. 通知團隊重新 clone
```

> **重要**：即使從歷史中刪除，也必須更換密鑰！因爲可能已被他人拉取。

### 使用 GitHub Secret Scanning

GitHub 會自動掃描常見的密鑰格式併發出警告：

- AWS 訪問密鑰
- Google API 密鑰
- OpenAI API 密鑰
- Stripe 密鑰
- 等等

## 環境變量管理工具

| 工具 | 特點 | 適用場景 |
|------|------|----------|
| Vercel 環境變量 | 與部署集成 | Vercel 部署項目 |
| GitHub Secrets | CI/CD 使用 | GitHub Actions |
| Doppler | 團隊級管理 | 多環境多項目 |
| 1Password | 密碼管理器 | 個人開發者 |

## AI 協作注意事項

當向 AI 提問時：

**不要**：
```
我的 DATABASE_URL 是 postgresql://admin:MyP@ssw0rd@db.example.com:5432/prod
爲什麼連不上？
```

**應該**：
```
我的 DATABASE_URL 格式是 postgresql://user:password@host:5432/database
連接時報錯 "connection refused"，可能是什麼原因？
```

## 驗收清單

- [ ] 配置了 .env* 的忽略規則
- [ ] 創建了 .env.example 模板
- [ ] 理解私鑰證書的忽略方式
- [ ] 知道意外提交後的處理流程
