---
title: "9.4.3 日誌裏不能泄露密碼——敏感信息脫敏：實施指南與安全設計原則"
typora-root-url: ../../public
---

# 9.4.3 日誌裏不能泄露密碼——敏感信息脫敏：實施指南與安全設計原則

**日誌是安全漏洞的高發區——很多數據泄露都是因爲日誌裏包含了敏感信息。**

## 需要脫敏的數據類型

```mermaid
graph TD
    A[敏感數據] --> B[認證憑證]
    A --> C[個人信息]
    A --> D[金融數據]
    A --> E[業務敏感]
    
    B --> B1[密碼]
    B --> B2[Token]
    B --> B3[API Key]
    
    C --> C1[身份證號]
    C --> C2[手機號]
    C --> C3[郵箱]
    
    D --> D1[銀行卡號]
    D --> D2[CVV]
    
    E --> E1[內部 IP]
    E --> E2[數據庫連接]
```

## Pino 自動脫敏

```typescript
// lib/logger.ts
import pino from 'pino';

export const logger = pino({
  redact: {
    paths: [
      // 認證憑證
      'password',
      'token',
      'accessToken',
      'refreshToken',
      'authorization',
      'apiKey',
      'secret',
      
      // 個人信息
      '*.password',
      '*.idCard',
      '*.bankCard',
      'user.password',
      'req.headers.authorization',
      'req.headers.cookie',
      
      // 嵌套對象
      'data.*.password',
      'users[*].password',
    ],
    censor: '[REDACTED]',
  },
});
```

## 自定義脫敏函數

```typescript
// lib/mask.ts
export const mask = {
  // 手機號：138****8888
  phone: (phone: string): string => {
    if (!phone || phone.length < 7) return phone;
    return phone.slice(0, 3) + '****' + phone.slice(-4);
  },
  
  // 郵箱：t***@example.com
  email: (email: string): string => {
    const [local, domain] = email.split('@');
    if (!domain) return email;
    return local[0] + '***@' + domain;
  },
  
  // 身份證：110***********1234
  idCard: (id: string): string => {
    if (!id || id.length < 8) return id;
    return id.slice(0, 3) + '*'.repeat(id.length - 7) + id.slice(-4);
  },
  
  // 銀行卡：****8888
  bankCard: (card: string): string => {
    if (!card || card.length < 4) return card;
    return '****' + card.slice(-4);
  },
  
  // Token：eyJh...abc (只顯示前後)
  token: (token: string): string => {
    if (!token || token.length < 10) return '[REDACTED]';
    return token.slice(0, 4) + '...' + token.slice(-3);
  },
};
```

## 使用脫敏函數

```typescript
// services/user.service.ts
import { logger } from '@/lib/logger';
import { mask } from '@/lib/mask';

export async function createUser(data: CreateUserInput) {
  logger.info({
    action: 'user.create',
    email: mask.email(data.email),
    phone: mask.phone(data.phone),
  }, '創建用戶');
  
  const user = await prisma.user.create({
    data: {
      email: data.email,
      phone: data.phone,
      password: await hash(data.password),
    },
  });
  
  logger.info({
    action: 'user.created',
    userId: user.id,
    email: mask.email(user.email),
  }, '用戶創建成功');
  
  return user;
}
```

## HTTP 請求脫敏

```typescript
// middleware/logging.ts
import { NextRequest } from 'next/server';
import { logger } from '@/lib/logger';

const sensitiveHeaders = [
  'authorization',
  'cookie',
  'x-api-key',
  'x-auth-token',
];

function sanitizeHeaders(headers: Headers): Record<string, string> {
  const result: Record<string, string> = {};
  
  headers.forEach((value, key) => {
    if (sensitiveHeaders.includes(key.toLowerCase())) {
      result[key] = '[REDACTED]';
    } else {
      result[key] = value;
    }
  });
  
  return result;
}

export function logRequest(request: NextRequest) {
  logger.info({
    method: request.method,
    path: request.nextUrl.pathname,
    headers: sanitizeHeaders(request.headers),
  }, '收到請求');
}
```

## 請求體脫敏

```typescript
// lib/sanitize.ts
const sensitiveFields = [
  'password',
  'confirmPassword',
  'currentPassword',
  'newPassword',
  'token',
  'accessToken',
  'refreshToken',
  'apiKey',
  'secret',
  'creditCard',
  'cvv',
  'ssn',
  'idCard',
];

export function sanitizeBody(body: unknown): unknown {
  if (!body || typeof body !== 'object') {
    return body;
  }
  
  if (Array.isArray(body)) {
    return body.map(sanitizeBody);
  }
  
  const result: Record<string, unknown> = {};
  
  for (const [key, value] of Object.entries(body)) {
    if (sensitiveFields.includes(key)) {
      result[key] = '[REDACTED]';
    } else if (typeof value === 'object' && value !== null) {
      result[key] = sanitizeBody(value);
    } else {
      result[key] = value;
    }
  }
  
  return result;
}
```

## 錯誤堆棧脫敏

```typescript
// lib/error-sanitizer.ts
export function sanitizeError(err: Error): object {
  return {
    name: err.name,
    message: sanitizeMessage(err.message),
    // 不暴露完整堆棧到日誌
    stack: process.env.NODE_ENV === 'development' 
      ? err.stack 
      : undefined,
  };
}

function sanitizeMessage(message: string): string {
  // 移除可能的連接字符串
  return message
    .replace(/postgresql:\/\/[^@]+@[^\s]+/g, 'postgresql://[REDACTED]')
    .replace(/mongodb:\/\/[^@]+@[^\s]+/g, 'mongodb://[REDACTED]')
    .replace(/redis:\/\/[^@]+@[^\s]+/g, 'redis://[REDACTED]');
}
```

## 驗證脫敏效果

```typescript
// __tests__/lib/logger.test.ts
describe('Logger Redaction', () => {
  it('應脫敏密碼字段', () => {
    const output = captureLogOutput(() => {
      logger.info({ password: 'secret123' }, 'test');
    });
    
    expect(output).not.toContain('secret123');
    expect(output).toContain('[REDACTED]');
  });
  
  it('應脫敏嵌套密碼', () => {
    const output = captureLogOutput(() => {
      logger.info({ 
        user: { 
          email: 'test@example.com',
          password: 'secret123',
        },
      }, 'test');
    });
    
    expect(output).not.toContain('secret123');
    expect(output).toContain('test@example.com');
  });
});
```

## 安全檢查清單

| 檢查項 | 描述 |
|--------|------|
| ✅ 密碼字段已脫敏 | password、secret、apiKey 等 |
| ✅ Token 已脫敏 | JWT、OAuth Token、Session ID |
| ✅ 個人信息已脫敏 | 身份證、手機號、銀行卡 |
| ✅ 請求頭已過濾 | Authorization、Cookie |
| ✅ 連接字符串已移除 | 數據庫 URL、Redis URL |
| ✅ 錯誤堆棧已處理 | 生產環境不暴露完整堆棧 |

## 本節小結

敏感信息脫敏是安全的基本要求。使用 Pino 的 redact 配置自動脫敏常見字段，對個人信息使用自定義脫敏函數保留可識別性。定期審查日誌輸出，確保沒有敏感信息泄露。
