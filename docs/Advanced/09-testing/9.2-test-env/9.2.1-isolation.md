---
title: "9.2.1 測試不能影響生產——測試環境配置：獨立的數據庫與服務"
typora-root-url: ../../public
---

# 9.2.1 測試不能影響生產——測試環境配置：獨立的數據庫與服務

**測試環境與生產環境的隔離程度，決定了你的數據安全底線。**

## 隔離策略對比

```mermaid
graph LR
    subgraph 方案一：獨立數據庫
        A1[測試] --> DB1[(myapp_test)]
        A2[開發] --> DB2[(myapp_dev)]
        A3[生產] --> DB3[(myapp_prod)]
    end
    
    subgraph 方案二：獨立 Schema
        B1[測試] --> S1[test schema]
        B2[生產] --> S2[public schema]
        S1 --> DB4[(同一數據庫)]
        S2 --> DB4
    end
    
    subgraph 方案三：Docker 容器
        C1[測試] --> D1[容器 DB]
        C2[生產] --> D2[雲數據庫]
    end
```

| 方案 | 隔離程度 | 成本 | 推薦場景 |
|------|---------|------|---------|
| 獨立數據庫 | 高 | 中 | 團隊開發 |
| 獨立 Schema | 中 | 低 | 個人開發 |
| Docker 容器 | 最高 | 低 | CI/CD |

## 方案一：獨立數據庫（推薦）

### PostgreSQL 配置

```sql
-- 創建測試數據庫
CREATE DATABASE myapp_test;

-- 創建測試用戶（可選，更安全）
CREATE USER test_user WITH PASSWORD 'test_password';
GRANT ALL PRIVILEGES ON DATABASE myapp_test TO test_user;
```

### Prisma 配置

```prisma
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

```bash
# .env.test
DATABASE_URL="postgresql://test_user:test_password@localhost:5432/myapp_test"

# .env.development
DATABASE_URL="postgresql://dev_user:dev_password@localhost:5432/myapp_dev"

# .env.production
DATABASE_URL="postgresql://prod_user:prod_password@prod-host:5432/myapp_prod"
```

## 方案二：Docker 容器（CI/CD 首選）

使用 Docker Compose 爲測試創建臨時數據庫：

```yaml
# docker-compose.test.yml
version: '3.8'
services:
  test-db:
    image: postgres:15-alpine
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: myapp_test
    ports:
      - "5433:5432"
    tmpfs:
      - /var/lib/postgresql/data
```

```bash
# 啓動測試數據庫
docker-compose -f docker-compose.test.yml up -d

# 運行測試
DATABASE_URL="postgresql://test:test@localhost:5433/myapp_test" npm test

# 銷燬測試數據庫
docker-compose -f docker-compose.test.yml down
```

### 使用 tmpfs 加速測試

`tmpfs` 將數據存儲在內存中，顯著提升測試速度：

```yaml
services:
  test-db:
    # ...
    tmpfs:
      - /var/lib/postgresql/data  # 數據存內存，容器銷燬即清除
```

## 方案三：使用 Supabase 本地實例

```bash
# 安裝 Supabase CLI
npm install -g supabase

# 初始化本地 Supabase
supabase init

# 啓動本地實例（包含獨立的 PostgreSQL）
supabase start

# 獲取連接信息
supabase status
```

```bash
# .env.test
DATABASE_URL="postgresql://postgres:postgres@localhost:54322/postgres"
```

## 隔離外部服務

除了數據庫，還需要隔離其他外部服務：

```typescript
// lib/config.ts
export const config = {
  // 數據庫
  databaseUrl: process.env.DATABASE_URL!,
  
  // 外部 API
  stripeKey: process.env.STRIPE_KEY!,
  sendgridKey: process.env.SENDGRID_KEY!,
  
  // 判斷是否測試環境
  isTest: process.env.NODE_ENV === 'test',
};

// 測試環境使用 Mock
export function getStripe() {
  if (config.isTest) {
    return createMockStripe();
  }
  return new Stripe(config.stripeKey);
}
```

```bash
# .env.test
NODE_ENV=test
STRIPE_KEY=sk_test_xxx  # 使用測試模式的 Key
SENDGRID_KEY=           # 留空，測試中不發郵件
```

## 驗證隔離有效性

```typescript
// test/setup.ts
beforeAll(() => {
  // 安全檢查：確保不在生產環境運行測試
  if (process.env.NODE_ENV === 'production') {
    throw new Error('不能在生產環境運行測試！');
  }
  
  // 檢查數據庫 URL 是否包含 "_test"
  const dbUrl = process.env.DATABASE_URL || '';
  if (!dbUrl.includes('_test') && !dbUrl.includes('localhost')) {
    throw new Error('測試數據庫配置錯誤：URL 應包含 _test 或指向 localhost');
  }
});
```

## 常見錯誤及解決方案

| 錯誤 | 原因 | 解決方案 |
|------|------|---------|
| 測試影響生產數據 | 環境變量配置錯誤 | 添加安全檢查 |
| 測試運行緩慢 | 使用遠程數據庫 | 改用本地/Docker |
| 並行測試衝突 | 共享同一數據庫 | 使用事務回滾 |
| CI 測試失敗 | 缺少數據庫服務 | 配置 Docker 服務 |

## AI 協作指南

配置測試環境時，可以這樣與 AI 溝通：

> **核心意圖**：配置獨立的測試環境
>
> **需求定義公式**：
> ```
> 幫我配置測試環境：
> - 數據庫類型：[PostgreSQL/MySQL/SQLite]
> - 隔離方式：[獨立數據庫/Docker/Schema]
> - 需要隔離的服務：[Stripe/SendGrid/...]
> ```

**關鍵術語**：`DATABASE_URL`、`docker-compose`、`tmpfs`、`環境隔離`

## 本節小結

測試環境隔離的核心是**確保測試永遠不會觸及生產數據**。推薦使用獨立數據庫配合 Docker 的方案，既保證了隔離性，又兼顧了開發效率。記住：在測試代碼中添加安全檢查，是防止誤操作的最後一道防線。
