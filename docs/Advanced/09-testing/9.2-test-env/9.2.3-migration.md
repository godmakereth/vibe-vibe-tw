---
title: "9.2.3 æ¸¬è©¦å‰åˆå§‹åŒ–æ•¸æ“šåº«â€”â€”æ•¸æ“šåº«é·ç§»ï¼šæ¸¬è©¦æ•¸æ“šåº«çš„åˆå§‹åŒ–"
typora-root-url: ../../public
---

# 9.2.3 æ¸¬è©¦å‰åˆå§‹åŒ–æ•¸æ“šåº«â€”â€”æ•¸æ“šåº«é·ç§»ï¼šæ¸¬è©¦æ•¸æ“šåº«çš„åˆå§‹åŒ–

**æ¸¬è©¦æ•¸æ“šåº«çš„è¡¨çµæ§‹å¿…é ˆèˆ‡é–‹ç™¼/ç”Ÿç”¢ä¿æŒä¸€è‡´ï¼Œé·ç§»æ˜¯ä¿è­‰é€™ä¸€é»çš„é—œéµã€‚**

## æ¸¬è©¦æ•¸æ“šåº«åˆå§‹åŒ–æµç¨‹

```mermaid
graph LR
    A[å‰µå»ºæ¸¬è©¦æ•¸æ“šåº«] --> B[é‹è¡Œé·ç§»]
    B --> C[ç”Ÿæˆ Prisma Client]
    C --> D[åŸ·è¡Œæ¸¬è©¦]
    D --> E[æ¸…ç†æ•¸æ“š]
    E --> F{é‚„æœ‰æ¸¬è©¦?}
    F -->|æ˜¯| D
    F -->|å¦| G[çµæŸ]
```

## ä½¿ç”¨ Prisma ç®¡ç†æ¸¬è©¦æ•¸æ“šåº«é·ç§»

### æ–¹æ³•ä¸€ï¼šmigrate deployï¼ˆæ¨è–¦ç”¨æ–¼ CIï¼‰

```bash
# éƒ¨ç½²å·²æœ‰çš„é·ç§»åˆ°æ¸¬è©¦æ•¸æ“šåº«
dotenv -e .env.test -- npx prisma migrate deploy
```

```json
// package.json
{
  "scripts": {
    "test:setup": "dotenv -e .env.test -- prisma migrate deploy",
    "test": "npm run test:setup && dotenv -e .env.test -- jest",
    "test:ci": "npm run test:setup && dotenv -e .env.test -- jest --ci"
  }
}
```

### æ–¹æ³•äºŒï¼šmigrate resetï¼ˆé–‹ç™¼æ™‚ä½¿ç”¨ï¼‰

```bash
# é‡ç½®æ•¸æ“šåº«ä¸¦é‡æ–°é‹è¡Œæ‰€æœ‰é·ç§»
dotenv -e .env.test -- npx prisma migrate reset --force
```

```json
// package.json
{
  "scripts": {
    "test:reset": "dotenv -e .env.test -- prisma migrate reset --force",
    "test:fresh": "npm run test:reset && dotenv -e .env.test -- jest"
  }
}
```

### æ–¹æ³•ä¸‰ï¼šdb pushï¼ˆå¿«é€ŸåŸå‹ï¼‰

```bash
# ç›´æ¥æ¨é€ schema è®Šæ›´ï¼ˆä¸ç”Ÿæˆé·ç§»æ–‡ä»¶ï¼‰
dotenv -e .env.test -- npx prisma db push
```

## è‡ªå‹•åŒ–æ¸¬è©¦æ•¸æ“šåº«åˆå§‹åŒ–

```typescript
// test/setup-db.ts
import { execSync } from 'child_process';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

export async function setupTestDatabase() {
  console.log('ğŸ”§ Setting up test database...');
  
  try {
    // é‹è¡Œé·ç§»
    execSync('npx prisma migrate deploy', {
      env: { ...process.env, DATABASE_URL: process.env.DATABASE_URL },
      stdio: 'inherit',
    });
    
    // é©—è­‰é€£æ¥
    await prisma.$connect();
    console.log('âœ… Test database ready');
  } catch (error) {
    console.error('âŒ Failed to setup test database:', error);
    throw error;
  }
}

export async function teardownTestDatabase() {
  await prisma.$disconnect();
}
```

```typescript
// jest.setup.ts
import { setupTestDatabase, teardownTestDatabase } from './test/setup-db';

beforeAll(async () => {
  await setupTestDatabase();
});

afterAll(async () => {
  await teardownTestDatabase();
});
```

## Jest å…¨å±€é…ç½®

```typescript
// jest.config.ts
import type { Config } from 'jest';

const config: Config = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.ts'],
  globalSetup: '<rootDir>/test/global-setup.ts',
  globalTeardown: '<rootDir>/test/global-teardown.ts',
  testTimeout: 30000, // é·ç§»å¯èƒ½éœ€è¦è¼ƒé•·æ™‚é–“
};

export default config;
```

```typescript
// test/global-setup.ts
import { execSync } from 'child_process';

export default async function globalSetup() {
  console.log('\nğŸš€ Global test setup...');
  
  // ç¢ºä¿æ¸¬è©¦æ•¸æ“šåº«çµæ§‹æ˜¯æœ€æ–°çš„
  execSync('dotenv -e .env.test -- npx prisma migrate deploy', {
    stdio: 'inherit',
  });
  
  // ç”Ÿæˆ Prisma Client
  execSync('npx prisma generate', { stdio: 'inherit' });
}
```

```typescript
// test/global-teardown.ts
export default async function globalTeardown() {
  console.log('\nğŸ§¹ Global test teardown...');
  // å¯é¸ï¼šæ¸…ç†æ¸¬è©¦æ•¸æ“šåº«
}
```

## è™•ç†é·ç§»è¡çª

### å ´æ™¯ï¼šæœ¬åœ°é·ç§»èˆ‡é ç¨‹ä¸ä¸€è‡´

```bash
# æŸ¥çœ‹é·ç§»ç‹€æ…‹
dotenv -e .env.test -- npx prisma migrate status

# å¦‚æœæœ‰å•é¡Œï¼Œé‡ç½®æ¸¬è©¦æ•¸æ“šåº«
dotenv -e .env.test -- npx prisma migrate reset --force
```

### å ´æ™¯ï¼šCI ä¸­é·ç§»å¤±æ•—

```yaml
# .github/workflows/test.yml
jobs:
  test:
    steps:
      - name: Setup Database
        run: |
          # ç­‰å¾…æ•¸æ“šåº«å°±ç·’
          sleep 5
          # é‹è¡Œé·ç§»
          npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}
```

## ä½¿ç”¨ Docker å¯¦ç¾ä¸€æ¬¡æ€§æ•¸æ“šåº«

```typescript
// test/docker-db.ts
import { execSync } from 'child_process';
import { v4 as uuid } from 'uuid';

export function createTestDatabase() {
  const dbName = `test_${uuid().replace(/-/g, '_')}`;
  
  execSync(`docker run -d --name ${dbName} \
    -e POSTGRES_DB=${dbName} \
    -e POSTGRES_USER=test \
    -e POSTGRES_PASSWORD=test \
    -p 0:5432 \
    postgres:15-alpine`);
  
  // ç²å–æ˜ å°„çš„ç«¯å£
  const port = execSync(`docker port ${dbName} 5432`).toString().split(':')[1].trim();
  
  return {
    url: `postgresql://test:test@localhost:${port}/${dbName}`,
    cleanup: () => execSync(`docker rm -f ${dbName}`),
  };
}
```

## é·ç§»ç­–ç•¥å°æ¯”

| ç­–ç•¥ | é©ç”¨å ´æ™¯ | å„ªé» | ç¼ºé» |
|------|---------|------|------|
| migrate deploy | CI/CD | å¿«é€Ÿã€å¯é  | éœ€è¦å·²æœ‰é·ç§» |
| migrate reset | é–‹ç™¼æ¸¬è©¦ | å®Œå…¨é‡ç½® | è¼ƒæ…¢ |
| db push | å¿«é€ŸåŸå‹ | æœ€å¿« | å¯èƒ½ä¸Ÿå¤±æ•¸æ“š |
| Docker ä¸€æ¬¡æ€§ | ä¸¦è¡Œæ¸¬è©¦ | å®Œå…¨éš”é›¢ | å•“å‹•è¼ƒæ…¢ |

## å¸¸è¦‹å•é¡Œ

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|------|------|---------|
| é·ç§»è¶…æ™‚ | æ•¸æ“šåº«é€£æ¥æ…¢ | å¢åŠ è¶…æ™‚æ™‚é–“ |
| è¡¨ä¸å­˜åœ¨ | é·ç§»æœªé‹è¡Œ | æª¢æŸ¥ migrate deploy |
| é¡å‹ä¸åŒ¹é… | Client æœªæ›´æ–° | é‹è¡Œ prisma generate |
| ä¸¦è¡Œè¡çª | å…±äº«æ•¸æ“šåº« | ä½¿ç”¨äº‹å‹™æˆ– Docker |

## æœ¬ç¯€å°çµ

æ¸¬è©¦æ•¸æ“šåº«é·ç§»çš„æ ¸å¿ƒç›®æ¨™æ˜¯**ç¢ºä¿æ¸¬è©¦ç’°å¢ƒçš„è¡¨çµæ§‹èˆ‡ç”Ÿç”¢ä¸€è‡´**ã€‚æ¨è–¦åœ¨ CI ä¸­ä½¿ç”¨ `migrate deploy`ï¼Œåœ¨æœ¬åœ°é–‹ç™¼æ™‚ä½¿ç”¨ `migrate reset`ã€‚é€šé Jest çš„å…¨å±€é…ç½®ï¼Œå¯ä»¥åœ¨æ¸¬è©¦é‹è¡Œå‰è‡ªå‹•å®Œæˆé·ç§»ï¼Œè®“æ¸¬è©¦å°ˆæ³¨æ–¼æ¥­å‹™é‚è¼¯é©—è­‰ã€‚
