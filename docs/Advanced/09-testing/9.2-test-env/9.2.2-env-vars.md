---
title: "9.2.2 測試專用的配置——環境變量：測試專用配置管理"
typora-root-url: ../../public
---

# 9.2.2 測試專用的配置——環境變量：測試專用配置管理

**環境變量是連接代碼與環境的橋樑，管理好它們是測試成功的基礎。**

## 環境變量文件層級

```
project/
├── .env                  # 默認配置（被其他覆蓋）
├── .env.local            # 本地開發配置（不提交 git）
├── .env.development      # 開發環境配置
├── .env.test             # 測試環境配置
├── .env.production       # 生產環境配置
└── .env.example          # 配置模板（提交 git）
```

### 加載優先級

```mermaid
graph LR
    A[.env] --> B[.env.local]
    B --> C[.env.development/.env.test/.env.production]
    C --> D[進程環境變量]
    
    D -->|覆蓋| C
    C -->|覆蓋| B
    B -->|覆蓋| A
```

## .env.test 標準配置

```bash
# .env.test

# 環境標識
NODE_ENV=test

# 數據庫（必須使用測試數據庫）
DATABASE_URL="postgresql://test:test@localhost:5432/myapp_test"

# 認證（使用固定的測試密鑰）
JWT_SECRET="test-jwt-secret-do-not-use-in-production"
NEXTAUTH_SECRET="test-nextauth-secret"
NEXTAUTH_URL="http://localhost:3000"

# 外部服務（使用測試模式或 Mock）
STRIPE_SECRET_KEY="sk_test_..."
STRIPE_WEBHOOK_SECRET="whsec_test_..."

# 郵件服務（禁用或使用測試服務）
SMTP_HOST=""
SMTP_PORT=""

# 日誌級別（測試時可以調高）
LOG_LEVEL="error"

# 測試專用配置
TEST_USER_EMAIL="test@example.com"
TEST_USER_PASSWORD="TestPassword123!"
```

## 使用 dotenv-cli 加載測試配置

```bash
# 安裝 dotenv-cli
npm install -D dotenv-cli
```

```json
// package.json
{
  "scripts": {
    "test": "dotenv -e .env.test -- jest",
    "test:watch": "dotenv -e .env.test -- jest --watch",
    "test:coverage": "dotenv -e .env.test -- jest --coverage",
    "test:ci": "dotenv -e .env.test -- jest --ci --runInBand"
  }
}
```

## 在測試中訪問環境變量

```typescript
// lib/env.ts
import { z } from 'zod';

const envSchema = z.object({
  NODE_ENV: z.enum(['development', 'test', 'production']),
  DATABASE_URL: z.string().url(),
  JWT_SECRET: z.string().min(32),
  // 測試環境可選的配置
  STRIPE_SECRET_KEY: z.string().optional(),
});

export const env = envSchema.parse(process.env);

// 便捷判斷
export const isTest = env.NODE_ENV === 'test';
export const isProd = env.NODE_ENV === 'production';
```

```typescript
// __tests__/example.test.ts
import { env, isTest } from '@/lib/env';

describe('環境配置', () => {
  it('應處於測試環境', () => {
    expect(isTest).toBe(true);
    expect(env.NODE_ENV).toBe('test');
  });

  it('應使用測試數據庫', () => {
    expect(env.DATABASE_URL).toContain('_test');
  });
});
```

## 敏感配置的處理

### 不應該在 .env.test 中出現的內容

```bash
# .env.test

# ❌ 錯誤：不要使用真實的生產密鑰
STRIPE_SECRET_KEY="sk_live_xxx"

# ✅ 正確：使用測試模式密鑰
STRIPE_SECRET_KEY="sk_test_xxx"

# ❌ 錯誤：不要使用真實的生產數據庫
DATABASE_URL="postgresql://user:pass@prod-server/myapp"

# ✅ 正確：使用本地測試數據庫
DATABASE_URL="postgresql://test:test@localhost/myapp_test"
```

### .gitignore 配置

```bash
# .gitignore

# 所有本地環境文件
.env.local
.env.*.local

# 測試環境文件（如果包含敏感信息）
# .env.test

# 但要保留示例文件
!.env.example
```

## 環境變量驗證

```typescript
// test/setup.ts
import { z } from 'zod';

const testEnvSchema = z.object({
  NODE_ENV: z.literal('test'),
  DATABASE_URL: z.string().refine(
    (url) => url.includes('_test') || url.includes('localhost'),
    { message: '測試必須使用測試數據庫' }
  ),
});

beforeAll(() => {
  const result = testEnvSchema.safeParse(process.env);
  
  if (!result.success) {
    console.error('環境變量驗證失敗:', result.error.format());
    throw new Error('測試環境配置錯誤');
  }
});
```

## 動態配置切換

```typescript
// lib/config.ts
type Environment = 'development' | 'test' | 'production';

interface Config {
  apiBaseUrl: string;
  enableLogging: boolean;
  mockExternalServices: boolean;
}

const configs: Record<Environment, Config> = {
  development: {
    apiBaseUrl: 'http://localhost:3000',
    enableLogging: true,
    mockExternalServices: false,
  },
  test: {
    apiBaseUrl: 'http://localhost:3000',
    enableLogging: false,
    mockExternalServices: true, // 測試時 Mock 外部服務
  },
  production: {
    apiBaseUrl: 'https://api.example.com',
    enableLogging: true,
    mockExternalServices: false,
  },
};

export const config = configs[process.env.NODE_ENV as Environment] || configs.development;
```

## CI/CD 中的環境變量

```yaml
# .github/workflows/test.yml
name: Test
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      NODE_ENV: test
      DATABASE_URL: postgresql://test:test@localhost:5432/myapp_test
      JWT_SECRET: ${{ secrets.TEST_JWT_SECRET }}
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: myapp_test
        ports:
          - 5432:5432
    
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
      - run: npm ci
      - run: npm run test:ci
```

## 常見問題解決

| 問題 | 原因 | 解決方案 |
|------|------|---------|
| 環境變量未加載 | dotenv-cli 未安裝 | `npm i -D dotenv-cli` |
| 使用了生產配置 | 文件優先級問題 | 檢查 .env.local |
| CI 中變量爲空 | secrets 未配置 | 在 GitHub 設置中添加 |
| 類型錯誤 | 環境變量都是字符串 | 使用 zod 轉換 |

## 本節小結

測試環境變量管理的核心原則是：**隔離、驗證、安全**。使用 `.env.test` 隔離測試配置，使用 zod 驗證環境變量正確性，避免在測試配置中暴露敏感信息。配合 dotenv-cli，可以輕鬆在不同環境間切換。
