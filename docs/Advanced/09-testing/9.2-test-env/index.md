---
title: "9.2 在沙盒裏跑測試——測試環境與隔離：`.env.test`、遷移、數據清理"
typora-root-url: ../../public
---

# 9.2 在沙盒裏跑測試——測試環境與隔離：`.env.test`、遷移、數據清理

**測試環境的核心原則：與生產完全隔離，每次測試都從乾淨狀態開始。**

## 爲什麼需要獨立的測試環境

```mermaid
graph TB
    subgraph 錯誤做法
        TEST1[測試代碼] --> PROD_DB[(生產數據庫)]
        PROD_DB --> DISASTER[數據被污染/刪除]
    end
    
    subgraph 正確做法
        TEST2[測試代碼] --> TEST_DB[(測試數據庫)]
        PROD[生產代碼] --> PROD_DB2[(生產數據庫)]
    end
    
    style DISASTER fill:#ff6b6b
    style TEST_DB fill:#6bcb77
```

測試環境隔離的必要性：

| 風險 | 後果 | 解決方案 |
|------|------|---------|
| 測試數據寫入生產庫 | 用戶看到測試數據 | 獨立數據庫 |
| 測試清理生產數據 | 數據丟失 | 環境變量隔離 |
| 測試影響生產性能 | 服務變慢 | 獨立服務實例 |
| 並行測試數據衝突 | 測試不穩定 | 事務回滾 |

## 測試環境架構

```
┌─────────────────────────────────────────────────────┐
│                  測試環境架構                         │
├─────────────────────────────────────────────────────┤
│                                                     │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐      │
│  │ .env.test │    │ test DB  │    │ mock API │      │
│  └─────┬────┘    └─────┬────┘    └─────┬────┘      │
│        │               │               │           │
│        └───────────────┼───────────────┘           │
│                        │                           │
│                 ┌──────▼──────┐                    │
│                 │  測試運行器   │                    │
│                 │    Jest     │                    │
│                 └─────────────┘                    │
│                                                     │
└─────────────────────────────────────────────────────┘
```

## 本節核心內容

| 小節 | 主題 | 解決的問題 |
|------|------|-----------|
| 9.2.1 | 環境隔離 | 如何配置獨立的測試數據庫和服務 |
| 9.2.2 | 環境變量 | 如何管理測試專用配置 |
| 9.2.3 | 數據庫遷移 | 如何初始化測試數據庫結構 |
| 9.2.4 | 數據清理 | 如何確保測試間的狀態隔離 |

## 快速入門：最小測試環境配置

```bash
# 1. 創建測試環境配置文件
touch .env.test

# 2. 配置測試數據庫連接
echo 'DATABASE_URL="postgresql://user:pass@localhost:5432/myapp_test"' >> .env.test

# 3. 在 package.json 中添加測試腳本
```

```json
{
  "scripts": {
    "test": "dotenv -e .env.test -- jest",
    "test:setup": "dotenv -e .env.test -- prisma migrate deploy",
    "test:reset": "dotenv -e .env.test -- prisma migrate reset --force"
  }
}
```

## 本節小結

測試環境隔離是質量保障的基礎設施。通過獨立的數據庫、專用的環境變量、自動化的遷移和清理機制，可以確保每次測試都在可控、可重複的環境中運行。接下來的小節將詳細介紹每個環節的具體實現。
