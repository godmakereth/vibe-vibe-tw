---
title: "2.3.3 提交表單的最佳方式——Server Actions 最佳實踐：表單處理與錯誤邊界"
typora-root-url: ../../public
---

# 2.3.3 Server Actions 最佳實踐

## 一句話破題

Server Actions 讓你可以直接在客戶端調用服務器函數，無需手動創建 API 路由——但要用好它，需要掌握表單處理、錯誤處理和樂觀更新的最佳實踐。

## 基礎用法

### 定義 Server Action

```typescript
// app/actions.ts
'use server'

export async function createPost(formData: FormData) {
  const title = formData.get('title') as string
  const content = formData.get('content') as string
  
  await db.post.create({
    data: { title, content }
  })
  
  revalidatePath('/posts')
}
```

### 在表單中使用

```typescript
// app/posts/new/page.tsx
import { createPost } from '@/app/actions'

export default function NewPostPage() {
  return (
    <form action={createPost}>
      <input name="title" required />
      <textarea name="content" required />
      <button type="submit">發佈</button>
    </form>
  )
}
```

## 表單驗證

### 使用 Zod 驗證

```typescript
// app/actions.ts
'use server'

import { z } from 'zod'

const PostSchema = z.object({
  title: z.string().min(1, '標題不能爲空').max(100),
  content: z.string().min(10, '內容至少 10 個字符'),
})

export async function createPost(formData: FormData) {
  const validatedFields = PostSchema.safeParse({
    title: formData.get('title'),
    content: formData.get('content'),
  })
  
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
    }
  }
  
  await db.post.create({ data: validatedFields.data })
  revalidatePath('/posts')
  redirect('/posts')
}
```

### 顯示驗證錯誤

```typescript
// components/post-form.tsx
'use client'

import { useFormState } from 'react-dom'
import { createPost } from '@/app/actions'

export function PostForm() {
  const [state, formAction] = useFormState(createPost, { errors: {} })
  
  return (
    <form action={formAction}>
      <div>
        <input name="title" />
        {state.errors?.title && (
          <p className="text-red-500">{state.errors.title}</p>
        )}
      </div>
      <div>
        <textarea name="content" />
        {state.errors?.content && (
          <p className="text-red-500">{state.errors.content}</p>
        )}
      </div>
      <SubmitButton />
    </form>
  )
}
```

## 提交狀態處理

```typescript
// components/submit-button.tsx
'use client'

import { useFormStatus } from 'react-dom'

export function SubmitButton() {
  const { pending } = useFormStatus()
  
  return (
    <button type="submit" disabled={pending}>
      {pending ? '提交中...' : '提交'}
    </button>
  )
}
```

## 樂觀更新

```typescript
// components/like-button.tsx
'use client'

import { useOptimistic } from 'react'
import { likePost } from '@/app/actions'

export function LikeButton({ postId, likes }: { postId: string; likes: number }) {
  const [optimisticLikes, addOptimisticLike] = useOptimistic(
    likes,
    (state, _) => state + 1
  )
  
  async function handleLike() {
    addOptimisticLike(null)  // 立即更新 UI
    await likePost(postId)    // 實際請求
  }
  
  return (
    <form action={handleLike}>
      <button type="submit">
        ❤️ {optimisticLikes}
      </button>
    </form>
  )
}
```

## 錯誤處理

### Server Action 中拋出錯誤

```typescript
// app/actions.ts
'use server'

export async function deletePost(postId: string) {
  const post = await db.post.findUnique({ where: { id: postId } })
  
  if (!post) {
    throw new Error('文章不存在')
  }
  
  if (post.authorId !== getCurrentUserId()) {
    throw new Error('無權刪除此文章')
  }
  
  await db.post.delete({ where: { id: postId } })
  revalidatePath('/posts')
}
```

### error.tsx 捕獲錯誤

```typescript
// app/posts/error.tsx
'use client'

export default function Error({
  error,
  reset,
}: {
  error: Error
  reset: () => void
}) {
  return (
    <div>
      <h2>出錯了：{error.message}</h2>
      <button onClick={reset}>重試</button>
    </div>
  )
}
```

## Server Actions vs API Routes

| 場景 | 推薦方案 |
|------|----------|
| 表單提交 | Server Actions |
| 數據變更 | Server Actions |
| 第三方調用 | API Routes |
| Webhook | API Routes |
| 複雜查詢 | Server Actions |

## 覺知：常見問題

### 1. 忘記 `'use server'`

```typescript
// ❌ 沒有 'use server'，不是 Server Action
export async function createPost(formData) {
  // 這會在客戶端執行！
}

// ✅ 添加 'use server'
'use server'
export async function createPost(formData) {
  // 在服務器執行
}
```

### 2. 敏感操作不驗證

```typescript
// ❌ 沒有權限檢查
export async function deletePost(id) {
  await db.post.delete({ where: { id } })
}

// ✅ 添加權限檢查
export async function deletePost(id) {
  const user = await getCurrentUser()
  const post = await db.post.findUnique({ where: { id } })
  
  if (post.authorId !== user.id) {
    throw new Error('無權操作')
  }
  
  await db.post.delete({ where: { id } })
}
```

## 本節小結

| 最佳實踐 | 說明 |
|----------|------|
| Zod 驗證 | 始終驗證輸入數據 |
| useFormState | 處理表單狀態和錯誤 |
| useFormStatus | 顯示提交狀態 |
| useOptimistic | 樂觀更新提升體驗 |
| 權限檢查 | 敏感操作必須驗證 |
