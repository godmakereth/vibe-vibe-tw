---
title: "12.6.3 網站如何防爬蟲——反爬蟲機制：驗證碼/IP 限制/User-Agent"
typora-root-url: ../../public
---

# 12.6.3 網站如何防爬蟲——反爬蟲機制：驗證碼/IP 限制/User-Agent

### 一句話破題

瞭解反爬機制不是爲了繞過它們，而是爲了理解爲什麼你的爬蟲會失敗，以及如何設計不會觸發這些機制的爬蟲。

### 常見反爬機制

| 機制 | 原理 | 觸發條件 |
|------|------|----------|
| User-Agent 檢查 | 檢查請求頭識別爬蟲 | 使用默認或可疑的 UA |
| IP 頻率限制 | 限制單 IP 請求數 | 短時間大量請求 |
| 驗證碼 | 要求人工驗證 | 異常行爲或頻繁請求 |
| JavaScript 渲染 | 內容由 JS 動態生成 | 無法執行 JS |
| Cookie/Session | 需要登錄或有效會話 | 缺少必要的 Cookie |
| 蜜罐鏈接 | 隱藏的陷阱鏈接 | 爬蟲訪問了人不會看到的鏈接 |

### 設置合理的請求頭

```typescript
const headers = {
  'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
  'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
  'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
  'Accept-Encoding': 'gzip, deflate, br',
  'Connection': 'keep-alive',
  'Upgrade-Insecure-Requests': '1',
};

async function fetchAsHuman(url: string) {
  return fetch(url, { headers });
}
```

### 處理 JavaScript 渲染

很多現代網站使用 JavaScript 動態渲染內容：

```typescript
// 使用 Playwright 處理 JS 渲染
import { chromium } from 'playwright';

async function fetchRenderedPage(url: string) {
  const browser = await chromium.launch();
  const page = await browser.newPage();
  
  await page.goto(url, { waitUntil: 'networkidle' });
  const content = await page.content();
  
  await browser.close();
  return content;
}
```

### 處理 Cookie 和 Session

```typescript
import { CookieJar } from 'tough-cookie';

const jar = new CookieJar();

async function fetchWithCookies(url: string) {
  const cookies = await jar.getCookieString(url);
  
  const response = await fetch(url, {
    headers: { Cookie: cookies },
  });
  
  // 保存新的 Cookie
  const setCookie = response.headers.get('Set-Cookie');
  if (setCookie) {
    await jar.setCookie(setCookie, url);
  }
  
  return response;
}
```

### 檢測自己是否被封

```typescript
async function checkIfBlocked(url: string): Promise<boolean> {
  try {
    const response = await fetch(url);
    
    // 常見的封禁標誌
    if (response.status === 403) return true;
    if (response.status === 429) return true;
    
    const text = await response.text();
    
    // 檢查常見的封禁頁面關鍵詞
    const blockKeywords = [
      'access denied',
      'blocked',
      'captcha',
      'verify you are human',
      'unusual traffic',
    ];
    
    return blockKeywords.some(keyword => 
      text.toLowerCase().includes(keyword)
    );
  } catch {
    return true;
  }
}
```

### AI 協作指南

- **核心意圖**：讓 AI 幫你理解反爬機制，而非繞過它們。
- **需求定義公式**：`"請解釋這個網站可能使用了哪些反爬機制，以及我如何調整爬蟲行爲來避免觸發它們。"`
- **關鍵術語**：`User-Agent`、`IP 封禁`、`驗證碼 (CAPTCHA)`、`JavaScript 渲染`

### 避坑指南

- **不要試圖繞過反爬**：這可能違法，也會損害你和目標網站的關係。
- **被封后冷靜下來**：暫停爬取，檢查你的行爲是否過於激進。
- **考慮使用官方 API**：如果網站有 API，優先使用 API。
