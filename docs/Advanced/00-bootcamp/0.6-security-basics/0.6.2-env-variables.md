---
title: "0.6.2 你的密碼放對地方了嗎——環境變量與密鑰管理：安全存儲的最佳實踐"
typora-root-url: ../../public
---

# 0.6.2 你的密碼放對地方了嗎——環境變量與密鑰管理：安全存儲的最佳實踐

## 一句話破題

密鑰不進代碼庫，不進日誌。**環境變量 + 密鑰管理服務 + 輪換機制**，是基礎中的基礎。

## .env 文件層級

- `.env.local`：本地私有，開發者機器的機密配置；不提交版本庫。
- `.env.development`：團隊共享的開發環境變量（不含密鑰）。
- `.env.production`：生產環境變量（不含明文密鑰）；密鑰由密鑰管理服務注入。

```mermaid
flowchart LR
    subgraph sgenv ["環境變量層級"]
        LocalEnv[.env.local(私有)] --> DevEnv[.env.development(共享)];
        DevEnv --> ProdEnv[.env.production(生產)];
        ProdEnv --> SecretMgr[密鑰管理服務注入];
    end
```

## 密鑰管理與 .gitignore

- `.gitignore` 示例：

```
.env*
.env.local
.env.production.local
```

- 禁止將 API Key、數據庫連接串等明文放入代碼或日誌。
- 生產環境使用雲密鑰服務：AWS Secrets Manager、Azure Key Vault、GCP Secret Manager。

## Windows PowerShell 操作

- 查看：`Get-ChildItem Env:`
- 會話設置：`$env:DB_URL = 'postgres://user:pass@host:5432/db'`
- 持久化：`setx DB_URL "postgres://user:pass@host:5432/db"`

## TypeScript 安全讀取示例

```ts
type EnvVars = {
  NODE_ENV: 'development' | 'production' | 'test'
  API_BASE: string
  DB_URL: string
}

const required: ReadonlyArray<keyof EnvVars> = ['NODE_ENV', 'API_BASE', 'DB_URL']

function readEnv(): EnvVars {
  const missing: string[] = []
  const env = process.env
  required.forEach((k) => {
    if (!env[k]) {
      missing.push(k)
    }
  })
  if (missing.length > 0) {
    throw new Error('Missing env: ' + missing.join(','))
  }
  return {
    NODE_ENV: env.NODE_ENV as EnvVars['NODE_ENV'],
    API_BASE: env.API_BASE as string,
    DB_URL: env.DB_URL as string,
  }
}

const cfg = readEnv()
```

## 密鑰輪換

- 定期更新：每季度輪換關鍵密鑰；高風險密鑰更頻繁。
- 版本管理：密鑰以標籤標識版本，舊版本短時間保留以支持平滑切換。
- 自動化：CI/CD 在部署前拉取最新密鑰；發佈後驗證連接可用。

## 生產環境密鑰：雲服務商的密鑰管理

- 在雲側創建密鑰，配置訪問策略（最小權限），僅允許特定服務讀取。
- 應用啓動時動態注入密鑰，避免在鏡像與代碼中存儲明文。
- 審計與告警：讀取事件記錄在案；異常訪問觸發告警。

## AI 協作指南

- 核心意圖：讓 AI 生成**環境變量規範**與**輪換流程**，並輸出 PowerShell 命令。
- 需求定義公式：
  - “爲生產環境設計環境變量與密鑰注入流程，包含 `.gitignore` 規則與輪換策略，輸出 PowerShell 命令。”
- 關鍵術語：`env`, `Secrets Manager`, `Key Vault`, `輪換`, `最小權限`。

## 避坑指南

- 不要把密鑰放到 `.env.development` 或任何共享文件；只在 `.env.local` 或雲密鑰服務中保存。
- 不要在日誌中打印 `process.env`；必要信息做遮罩處理。
