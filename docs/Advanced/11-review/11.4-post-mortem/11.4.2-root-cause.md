---
title: "11.4.2 爲什麼會出問題——根因分析：技術原因與流程缺陷"
typora-root-url: ../../public
---

# 11.4.2 根因分析：技術原因與流程缺陷

## 一句話破題

找到問題的**根本原因**而不是表面原因。"數據庫掛了"是現象，"連接池配置不當"纔是根因。

## 核心價值

深入的根因分析能讓你：
- 避免頭痛醫頭腳痛醫腳
- 發現系統性的問題
- 制定真正有效的改進措施

## 5-Why 分析法

從現象出發，連續追問"爲什麼"，直到找到根本原因：

```markdown
## 5-Why 分析

**現象：用戶無法登錄**

1. 爲什麼用戶無法登錄？
   → 登錄 API 返回 500 錯誤

2. 爲什麼 API 返回 500？
   → 數據庫查詢超時

3. 爲什麼數據庫查詢超時？
   → 數據庫連接池耗盡

4. 爲什麼連接池耗盡？
   → 有慢查詢佔用連接不釋放

5. 爲什麼有慢查詢？
   → 缺少索引，且沒有查詢超時配置

**根因：缺少數據庫索引 + 沒有配置查詢超時**
```

## 根因分類

```mermaid
flowchart TD
    A["問題根因"] --> B["技術原因"]
    A --> C["流程缺陷"]
    A --> D["人爲因素"]
    
    B --> B1["代碼缺陷"]
    B --> B2["配置錯誤"]
    B --> B3["架構問題"]
    
    C --> C1["缺少測試"]
    C --> C2["缺少Review"]
    C --> C3["缺少監控"]
    
    D --> D1["操作失誤"]
    D --> D2["溝通不暢"]
    D --> D3["知識缺失"]
```

## 技術根因分析

### 代碼層面

```typescript
// 問題代碼：沒有設置查詢超時
const user = await prisma.user.findFirst({
  where: { email }
})

// 改進後：設置超時時間
const user = await prisma.user.findFirst({
  where: { email },
  // Prisma 暫不支持查詢級超時，需要在連接層配置
})
```

### 配置層面

```yaml
# 問題配置：連接池太小
DATABASE_URL="postgresql://user:pass@host:5432/db?connection_limit=5"

# 改進配置：合理的連接池大小
DATABASE_URL="postgresql://user:pass@host:5432/db?connection_limit=20&connect_timeout=10"
```

## 流程缺陷分析

| 流程環節 | 檢查點 | 本次是否缺失 |
|----------|--------|--------------|
| **開發** | 代碼審查是否發現問題？ | 未發現性能問題 |
| **測試** | 是否有性能測試？ | 沒有壓力測試 |
| **部署** | 是否有灰度發佈？ | 直接全量發佈 |
| **監控** | 是否有相關告警？ | 數據庫監控不完善 |

## 因果圖

使用魚骨圖分析多個因素：

```
                    ┌─ 代碼問題 ─ 沒有索引
                    │
                    ├─ 配置問題 ─ 連接池太小
問題：登錄失敗 ←────┤
                    ├─ 流程問題 ─ 沒有性能測試
                    │
                    └─ 監控問題 ─ 沒有數據庫告警
```

## 避坑指南

::: danger 新手最容易犯的錯
1. 停留在表面原因，不深挖根因
2. 只分析技術原因，忽略流程缺陷
3. 5-Why 問得太少（通常需要5次以上）
4. 把"人的失誤"當作根因（應該問爲什麼會失誤）
:::
