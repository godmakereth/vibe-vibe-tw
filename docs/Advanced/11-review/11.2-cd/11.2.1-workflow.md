---
title: "11.2.1 自動化流程怎麼寫——Workflow 配置：觸發條件與執行環境"
typora-root-url: ../../public
---

# 11.2.1 Workflow 配置：觸發條件與執行環境

## 一句話破題

GitHub Actions 的 Workflow 是用 YAML 定義的自動化流程，通過指定**觸發條件**和**執行步驟**來實現 CI/CD。

## 核心價值

理解 Workflow 配置能讓你：
- 在代碼提交時自動運行檢查
- 在 PR 合併前強制通過測試
- 在發佈時自動部署到生產環境

## 文件結構

```
.github/
└── workflows/
    ├── ci.yml        # 持續集成
    ├── deploy.yml    # 部署流程
    └── release.yml   # 發佈流程
```

## 快速上手

### 觸發條件配置

```yaml
name: CI

on:
  # 推送到指定分支時觸發
  push:
    branches: [main, develop]
    paths:
      - 'src/**'           # 只在 src 目錄變更時觸發
      - '!src/**/*.test.ts' # 忽略測試文件變更
  
  # PR 針對指定分支時觸發
  pull_request:
    branches: [main]
  
  # 定時觸發（北京時間每天 8:00）
  schedule:
    - cron: '0 0 * * *'
  
  # 手動觸發
  workflow_dispatch:
    inputs:
      environment:
        description: '部署環境'
        required: true
        default: 'staging'
```

### 執行環境配置

```yaml
jobs:
  build:
    runs-on: ubuntu-latest  # 運行環境
    
    strategy:
      matrix:
        node-version: [18, 20]  # 多版本測試
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'  # 緩存 npm 依賴
      
      - run: npm ci
      - run: npm test
```

### Job 依賴與並行

```yaml
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run lint

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm test

  build:
    needs: [lint, test]  # 依賴 lint 和 test 都成功
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci
      - run: npm run build
```

## 常用觸發事件

| 事件 | 說明 | 示例場景 |
|------|------|----------|
| `push` | 推送代碼 | 主分支構建 |
| `pull_request` | PR 操作 | 代碼審查前檢查 |
| `release` | 發佈 Release | 自動部署 |
| `schedule` | 定時任務 | 每日安全掃描 |
| `workflow_dispatch` | 手動觸發 | 緊急部署 |

## 條件執行

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    # 只在 main 分支且不是 PR 時執行
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'
    steps:
      - run: echo "Deploying to production"
```

## 避坑指南

::: danger 新手最容易犯的錯
1. YAML 縮進錯誤導致配置解析失敗
2. 忘記配置 `actions/checkout` 導致沒有代碼
3. 不緩存依賴導致每次都重新下載
4. 敏感信息直接寫在配置文件中
:::
