---
title: "11.2.4 CI/CD 裏的密碼——密鑰管理：CI/CD 環境配置與安全存儲"
typora-root-url: ../../public
---

# 11.2.4 密鑰管理：CI/CD 環境配置與安全存儲

## 一句話破題

敏感信息（API Key、數據庫密碼、SSH 密鑰等）**絕不能寫在代碼中**，應使用 GitHub Secrets 安全存儲。

## 核心價值

正確管理密鑰能讓你：
- 避免敏感信息泄露
- 安全地在 CI/CD 中使用密鑰
- 便於密鑰輪換和權限管理

## 配置 GitHub Secrets

### 在倉庫設置中添加

```
Settings → Secrets and variables → Actions → New repository secret

添加：
- DATABASE_URL
- VERCEL_TOKEN
- SSH_PRIVATE_KEY
```

### 在 Workflow 中使用

```yaml
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Use secret
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "Database configured"  # 不要打印實際值！
```

## 環境級別的 Secrets

不同環境使用不同的密鑰：

```yaml
jobs:
  deploy-staging:
    environment: staging  # 使用 staging 環境的 secrets
    steps:
      - env:
          API_KEY: ${{ secrets.API_KEY }}  # staging 的 API_KEY

  deploy-production:
    environment: production  # 使用 production 環境的 secrets
    steps:
      - env:
          API_KEY: ${{ secrets.API_KEY }}  # production 的 API_KEY
```

在 GitHub 中配置：
```
Settings → Environments → New environment
→ 創建 staging 和 production
→ 在各自環境中添加對應的 secrets
```

## 常見密鑰類型及使用

### SSH 密鑰

```yaml
- name: Setup SSH
  run: |
    mkdir -p ~/.ssh
    echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
    chmod 600 ~/.ssh/id_rsa
    ssh-keyscan github.com >> ~/.ssh/known_hosts
```

### Docker Registry 認證

```yaml
- name: Login to Docker Hub
  uses: docker/login-action@v3
  with:
    username: ${{ secrets.DOCKER_USERNAME }}
    password: ${{ secrets.DOCKER_PASSWORD }}
```

### 雲服務商憑證

```yaml
- name: Configure AWS Credentials
  uses: aws-actions/configure-aws-credentials@v4
  with:
    aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
    aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    aws-region: us-east-1
```

## 密鑰輪換最佳實踐

```mermaid
flowchart LR
    New["生成新密鑰"] --> Add["添加到 GitHub Secrets"]
    Add --> Test["測試 CI/CD 流程"]
    Test --> Remove["移除舊密鑰"]
    Remove --> Revoke["撤銷舊密鑰權限"]
```

## 安全檢查

在 PR 中防止意外提交密鑰：

```yaml
- name: Check for secrets
  run: |
    # 簡單的敏感信息檢查
    if grep -rE "(password|secret|api.key)\s*=\s*['\"][^'\"]+['\"]" --include="*.ts" .; then
      echo "Potential secret found in code!"
      exit 1
    fi
```

或使用專業工具：

```yaml
- name: Scan for secrets
  uses: trufflesecurity/trufflehog@main
  with:
    path: ./
    base: main
    head: HEAD
```

## 避坑指南

::: danger 新手最容易犯的錯
1. 在日誌中打印密鑰值（即使是 debug）
2. 在 PR 評論或錯誤消息中暴露密鑰
3. 使用過於寬泛的權限
4. 長期不輪換密鑰
:::
