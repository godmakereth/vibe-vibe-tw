---
title: "7.2.4 錯在哪要說清楚——錯誤響應格式：統一的錯誤信息結構"
typora-root-url: ../../public
---

# 7.2.4 錯誤響應格式

## 一句話破題

好的錯誤響應要回答三個問題：錯了什麼（code）、爲什麼錯（message）、怎麼修復（details）。

## 統一錯誤格式

```typescript
interface ErrorResponse {
  error: {
    code: string           // 機器可讀的錯誤碼
    message: string        // 用戶可讀的錯誤信息
    details?: ErrorDetail[] // 詳細的字段級錯誤
    traceId?: string       // 請求追蹤 ID
  }
}

interface ErrorDetail {
  field: string            // 出錯的字段
  message: string          // 字段錯誤信息
  code?: string            // 字段錯誤碼
}
```

### 示例

```json
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "請求參數驗證失敗",
    "details": [
      { "field": "email", "message": "郵箱格式不正確", "code": "INVALID_FORMAT" },
      { "field": "password", "message": "密碼至少 8 個字符", "code": "TOO_SHORT" }
    ],
    "traceId": "abc-123-xyz"
  }
}
```

## 錯誤碼設計

### 命名規範

```typescript
// 使用大寫下劃線分隔
const ErrorCodes = {
  // 認證相關
  UNAUTHORIZED: 'UNAUTHORIZED',
  TOKEN_EXPIRED: 'TOKEN_EXPIRED',
  INVALID_TOKEN: 'INVALID_TOKEN',
  
  // 權限相關
  FORBIDDEN: 'FORBIDDEN',
  INSUFFICIENT_PERMISSIONS: 'INSUFFICIENT_PERMISSIONS',
  
  // 資源相關
  NOT_FOUND: 'NOT_FOUND',
  ALREADY_EXISTS: 'ALREADY_EXISTS',
  
  // 驗證相關
  VALIDATION_ERROR: 'VALIDATION_ERROR',
  INVALID_FORMAT: 'INVALID_FORMAT',
  REQUIRED_FIELD: 'REQUIRED_FIELD',
  
  // 業務相關
  INSUFFICIENT_BALANCE: 'INSUFFICIENT_BALANCE',
  ORDER_CANCELLED: 'ORDER_CANCELLED',
  
  // 系統相關
  INTERNAL_ERROR: 'INTERNAL_ERROR',
  SERVICE_UNAVAILABLE: 'SERVICE_UNAVAILABLE',
  RATE_LIMITED: 'RATE_LIMITED',
} as const
```

### 錯誤碼與狀態碼對應

| 錯誤碼 | HTTP 狀態碼 | 說明 |
|--------|------------|------|
| UNAUTHORIZED | 401 | 未認證 |
| TOKEN_EXPIRED | 401 | Token 過期 |
| FORBIDDEN | 403 | 無權限 |
| NOT_FOUND | 404 | 資源不存在 |
| ALREADY_EXISTS | 409 | 資源已存在 |
| VALIDATION_ERROR | 400/422 | 驗證失敗 |
| RATE_LIMITED | 429 | 限流 |
| INTERNAL_ERROR | 500 | 服務器錯誤 |

## 實現統一錯誤處理

### 錯誤類定義

```typescript
// lib/errors.ts
export class AppError extends Error {
  constructor(
    public code: string,
    message: string,
    public statusCode: number = 400,
    public details?: ErrorDetail[]
  ) {
    super(message)
    this.name = 'AppError'
  }
}

export class ValidationError extends AppError {
  constructor(details: ErrorDetail[]) {
    super('VALIDATION_ERROR', '請求參數驗證失敗', 400, details)
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super('NOT_FOUND', `${resource}不存在`, 404)
  }
}

export class UnauthorizedError extends AppError {
  constructor(message = '請先登錄') {
    super('UNAUTHORIZED', message, 401)
  }
}

export class ForbiddenError extends AppError {
  constructor(message = '無權訪問此資源') {
    super('FORBIDDEN', message, 403)
  }
}
```

### 錯誤響應工具

```typescript
// lib/api-response.ts
export function errorResponse(error: AppError, traceId?: string) {
  return NextResponse.json(
    {
      error: {
        code: error.code,
        message: error.message,
        details: error.details,
        traceId,
      },
    },
    { status: error.statusCode }
  )
}

export function successResponse<T>(data: T, status = 200) {
  return NextResponse.json({ data }, { status })
}
```

### API 路由使用

```typescript
// app/api/users/route.ts
import { AppError, ValidationError, NotFoundError } from '@/lib/errors'
import { errorResponse, successResponse } from '@/lib/api-response'

export async function POST(request: NextRequest) {
  const traceId = crypto.randomUUID()
  
  try {
    const body = await request.json()
    
    // 驗證
    const errors: ErrorDetail[] = []
    if (!body.email) {
      errors.push({ field: 'email', message: '郵箱不能爲空', code: 'REQUIRED' })
    }
    if (!body.password || body.password.length < 8) {
      errors.push({ field: 'password', message: '密碼至少 8 個字符', code: 'TOO_SHORT' })
    }
    
    if (errors.length > 0) {
      throw new ValidationError(errors)
    }
    
    // 檢查郵箱是否已存在
    const existing = await prisma.user.findUnique({
      where: { email: body.email },
    })
    if (existing) {
      throw new AppError('EMAIL_EXISTS', '郵箱已被註冊', 409)
    }
    
    // 創建用戶
    const user = await prisma.user.create({ data: body })
    return successResponse(user, 201)
    
  } catch (error) {
    if (error instanceof AppError) {
      return errorResponse(error, traceId)
    }
    
    console.error(`[${traceId}] Unexpected error:`, error)
    return errorResponse(
      new AppError('INTERNAL_ERROR', '服務器內部錯誤', 500),
      traceId
    )
  }
}
```

## 前端錯誤處理

```typescript
// lib/api-client.ts
interface ApiError {
  code: string
  message: string
  details?: { field: string; message: string }[]
  traceId?: string
}

async function fetchApi<T>(url: string, options?: RequestInit): Promise<T> {
  const response = await fetch(url, options)
  const data = await response.json()
  
  if (!response.ok) {
    const error = data.error as ApiError
    throw new ApiClientError(error)
  }
  
  return data.data
}

class ApiClientError extends Error {
  constructor(public error: ApiError) {
    super(error.message)
  }
  
  // 獲取字段錯誤
  getFieldError(field: string): string | undefined {
    return this.error.details?.find(d => d.field === field)?.message
  }
  
  // 判斷錯誤類型
  isUnauthorized() {
    return this.error.code === 'UNAUTHORIZED'
  }
  
  isValidationError() {
    return this.error.code === 'VALIDATION_ERROR'
  }
}
```

### 表單中使用

```typescript
// 表單提交
async function handleSubmit(data: FormData) {
  try {
    await fetchApi('/api/users', {
      method: 'POST',
      body: JSON.stringify(data),
    })
    toast.success('註冊成功')
  } catch (error) {
    if (error instanceof ApiClientError) {
      if (error.isValidationError()) {
        // 顯示字段錯誤
        setErrors({
          email: error.getFieldError('email'),
          password: error.getFieldError('password'),
        })
      } else {
        toast.error(error.message)
      }
    }
  }
}
```

## 國際化支持

```typescript
// lib/error-messages.ts
const errorMessages: Record<string, Record<string, string>> = {
  zh: {
    UNAUTHORIZED: '請先登錄',
    TOKEN_EXPIRED: '登錄已過期，請重新登錄',
    FORBIDDEN: '無權訪問此資源',
    NOT_FOUND: '資源不存在',
    VALIDATION_ERROR: '請求參數驗證失敗',
    INTERNAL_ERROR: '服務器內部錯誤',
  },
  en: {
    UNAUTHORIZED: 'Please login first',
    TOKEN_EXPIRED: 'Login expired, please login again',
    FORBIDDEN: 'Access denied',
    NOT_FOUND: 'Resource not found',
    VALIDATION_ERROR: 'Validation failed',
    INTERNAL_ERROR: 'Internal server error',
  },
}

export function getErrorMessage(code: string, locale = 'zh'): string {
  return errorMessages[locale]?.[code] || errorMessages.zh[code] || code
}
```

## 覺知：常見問題

### 1. 錯誤信息不一致

```typescript
// ❌ 每個接口返回格式不同
{ "error": "用戶不存在" }
{ "message": "參數錯誤" }
{ "err": { "msg": "失敗" } }

// ✅ 統一格式
{
  "error": {
    "code": "NOT_FOUND",
    "message": "用戶不存在"
  }
}
```

### 2. 暴露敏感信息

```typescript
// ❌ 暴露內部實現細節
{
  "error": {
    "message": "查詢失敗：SELECT * FROM users WHERE id = '1' OR '1'='1'"
  }
}

// ✅ 返回通用信息
{
  "error": {
    "code": "INTERNAL_ERROR",
    "message": "服務器內部錯誤",
    "traceId": "abc-123"  // 用於日誌追蹤
  }
}
```

### 3. 驗證錯誤不夠具體

```typescript
// ❌ 只返回"驗證失敗"
{ "error": { "message": "驗證失敗" } }

// ✅ 返回詳細的字段錯誤
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "請求參數驗證失敗",
    "details": [
      { "field": "email", "message": "郵箱格式不正確" },
      { "field": "age", "message": "年齡必須大於 0" }
    ]
  }
}
```

## 本節小結

| 要點 | 說明 |
|------|------|
| **統一格式** | code + message + details |
| **錯誤碼** | 大寫下劃線，機器可讀 |
| **錯誤類** | 封裝常見錯誤類型 |
| **前端處理** | 根據 code 做不同處理 |
