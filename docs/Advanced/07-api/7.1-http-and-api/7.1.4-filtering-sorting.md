---
title: "7.1.4 精細化地拿數據——過濾與排序：查詢參數設計"
typora-root-url: ../../public
---

# 7.1.4 過濾與排序

## 一句話破題

不是所有數據都需要，也不是所有數據都要按默認順序——過濾和排序讓客戶端能精確獲取需要的數據。

## 查詢參數設計

### 基本格式

```
GET /api/posts?status=published&author=alice&sort=-createdAt&page=1&pageSize=10
```

| 參數 | 作用 | 示例 |
|------|------|------|
| `status` | 過濾條件 | `status=published` |
| `author` | 過濾條件 | `author=alice` |
| `sort` | 排序字段 | `sort=-createdAt`（-表示降序） |
| `page` | 分頁 | `page=1` |
| `pageSize` | 每頁數量 | `pageSize=10` |

## 過濾實現

### 基本過濾

```typescript
// app/api/posts/route.ts
export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  
  // 構建過濾條件
  const where: Prisma.PostWhereInput = {}
  
  const status = searchParams.get('status')
  if (status) where.status = status
  
  const authorId = searchParams.get('authorId')
  if (authorId) where.authorId = authorId
  
  const posts = await prisma.post.findMany({ where })
  
  return NextResponse.json({ data: posts })
}
```

### 模糊搜索

```typescript
const search = searchParams.get('search')
if (search) {
  where.OR = [
    { title: { contains: search, mode: 'insensitive' } },
    { content: { contains: search, mode: 'insensitive' } },
  ]
}
```

### 範圍過濾

```typescript
// 日期範圍
const startDate = searchParams.get('startDate')
const endDate = searchParams.get('endDate')

if (startDate || endDate) {
  where.createdAt = {}
  if (startDate) where.createdAt.gte = new Date(startDate)
  if (endDate) where.createdAt.lte = new Date(endDate)
}

// 數值範圍
const minPrice = searchParams.get('minPrice')
const maxPrice = searchParams.get('maxPrice')

if (minPrice || maxPrice) {
  where.price = {}
  if (minPrice) where.price.gte = parseFloat(minPrice)
  if (maxPrice) where.price.lte = parseFloat(maxPrice)
}
```

### 多值過濾

```typescript
// GET /api/posts?tags=tech,design,ai

const tags = searchParams.get('tags')?.split(',')
if (tags?.length) {
  where.tags = { hasSome: tags }
}
```

## 排序實現

### 單字段排序

```typescript
// sort=createdAt（升序）
// sort=-createdAt（降序，用 - 前綴）

const sort = searchParams.get('sort') || '-createdAt'
const isDesc = sort.startsWith('-')
const field = isDesc ? sort.slice(1) : sort

const posts = await prisma.post.findMany({
  where,
  orderBy: { [field]: isDesc ? 'desc' : 'asc' },
})
```

### 多字段排序

```typescript
// sort=-createdAt,title

const sortParam = searchParams.get('sort') || '-createdAt'
const orderBy = sortParam.split(',').map(s => {
  const isDesc = s.startsWith('-')
  const field = isDesc ? s.slice(1) : s
  return { [field]: isDesc ? 'desc' : 'asc' }
})

const posts = await prisma.post.findMany({
  where,
  orderBy,
})
```

## 完整示例

```typescript
// app/api/posts/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { Prisma } from '@prisma/client'

export async function GET(request: NextRequest) {
  const { searchParams } = new URL(request.url)
  
  // 分頁參數
  const page = Math.max(1, parseInt(searchParams.get('page') || '1'))
  const pageSize = Math.min(100, parseInt(searchParams.get('pageSize') || '10'))
  const skip = (page - 1) * pageSize
  
  // 過濾條件
  const where: Prisma.PostWhereInput = {}
  
  const status = searchParams.get('status')
  if (status) where.status = status
  
  const search = searchParams.get('search')
  if (search) {
    where.OR = [
      { title: { contains: search, mode: 'insensitive' } },
      { content: { contains: search, mode: 'insensitive' } },
    ]
  }
  
  // 排序
  const sortParam = searchParams.get('sort') || '-createdAt'
  const isDesc = sortParam.startsWith('-')
  const sortField = isDesc ? sortParam.slice(1) : sortParam
  const orderBy = { [sortField]: isDesc ? 'desc' : 'asc' }
  
  // 查詢
  const [posts, total] = await Promise.all([
    prisma.post.findMany({
      where,
      orderBy,
      skip,
      take: pageSize,
      include: { author: true },
    }),
    prisma.post.count({ where }),
  ])
  
  return NextResponse.json({
    data: posts,
    pagination: {
      page,
      pageSize,
      total,
      totalPages: Math.ceil(total / pageSize),
    },
  })
}
```

## 字段選擇

```typescript
// 只返回需要的字段
// GET /api/posts?fields=id,title,author

const fieldsParam = searchParams.get('fields')
const select = fieldsParam
  ? Object.fromEntries(fieldsParam.split(',').map(f => [f, true]))
  : undefined

const posts = await prisma.post.findMany({
  where,
  select,
})
```

## 覺知：安全問題

### 1. 排序字段白名單

```typescript
// ❌ 直接用用戶輸入的字段名
const orderBy = { [userInput]: 'desc' }  // 危險！

// ✅ 使用白名單
const allowedSortFields = ['createdAt', 'title', 'viewCount']
const field = allowedSortFields.includes(sortField) 
  ? sortField 
  : 'createdAt'
```

### 2. 分頁參數限制

```typescript
// 防止請求過多數據
const pageSize = Math.min(100, parseInt(params.pageSize || '10'))
const page = Math.max(1, parseInt(params.page || '1'))
```

### 3. 搜索注入防護

```typescript
// Prisma 已經處理了 SQL 注入
// 但仍需注意正則表達式注入
const search = searchParams.get('search')
const sanitized = search?.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
```

## 本節小結

| 要點 | 說明 |
|------|------|
| **過濾** | 用查詢參數傳遞條件 |
| **排序** | `-field` 表示降序 |
| **字段選擇** | 減少不必要的數據傳輸 |
| **安全** | 白名單驗證、參數限制 |
