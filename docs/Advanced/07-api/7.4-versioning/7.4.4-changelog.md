---
title: "7.4.4 改了要通知大家——變更日誌：API 變更記錄與通知機制"
typora-root-url: ../../public
---

# 7.4.4 變更日誌

## 一句話破題

API 變更不只是代碼改了就完了——需要記錄下來、通知到人，這樣用戶纔不會措手不及。

## Changelog 格式

### 標準結構

```markdown
# API Changelog

## [2.0.0] - 2024-06-01

### 破壞性變更 (Breaking Changes)
- `User` 對象的 `name` 字段拆分爲 `firstName` 和 `lastName`
- 移除廢棄的 `GET /api/users/:id/profile` 接口

### 新增 (Added)
- 新增 `PATCH /api/users/:id/avatar` 接口
- `User` 對象新增 `lastLoginAt` 字段

### 變更 (Changed)
- 分頁默認每頁數量從 20 改爲 10

### 廢棄 (Deprecated)
- `GET /api/users/:id/settings` 將在 v3.0.0 移除，請使用 `/api/settings/:userId`

### 修復 (Fixed)
- 修復用戶搜索時特殊字符導致的 500 錯誤
```

### 分類規則

| 分類 | 含義 | 示例 |
|------|------|------|
| **Breaking** | 不兼容變更 | 刪除字段、改變類型 |
| **Added** | 新功能 | 新接口、新字段 |
| **Changed** | 功能變更 | 修改行爲、優化性能 |
| **Deprecated** | 即將廢棄 | 標記老接口 |
| **Fixed** | Bug 修復 | 修復問題 |
| **Security** | 安全更新 | 修復漏洞 |

## Changelog 示例

```markdown
# API Changelog

所有 API 變更都會記錄在此文件。

## [未發佈]

### 新增
- 用戶批量導入接口 `POST /api/users/batch`


## [1.2.0] - 2024-03-15

### 新增
- 用戶頭像上傳 `POST /api/users/:id/avatar`
- 文章收藏功能 `POST /api/posts/:id/favorite`

### 變更
- 提升文章列表接口性能，響應時間減少 50%

### 修復
- 修復分頁參數 `page=0` 時返回空數據的問題


## [1.1.0] - 2024-02-01

### 新增
- `User` 對象新增 `avatar` 可選字段
- 新增用戶設置接口 `GET /api/users/:id/settings`

### 廢棄
- `User.nickname` 字段將在 v2.0.0 移除，請使用 `displayName`


## [1.0.0] - 2024-01-01

### 新增
- 用戶 CRUD 接口
- 文章 CRUD 接口
- JWT 認證
```

## 通知機制

### 響應頭通知

```typescript
// 在響應中添加廢棄警告
function addDeprecationHeaders(response: NextResponse) {
  response.headers.set('Deprecation', 'true')
  response.headers.set('Sunset', 'Sat, 01 Jun 2024 00:00:00 GMT')
  response.headers.set(
    'Link',
    '</api/v2/users>; rel="successor-version"'
  )
  return response
}
```

### 響應體警告

```json
{
  "data": { ... },
  "warnings": [
    {
      "code": "DEPRECATED_FIELD",
      "message": "nickname 字段將在 2024-06-01 移除，請使用 displayName"
    }
  ]
}
```

### 郵件通知

```markdown
## API 變更通知

尊敬的開發者，

我們將在 2024-06-01 發佈 API v2.0.0，包含以下變更：

### 破壞性變更
- User.name 將拆分爲 firstName 和 lastName

### 遷移指南
1. 更新客戶端代碼，使用 firstName + lastName
2. 測試新版本 API（已在 staging 環境可用）
3. 2024-06-01 前完成遷移

如有問題，請聯繫 api-support@example.com

Best regards,
API Team
```

## 版本狀態頁

```typescript
// app/api/status/route.ts
export async function GET() {
  return NextResponse.json({
    versions: [
      {
        version: 'v2',
        status: 'current',
        releaseDate: '2024-06-01',
      },
      {
        version: 'v1',
        status: 'deprecated',
        sunsetDate: '2024-12-01',
        successor: 'v2',
      },
    ],
    changelog: 'https://api.example.com/changelog',
    documentation: 'https://docs.example.com',
  })
}
```

## 遷移指南

### 文檔結構

```markdown
# v1 到 v2 遷移指南

## 概述
本指南幫助你從 API v1 遷移到 v2。

## 主要變更

### 1. 用戶名稱字段變更

**v1:**
```json
{ "name": "張三" }
```

**v2:**
```json
{ "firstName": "三", "lastName": "張" }
```

**遷移方式:**
```typescript
// 舊代碼
const displayName = user.name

// 新代碼
const displayName = `${user.lastName}${user.firstName}`
```

### 2. 認證方式變更

**v1:** 使用 API Key
**v2:** 使用 JWT Token

詳細遷移步驟請參考認證文檔。

## 測試
v2 API 現已在 staging 環境可用：
`https://staging-api.example.com/v2`

## 時間線
- 2024-04-01: v2 beta 發佈
- 2024-06-01: v2 正式發佈
- 2024-09-01: v1 停止更新
- 2024-12-01: v1 完全下線
```

## 自動化 Changelog

### 使用 Conventional Commits

```bash
# 提交格式
feat(api): add user avatar upload endpoint
fix(api): handle special characters in search
feat(api)!: split name into firstName and lastName

# ! 表示破壞性變更
```

### 自動生成 Changelog

```bash
# 使用 standard-version
npx standard-version

# 或使用 conventional-changelog
npx conventional-changelog -p angular -i CHANGELOG.md -s
```

## 覺知：注意事項

### 1. 及時更新

```
❌ 發佈後再寫 Changelog
✅ 開發時同步更新
```

### 2. 清晰具體

```markdown
❌ 模糊
- 更新了用戶接口

✅ 具體
- `GET /api/users` 新增 `status` 過濾參數
- 響應新增 `lastLoginAt` 字段
```

### 3. 提供遷移指南

```markdown
❌ 只說"字段改了"

✅ 提供遷移代碼示例
```javascript
// 遷移前
const name = user.name
// 遷移後
const name = `${user.lastName}${user.firstName}`
```
```

## 本節小結

| 要點 | 說明 |
|------|------|
| **Changelog** | 記錄所有變更 |
| **分類** | Breaking/Added/Changed/Deprecated/Fixed |
| **通知** | 響應頭、郵件、文檔 |
| **遷移指南** | 代碼示例、時間線 |
