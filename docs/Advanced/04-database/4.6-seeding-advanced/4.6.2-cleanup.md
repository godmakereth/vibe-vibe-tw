---
title: "4.6.2 測試前後的清理——與測試/E2E 的執行順序與清理"
typora-root-url: ../../public
---

# 4.6.2 測試前後的清理——與測試/E2E 的執行順序與清理

### 一句話破題

測試的可重複性依賴於"乾淨的起點"——每次測試都應該在已知狀態下開始，避免測試間相互影響。

### 測試數據管理策略

```mermaid
graph LR
    A["清理數據"] --> B["準備數據"]
    B --> C["執行測試"]
    C --> D["驗證結果"]
    D --> A
```

### 清理策略對比

| 策略 | 優點 | 缺點 |
|------|------|------|
| 測試前清理 | 保證乾淨起點 | 清理可能失敗 |
| 測試後清理 | 保持整潔 | 失敗時可能遺留數據 |
| 事務回滾 | 最快最乾淨 | 不適用於所有場景 |
| 獨立數據庫 | 完全隔離 | 資源消耗大 |

### 測試前清理（推薦）

```typescript
// tests/setup.ts
import { prisma } from '../src/lib/prisma'

export async function cleanDatabase() {
  // 按外鍵依賴反向順序刪除
  await prisma.comment.deleteMany()
  await prisma.post.deleteMany()
  await prisma.user.deleteMany()
}

export async function setupTestData() {
  // 創建測試需要的基礎數據
  const user = await prisma.user.create({
    data: {
      email: 'test@example.com',
      name: 'Test User'
    }
  })
  return { user }
}
```

### Vitest 配置

```typescript
// vitest.config.ts
import { defineConfig } from 'vitest/config'

export default defineConfig({
  test: {
    globalSetup: './tests/global-setup.ts',
    setupFiles: './tests/setup.ts',
    hookTimeout: 30000
  }
})
```

```typescript
// tests/global-setup.ts
export async function setup() {
  // 測試開始前的全局設置
  console.log('Starting test suite...')
}

export async function teardown() {
  // 測試結束後的全局清理
  console.log('Cleaning up...')
}
```

```typescript
// tests/setup.ts
import { beforeEach, afterAll } from 'vitest'
import { cleanDatabase, setupTestData } from './helpers'

beforeEach(async () => {
  await cleanDatabase()
})

afterAll(async () => {
  await prisma.$disconnect()
})
```

### 使用事務進行隔離

```typescript
// tests/helpers/with-transaction.ts
import { prisma } from '@/lib/prisma'

export async function withTransaction<T>(
  fn: (tx: typeof prisma) => Promise<T>
): Promise<T> {
  return prisma.$transaction(async (tx) => {
    const result = await fn(tx as typeof prisma)
    // 拋出錯誤觸發回滾
    throw new Error('ROLLBACK')
  }).catch((error) => {
    if (error.message === 'ROLLBACK') {
      return undefined as T
    }
    throw error
  })
}
```

### E2E 測試數據管理

```typescript
// e2e/fixtures/user.ts
import { prisma } from '@/lib/prisma'

export async function createTestUser() {
  return prisma.user.create({
    data: {
      email: `test-${Date.now()}@example.com`,
      name: 'E2E Test User'
    }
  })
}

export async function cleanupTestUser(userId: string) {
  await prisma.user.delete({
    where: { id: userId }
  })
}
```

```typescript
// e2e/user.spec.ts
import { test, expect } from '@playwright/test'
import { createTestUser, cleanupTestUser } from './fixtures/user'

let testUser: { id: string; email: string }

test.beforeAll(async () => {
  testUser = await createTestUser()
})

test.afterAll(async () => {
  await cleanupTestUser(testUser.id)
})

test('should display user profile', async ({ page }) => {
  await page.goto(`/users/${testUser.id}`)
  await expect(page.getByText(testUser.email)).toBeVisible()
})
```

### 快速清理方案

**使用 TRUNCATE（PostgreSQL）**：

```typescript
async function truncateAllTables() {
  const tables = ['Comment', 'Post', 'User']
  
  for (const table of tables) {
    await prisma.$executeRawUnsafe(
      `TRUNCATE TABLE "${table}" CASCADE`
    )
  }
}
```

**重置數據庫（開發/測試環境）**：

```bash
# 重置並重新種子
npx prisma migrate reset --force
```

### 測試數據工廠

```typescript
// tests/factories/user.ts
import { faker } from '@faker-js/faker'
import { prisma } from '@/lib/prisma'

export function createUserFactory(overrides = {}) {
  return prisma.user.create({
    data: {
      email: faker.internet.email(),
      name: faker.person.fullName(),
      ...overrides
    }
  })
}

// 使用
const user = await createUserFactory({ role: 'ADMIN' })
```

### 清理順序注意事項

```typescript
// 按外鍵依賴的反向順序刪除
const cleanupOrder = [
  'Comment',    // 依賴 Post 和 User
  'Post',       // 依賴 User
  'Profile',    // 依賴 User
  'User'        // 基礎表
]

for (const model of cleanupOrder) {
  await (prisma as any)[model.toLowerCase()].deleteMany()
}
```

### 本節小結

- 測試前清理確保乾淨起點
- 事務回滾是最快的隔離方式
- E2E 測試使用唯一標識避免衝突
- 按外鍵依賴反向順序清理數據
