---
title: "4.2.1 增刪改查的背後——CRUD 操作：Create/Read/Update/Delete 基礎"
typora-root-url: ../../public
---

# 4.2.1 增刪改查的背後——CRUD 操作：Create/Read/Update/Delete 基礎

### 一句話破題

CRUD 是數據庫操作的四個基本動作——幾乎所有的業務邏輯都可以歸結爲這四種操作的組合。

### CRUD 四大操作

| 操作 | SQL | Prisma | 說明 |
|------|-----|--------|------|
| **C**reate | INSERT | create | 新增數據 |
| **R**ead | SELECT | findMany/findUnique | 查詢數據 |
| **U**pdate | UPDATE | update | 修改數據 |
| **D**elete | DELETE | delete | 刪除數據 |

### Create：創建數據

**SQL 寫法**：
```sql
INSERT INTO users (email, name) VALUES ('user@example.com', '張三');
```

**Prisma 寫法**：
```typescript
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    name: '張三'
  }
})
```

**批量創建**：
```typescript
const users = await prisma.user.createMany({
  data: [
    { email: 'user1@example.com', name: '用戶1' },
    { email: 'user2@example.com', name: '用戶2' }
  ]
})
```

### Read：查詢數據

**查詢單條**：
```typescript
const user = await prisma.user.findUnique({
  where: { id: 'xxx' }
})
```

**查詢多條**：
```typescript
const users = await prisma.user.findMany({
  where: { name: { contains: '張' } },
  orderBy: { createdAt: 'desc' },
  take: 10,
  skip: 0
})
```

**關聯查詢**：
```typescript
const userWithPosts = await prisma.user.findUnique({
  where: { id: 'xxx' },
  include: { posts: true }
})
```

### Update：更新數據

**更新單條**：
```typescript
const user = await prisma.user.update({
  where: { id: 'xxx' },
  data: { name: '新名字' }
})
```

**批量更新**：
```typescript
const count = await prisma.user.updateMany({
  where: { role: 'USER' },
  data: { status: 'ACTIVE' }
})
```

**條件更新（upsert）**：
```typescript
// 存在則更新，不存在則創建
const user = await prisma.user.upsert({
  where: { email: 'user@example.com' },
  update: { name: '更新後的名字' },
  create: { email: 'user@example.com', name: '新用戶' }
})
```

### Delete：刪除數據

**刪除單條**：
```typescript
const user = await prisma.user.delete({
  where: { id: 'xxx' }
})
```

**批量刪除**：
```typescript
const count = await prisma.user.deleteMany({
  where: { status: 'DELETED' }
})
```

### 軟刪除 vs 硬刪除

| 類型 | 說明 | 適用場景 |
|------|------|----------|
| **硬刪除** | 真正從數據庫刪除 | 臨時數據、日誌數據 |
| **軟刪除** | 標記爲已刪除，保留數據 | 用戶數據、訂單數據 |

**軟刪除實現**：
```prisma
model User {
  id        String    @id
  deletedAt DateTime? // null 表示未刪除
}
```

```typescript
// 軟刪除
await prisma.user.update({
  where: { id: 'xxx' },
  data: { deletedAt: new Date() }
})

// 查詢時過濾已刪除
await prisma.user.findMany({
  where: { deletedAt: null }
})
```

### 操作的原子性

數據庫保證單個 CRUD 操作是原子的：

- 要麼**完全成功**
- 要麼**完全失敗**
- 不會出現"改了一半"的情況

如果需要多個操作一起成功或失敗，需要使用**事務**（4.2.3 節詳述）。

### 避坑指南

1. **避免 N+1 查詢**：使用 `include` 一次性查詢關聯數據
   ```typescript
   // 錯誤：N+1 查詢
   const users = await prisma.user.findMany()
   for (const user of users) {
     const posts = await prisma.post.findMany({ where: { authorId: user.id } })
   }
   
   // 正確：一次查詢
   const users = await prisma.user.findMany({ include: { posts: true } })
   ```

2. **刪除前檢查關聯**：外鍵約束可能阻止刪除
   ```typescript
   // 先刪除關聯數據，或配置級聯刪除
   await prisma.post.deleteMany({ where: { authorId: userId } })
   await prisma.user.delete({ where: { id: userId } })
   ```

3. **更新時注意併發**：多人同時更新同一條數據可能產生衝突

### 本節小結

- CRUD 是數據庫的四種基本操作
- Prisma 提供了類型安全的 CRUD API
- 軟刪除比硬刪除更安全
- 注意避免 N+1 查詢問題
