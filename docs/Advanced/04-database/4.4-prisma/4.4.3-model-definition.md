---
title: "4.4.3 模型定義：字段類型與關係映射"
typora-root-url: ../../public
---

# 4.4.3 模型定義：字段類型與關係映射

### 一句話破題

模型定義是 Prisma 的核心——它決定了你的數據結構、關係和約束如何映射到數據庫。

### 完整的模型示例

```prisma
model User {
  // 標識字段
  id        String   @id @default(cuid())
  
  // 業務字段
  email     String   @unique
  name      String?
  role      Role     @default(USER)
  
  // 審計字段
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  
  // 關係字段
  posts     Post[]
  profile   Profile?
  
  // 表級約束
  @@index([email])
  @@map("users")  // 映射到數據庫表名
}
```

### 字段類型詳解

**標量類型**：

| Prisma 類型 | TypeScript | PostgreSQL | 說明 |
|-------------|------------|------------|------|
| `String` | `string` | `TEXT` | 字符串 |
| `Int` | `number` | `INTEGER` | 整數 |
| `BigInt` | `bigint` | `BIGINT` | 大整數 |
| `Float` | `number` | `DOUBLE PRECISION` | 浮點數 |
| `Decimal` | `Decimal` | `DECIMAL` | 精確小數（金額） |
| `Boolean` | `boolean` | `BOOLEAN` | 布爾值 |
| `DateTime` | `Date` | `TIMESTAMP` | 日期時間 |
| `Json` | `JsonValue` | `JSONB` | JSON 數據 |
| `Bytes` | `Buffer` | `BYTEA` | 二進制數據 |

**特殊類型**：

```prisma
// 枚舉類型
enum Role {
  USER
  ADMIN
  MODERATOR
}

model User {
  role Role @default(USER)
}

// 字符串數組（PostgreSQL 支持）
model Post {
  tags String[]
}
```

### 字段修飾符

**可選與必填**：

```prisma
model User {
  name     String   // 必填
  nickname String?  // 可選（可爲 null）
}
```

**默認值**：

```prisma
model Post {
  id        String   @id @default(cuid())   // CUID
  uuid      String   @id @default(uuid())   // UUID
  createdAt DateTime @default(now())        // 當前時間
  status    String   @default("DRAFT")      // 固定值
  views     Int      @default(0)            // 數字
  isPublic  Boolean  @default(false)        // 布爾
}
```

**數據庫映射**：

```prisma
model User {
  firstName String @map("first_name")  // 字段映射
  
  @@map("users")  // 表名映射
}
```

### 關係定義

**一對一關係**：

```prisma
model User {
  id      String   @id @default(cuid())
  profile Profile?
}

model Profile {
  id     String @id @default(cuid())
  bio    String?
  userId String @unique  // 必須唯一
  user   User   @relation(fields: [userId], references: [id])
}
```

**一對多關係**：

```prisma
model User {
  id    String @id @default(cuid())
  posts Post[]  // 一個用戶有多篇文章
}

model Post {
  id       String @id @default(cuid())
  authorId String
  author   User   @relation(fields: [authorId], references: [id])
}
```

**多對多關係（隱式）**：

```prisma
model Post {
  id   String @id @default(cuid())
  tags Tag[]
}

model Tag {
  id    String @id @default(cuid())
  name  String @unique
  posts Post[]
}
// Prisma 自動創建 _PostToTag 中間表
```

**多對多關係（顯式）**：

```prisma
model Post {
  id       String    @id @default(cuid())
  postTags PostTag[]
}

model Tag {
  id       String    @id @default(cuid())
  postTags PostTag[]
}

model PostTag {
  postId    String
  tagId     String
  createdAt DateTime @default(now())
  
  post Post @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
}
```

### 級聯行爲

```prisma
model Post {
  authorId String
  author   User @relation(fields: [authorId], references: [id], onDelete: Cascade)
}
```

| 行爲 | 刪除父記錄時 | 更新父記錄時 |
|------|-------------|-------------|
| `Cascade` | 子記錄也刪除 | 子記錄也更新 |
| `SetNull` | 外鍵設爲 null | 外鍵設爲 null |
| `Restrict` | 阻止刪除 | 阻止更新 |
| `NoAction` | 同 Restrict | 同 Restrict |

### 自引用關係

```prisma
// 用戶關注關係
model User {
  id        String @id @default(cuid())
  followers User[] @relation("UserFollows")
  following User[] @relation("UserFollows")
}

// 評論回覆
model Comment {
  id       String    @id @default(cuid())
  parentId String?
  parent   Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies  Comment[] @relation("CommentReplies")
}
```

### 表級約束

```prisma
model TeamMember {
  id     String @id @default(cuid())
  userId String
  teamId String
  role   String
  
  // 複合唯一約束
  @@unique([userId, teamId])
  
  // 複合索引
  @@index([teamId, role])
  
  // 複合主鍵（替代 @id）
  // @@id([userId, teamId])
}
```

### 驗收清單

定義模型時，檢查以下幾點：

- [ ] 每個模型都有 `@id` 主鍵
- [ ] 必填字段沒有加 `?`
- [ ] 外鍵字段類型與引用字段一致
- [ ] 一對一關係的外鍵有 `@unique`
- [ ] 需要搜索/排序的字段有索引
- [ ] 審計字段（createdAt、updatedAt）已添加

### 本節小結

- 模型定義包括字段、類型、修飾符和關係
- 使用 `?` 表示可選字段，`@default()` 設置默認值
- 一對一需要 `@unique` 外鍵，多對多可用隱式或顯式
- 使用 `@@index` 和 `@@unique` 定義表級約束
