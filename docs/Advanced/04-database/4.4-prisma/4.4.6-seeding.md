---
title: "4.4.6 種子數據：prisma/seed.ts 與 npm run db:seed"
typora-root-url: ../../public
---

# 4.4.6 種子數據：prisma/seed.ts 與 npm run db:seed

### 一句話破題

種子數據是數據庫的"初始內容"——讓開發和測試環境擁有可用的示例數據。

### 配置種子腳本

**1. 安裝依賴**：

```bash
npm install -D tsx
```

**2. 配置 package.json**：

```json
{
  "prisma": {
    "seed": "tsx prisma/seed.ts"
  }
}
```

**3. 創建種子文件**：

```typescript
// prisma/seed.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  // 創建用戶
  const user = await prisma.user.upsert({
    where: { email: 'admin@example.com' },
    update: {},
    create: {
      email: 'admin@example.com',
      name: '管理員',
      role: 'ADMIN',
    },
  })

  // 創建文章
  await prisma.post.createMany({
    data: [
      { title: '第一篇文章', content: '內容...', authorId: user.id },
      { title: '第二篇文章', content: '內容...', authorId: user.id },
    ],
    skipDuplicates: true,
  })

  console.log('Seed completed!')
}

main()
  .catch((e) => {
    console.error(e)
    process.exit(1)
  })
  .finally(async () => {
    await prisma.$disconnect()
  })
```

### 運行種子腳本

```bash
# 手動運行
npx prisma db seed

# 遷移時自動運行（migrate reset 會觸發）
npx prisma migrate reset
```

### 冪等種子設計

**使用 upsert 避免重複**：

```typescript
// 冪等：重複運行不會報錯
const user = await prisma.user.upsert({
  where: { email: 'admin@example.com' },
  update: { name: '管理員' },  // 存在則更新
  create: {                      // 不存在則創建
    email: 'admin@example.com',
    name: '管理員',
  },
})
```

**使用 skipDuplicates**：

```typescript
await prisma.post.createMany({
  data: posts,
  skipDuplicates: true,  // 遇到重複跳過
})
```

### 使用 Faker 生成假數據

```bash
npm install -D @faker-js/faker
```

```typescript
import { faker } from '@faker-js/faker'
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

async function main() {
  // 生成 10 個用戶
  const users = Array.from({ length: 10 }, () => ({
    email: faker.internet.email(),
    name: faker.person.fullName(),
    avatar: faker.image.avatar(),
  }))

  for (const userData of users) {
    const user = await prisma.user.create({ data: userData })
    
    // 每個用戶創建 3-5 篇文章
    const postCount = faker.number.int({ min: 3, max: 5 })
    await prisma.post.createMany({
      data: Array.from({ length: postCount }, () => ({
        title: faker.lorem.sentence(),
        content: faker.lorem.paragraphs(3),
        authorId: user.id,
      })),
    })
  }
}

main()
```

### 分環境種子數據

```typescript
// prisma/seed.ts
const isProduction = process.env.NODE_ENV === 'production'

async function main() {
  // 所有環境都需要的基礎數據
  await seedBaseData()
  
  // 僅開發/測試環境
  if (!isProduction) {
    await seedTestData()
  }
}

async function seedBaseData() {
  // 角色、權限等基礎數據
  await prisma.role.upsert({
    where: { name: 'ADMIN' },
    update: {},
    create: { name: 'ADMIN', permissions: ['*'] },
  })
}

async function seedTestData() {
  // 測試用戶、示例數據
  // ...
}
```

### 種子腳本最佳實踐

| 實踐 | 說明 |
|------|------|
| **冪等設計** | 重複運行不報錯、不重複數據 |
| **事務包裹** | 關鍵數據用事務保證一致性 |
| **分環境** | 區分生產和測試數據 |
| **日誌輸出** | 輸出進度便於調試 |

```typescript
async function main() {
  console.log('Starting seed...')
  
  await prisma.$transaction(async (tx) => {
    console.log('Creating users...')
    await seedUsers(tx)
    
    console.log('Creating posts...')
    await seedPosts(tx)
  })
  
  console.log('Seed completed!')
}
```

### 清理數據

```typescript
async function cleanDatabase() {
  // 按照外鍵依賴順序刪除
  await prisma.comment.deleteMany()
  await prisma.post.deleteMany()
  await prisma.user.deleteMany()
}

async function main() {
  await cleanDatabase()
  await seedData()
}
```

### 本節小結

- 在 package.json 配置 `prisma.seed` 腳本
- 使用 `upsert` 或 `skipDuplicates` 實現冪等
- 使用 Faker 生成真實的假數據
- 區分生產和測試環境的種子數據
