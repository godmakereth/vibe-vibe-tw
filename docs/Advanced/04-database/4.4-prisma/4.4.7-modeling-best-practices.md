---
title: "4.4.7 複雜關係如何設計——數據建模最佳實踐"
typora-root-url: ../../public
---

# 4.4.7 複雜關係如何設計——數據建模最佳實踐

### 一句話破題

好的數據模型不是一次設計出來的——它需要在滿足當前需求和預留擴展空間之間找到平衡。

### 實戰案例：博客系統

```prisma
// 完整的博客系統模型示例
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  avatar        String?
  role          Role      @default(USER)
  
  posts         Post[]
  comments      Comment[]
  likes         Like[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([email])
}

model Post {
  id            String    @id @default(cuid())
  title         String
  slug          String    @unique
  content       String
  excerpt       String?
  coverImage    String?
  status        PostStatus @default(DRAFT)
  publishedAt   DateTime?
  
  authorId      String
  author        User      @relation(fields: [authorId], references: [id])
  
  categoryId    String?
  category      Category? @relation(fields: [categoryId], references: [id])
  
  tags          PostTag[]
  comments      Comment[]
  likes         Like[]
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  @@index([authorId, status])
  @@index([slug])
}

model Category {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  posts     Post[]
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  posts     PostTag[]
}

model PostTag {
  postId    String
  tagId     String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  tag       Tag       @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@id([postId, tagId])
}

model Comment {
  id        String    @id @default(cuid())
  content   String
  
  authorId  String
  author    User      @relation(fields: [authorId], references: [id])
  
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  
  createdAt DateTime  @default(now())
  
  @@index([postId])
}

model Like {
  userId    String
  postId    String
  user      User      @relation(fields: [userId], references: [id])
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  
  @@id([userId, postId])
}

enum Role {
  USER
  ADMIN
}

enum PostStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}
```

### 設計原則

**1. 命名規範**

| 類型 | 規範 | 示例 |
|------|------|------|
| 模型名 | 單數、PascalCase | `User`, `Post` |
| 字段名 | camelCase | `firstName`, `createdAt` |
| 外鍵 | `關聯模型名 + Id` | `authorId`, `postId` |
| 中間表 | `模型A + 模型B` | `PostTag`, `UserRole` |

**2. 必備字段**

```prisma
model Entity {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
```

**3. 軟刪除模式**

```prisma
model Post {
  deletedAt DateTime?
  
  // 查詢時過濾
  // where: { deletedAt: null }
}
```

### 常見場景處理

**多態關係（評論可以關聯文章或視頻）**：

```prisma
model Comment {
  id         String  @id @default(cuid())
  content    String
  
  // 方案1：分開外鍵
  postId     String?
  videoId    String?
  post       Post?   @relation(fields: [postId], references: [id])
  video      Video?  @relation(fields: [videoId], references: [id])
  
  // 方案2：通用外鍵 + 類型字段
  // targetId   String
  // targetType String  // "POST" | "VIDEO"
}
```

**歷史記錄/審計日誌**：

```prisma
model AuditLog {
  id        String   @id @default(cuid())
  action    String   // CREATE, UPDATE, DELETE
  entity    String   // User, Post
  entityId  String
  oldData   Json?
  newData   Json?
  userId    String
  createdAt DateTime @default(now())
  
  @@index([entity, entityId])
}
```

**樹形結構（分類/組織架構）**：

```prisma
model Category {
  id        String     @id @default(cuid())
  name      String
  parentId  String?
  parent    Category?  @relation("CategoryTree", fields: [parentId], references: [id])
  children  Category[] @relation("CategoryTree")
}
```

### 性能優化建議

1. **爲查詢條件添加索引**：
   ```prisma
   @@index([authorId, status])
   @@index([createdAt])
   ```

2. **避免過深的嵌套關係**：超過 3 層考慮扁平化

3. **大字段分表**：
   ```prisma
   model Post {
     id      String       @id
     title   String
     content PostContent?
   }
   
   model PostContent {
     id      String @id
     postId  String @unique
     body    String // 大文本
     post    Post   @relation(fields: [postId], references: [id])
   }
   ```

### 設計檢查清單

- [ ] 每個模型有 id、createdAt、updatedAt
- [ ] 外鍵字段命名規範
- [ ] 一對一關係外鍵有 @unique
- [ ] 多對多關係配置了 onDelete 行爲
- [ ] 查詢頻繁的字段有索引
- [ ] 敏感數據考慮了軟刪除

### 本節小結

- 遵循命名規範保持一致性
- 必備字段：id、createdAt、updatedAt
- 根據業務場景選擇合適的關係模式
- 爲查詢條件添加索引優化性能
