---
title: "4.4.4 數據庫連接：連接字符串與環境配置"
typora-root-url: ../../public
---

# 4.4.4 數據庫連接：連接字符串與環境配置

### 一句話破題

正確配置數據庫連接是使用 Prisma 的第一步——連接字符串決定了你的應用如何與數據庫通信。

### 連接字符串格式

```
postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=SCHEMA
```

| 組件 | 說明 | 示例 |
|------|------|------|
| `USER` | 數據庫用戶名 | `postgres` |
| `PASSWORD` | 用戶密碼 | `mypassword` |
| `HOST` | 數據庫服務器地址 | `localhost` |
| `PORT` | 端口號 | `5432` |
| `DATABASE` | 數據庫名 | `myapp` |
| `schema` | PostgreSQL schema | `public` |

### 不同環境的配置

**本地開發（SQLite）**：

```env
# .env
DATABASE_URL="file:./dev.db"
```

```prisma
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}
```

**本地開發（PostgreSQL + Docker）**：

```yaml
# docker-compose.yml
services:
  db:
    image: postgres:15
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: myapp
    ports:
      - "5432:5432"
```

```env
# .env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/myapp?schema=public"
```

**Supabase**：

```env
# .env
DATABASE_URL="postgresql://postgres:[YOUR-PASSWORD]@db.[PROJECT-REF].supabase.co:5432/postgres"
```

**Neon（Serverless PostgreSQL）**：

```env
# .env
DATABASE_URL="postgresql://[user]:[password]@[endpoint].neon.tech/[database]?sslmode=require"
```

### 環境變量管理

**多環境配置**：

```
.env                 # 默認配置（開發）
.env.local           # 本地覆蓋（不提交到 Git）
.env.development     # 開發環境
.env.test            # 測試環境
.env.production      # 生產環境
```

**.gitignore 配置**：

```gitignore
# 不要提交包含密碼的文件
.env
.env.local
.env.*.local

# 可以提交的示例文件
!.env.example
```

**.env.example 示例**：

```env
# 複製此文件爲 .env 並填入真實值
DATABASE_URL="postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=public"
```

### Prisma Client 初始化

**基礎用法**：

```typescript
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

export default prisma
```

**開發環境單例模式**（避免熱重載創建多個連接）：

```typescript
// lib/prisma.ts
import { PrismaClient } from '@prisma/client'

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined
}

export const prisma = globalForPrisma.prisma ?? new PrismaClient()

if (process.env.NODE_ENV !== 'production') {
  globalForPrisma.prisma = prisma
}
```

**帶日誌配置**：

```typescript
const prisma = new PrismaClient({
  log: [
    { level: 'query', emit: 'event' },   // 查詢日誌
    { level: 'error', emit: 'stdout' },  // 錯誤日誌
    { level: 'warn', emit: 'stdout' },   // 警告日誌
  ],
})

// 監聽查詢事件
prisma.$on('query', (e) => {
  console.log('Query: ' + e.query)
  console.log('Duration: ' + e.duration + 'ms')
})
```

### 連接池配置

**URL 參數方式**：

```env
DATABASE_URL="postgresql://user:pass@host:5432/db?connection_limit=5&pool_timeout=10"
```

| 參數 | 說明 | 默認值 |
|------|------|--------|
| `connection_limit` | 最大連接數 | `num_cpus * 2 + 1` |
| `pool_timeout` | 獲取連接超時（秒） | `10` |
| `connect_timeout` | 建立連接超時（秒） | `5` |

**Serverless 環境配置**：

```env
# Vercel / Netlify 等 Serverless 環境
DATABASE_URL="postgresql://...?connection_limit=1"
```

Serverless 環境建議使用連接池服務（如 Supabase Pooler、PgBouncer）。

### 多數據源配置

```prisma
// 主數據庫
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 如需連接多個數據庫，使用多個 Prisma Client
// prisma/schema-analytics.prisma
datasource analytics {
  provider = "postgresql"
  url      = env("ANALYTICS_DATABASE_URL")
}
```

### 連接測試

```typescript
async function testConnection() {
  try {
    await prisma.$connect()
    console.log('Database connected successfully')
  } catch (error) {
    console.error('Failed to connect to database:', error)
    process.exit(1)
  }
}

testConnection()
```

### 避坑指南

1. **密碼中的特殊字符需要 URL 編碼**：
   ```
   # 原始密碼：p@ss#word
   # 編碼後：p%40ss%23word
   DATABASE_URL="postgresql://user:p%40ss%23word@host:5432/db"
   ```

2. **SSL 連接**（雲數據庫通常需要）：
   ```env
   DATABASE_URL="postgresql://...?sslmode=require"
   ```

3. **開發環境連接數過多**：使用單例模式避免熱重載創建多個連接

4. **生產環境忘記設置環境變量**：部署前檢查所有必需的環境變量

### 本節小結

- 連接字符串包含用戶名、密碼、主機、端口和數據庫名
- 使用 `.env` 文件管理環境變量，不要提交敏感信息
- 開發環境使用單例模式避免連接數過多
- Serverless 環境需要配置較小的連接池
