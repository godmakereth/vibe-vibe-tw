---
title: "4.4.9 數據如何保證一致——事務處理：數據一致性保證"
typora-root-url: ../../public
---

# 4.4.9 數據如何保證一致——事務處理：數據一致性保證

### 一句話破題

事務讓多個操作要麼全部成功、要麼全部回滾——這是保證數據一致性的核心機制。

### Prisma 事務類型

| 類型 | 用途 | 特點 |
|------|------|------|
| **順序事務** | 多個獨立操作 | 簡單，無法在操作間加邏輯 |
| **交互式事務** | 有依賴的操作 | 靈活，可以在操作間加業務邏輯 |

### 順序事務

```typescript
// 多個操作作爲數組傳入，按順序執行
const [user, post] = await prisma.$transaction([
  prisma.user.create({
    data: { email: 'user@example.com', name: '用戶' }
  }),
  prisma.post.create({
    data: { title: '文章', authorId: 'xxx' }
  })
])
```

**適用場景**：多個獨立操作需要原子性執行

### 交互式事務

```typescript
// 可以在事務中編寫業務邏輯
const result = await prisma.$transaction(async (tx) => {
  // 1. 查詢當前餘額
  const account = await tx.account.findUnique({
    where: { userId: senderId }
  })
  
  // 2. 業務邏輯判斷
  if (!account || account.balance < amount) {
    throw new Error('餘額不足')
  }
  
  // 3. 扣減發送方餘額
  await tx.account.update({
    where: { userId: senderId },
    data: { balance: { decrement: amount } }
  })
  
  // 4. 增加接收方餘額
  await tx.account.update({
    where: { userId: receiverId },
    data: { balance: { increment: amount } }
  })
  
  // 5. 記錄交易日誌
  const transaction = await tx.transaction.create({
    data: {
      senderId,
      receiverId,
      amount,
      type: 'TRANSFER'
    }
  })
  
  return transaction
})
```

### 事務配置選項

```typescript
await prisma.$transaction(
  async (tx) => {
    // ...
  },
  {
    maxWait: 5000,      // 等待獲取事務的最長時間（毫秒）
    timeout: 10000,     // 事務執行的最長時間（毫秒）
    isolationLevel: 'Serializable'  // 隔離級別
  }
)
```

**隔離級別**：

| 級別 | 說明 |
|------|------|
| `ReadUncommitted` | 最低隔離，可能讀到未提交的數據 |
| `ReadCommitted` | 只讀已提交的數據（PostgreSQL 默認） |
| `RepeatableRead` | 同一事務內多次讀取結果一致 |
| `Serializable` | 最高隔離，完全串行化 |

### 常見事務場景

**場景一：創建訂單 + 扣減庫存**

```typescript
async function createOrder(userId: string, items: OrderItem[]) {
  return prisma.$transaction(async (tx) => {
    // 檢查並扣減庫存
    for (const item of items) {
      const product = await tx.product.findUnique({
        where: { id: item.productId }
      })
      
      if (!product || product.stock < item.quantity) {
        throw new Error(`商品 ${item.productId} 庫存不足`)
      }
      
      await tx.product.update({
        where: { id: item.productId },
        data: { stock: { decrement: item.quantity } }
      })
    }
    
    // 創建訂單
    const order = await tx.order.create({
      data: {
        userId,
        items: {
          create: items.map(item => ({
            productId: item.productId,
            quantity: item.quantity,
            price: item.price
          }))
        }
      }
    })
    
    return order
  })
}
```

**場景二：用戶註冊 + 初始化數據**

```typescript
async function registerUser(data: RegisterData) {
  return prisma.$transaction(async (tx) => {
    // 創建用戶
    const user = await tx.user.create({
      data: {
        email: data.email,
        name: data.name
      }
    })
    
    // 創建用戶配置
    await tx.userSettings.create({
      data: {
        userId: user.id,
        theme: 'light',
        notifications: true
      }
    })
    
    // 創建初始錢包
    await tx.wallet.create({
      data: {
        userId: user.id,
        balance: 0
      }
    })
    
    return user
  })
}
```

### 嵌套寫入 vs 事務

**嵌套寫入**（Prisma 自動使用事務）：

```typescript
// 這已經是原子操作
const user = await prisma.user.create({
  data: {
    email: 'user@example.com',
    profile: {
      create: { bio: '...' }
    },
    posts: {
      create: [
        { title: '文章1' },
        { title: '文章2' }
      ]
    }
  }
})
```

**何時需要顯式事務**：
- 需要在操作間加業務邏輯
- 需要跨多個頂級操作
- 需要配置事務選項

### 錯誤處理

```typescript
try {
  await prisma.$transaction(async (tx) => {
    // ...
  })
} catch (error) {
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    // Prisma 錯誤
    if (error.code === 'P2002') {
      // 唯一約束衝突
    }
  }
  throw error
}
```

### 避坑指南

1. **事務要短**：長事務會鎖定資源，影響併發

2. **不要在事務中調用外部服務**：
   ```typescript
   // 錯誤示例
   await prisma.$transaction(async (tx) => {
     await tx.order.create({ ... })
     await sendEmail()  // 外部調用可能失敗或很慢
   })
   
   // 正確：先事務，後調用
   const order = await prisma.$transaction(async (tx) => {
     return tx.order.create({ ... })
   })
   await sendEmail()  // 事務成功後再發郵件
   ```

3. **處理死鎖**：設置合理的超時時間

### 本節小結

- 順序事務用於簡單的多操作原子執行
- 交互式事務用於需要業務邏輯的場景
- 嵌套寫入自動使用事務，簡單場景不需要顯式事務
- 事務要短，避免在事務中調用外部服務
