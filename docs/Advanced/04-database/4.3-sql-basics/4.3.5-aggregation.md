---
title: "4.3.5 如何統計數據——聚合函數：COUNT/SUM/AVG/MAX/MIN"
typora-root-url: ../../public
---

# 4.3.5 如何統計數據——聚合函數：COUNT/SUM/AVG/MAX/MIN

### 一句話破題

聚合函數把多行數據"壓縮"成一個值——統計數量、求和、平均值等都靠它。

### 五大聚合函數

| 函數 | 作用 | 示例 |
|------|------|------|
| **COUNT** | 計數 | 文章總數 |
| **SUM** | 求和 | 訂單總金額 |
| **AVG** | 平均值 | 平均評分 |
| **MAX** | 最大值 | 最高價格 |
| **MIN** | 最小值 | 最低價格 |

### 基礎用法

**COUNT：計數**
```sql
-- 統計用戶總數
SELECT COUNT(*) FROM users;

-- 統計有郵箱的用戶數（不計 NULL）
SELECT COUNT(email) FROM users;

-- 統計不重複的城市數
SELECT COUNT(DISTINCT city) FROM users;
```

**SUM：求和**
```sql
-- 訂單總金額
SELECT SUM(amount) FROM orders;

-- 某用戶的訂單總金額
SELECT SUM(amount) FROM orders WHERE user_id = 'xxx';
```

**AVG：平均值**
```sql
-- 平均訂單金額
SELECT AVG(amount) FROM orders;

-- 平均評分
SELECT AVG(rating) FROM reviews WHERE product_id = 'xxx';
```

**MAX / MIN：最大最小值**
```sql
-- 最高和最低價格
SELECT MAX(price), MIN(price) FROM products;

-- 最新訂單時間
SELECT MAX(created_at) FROM orders;
```

### GROUP BY：分組聚合

**按分組統計**：

```sql
-- 每個用戶的訂單數
SELECT user_id, COUNT(*) as order_count
FROM orders
GROUP BY user_id;

-- 每個分類的商品數和平均價格
SELECT category_id, COUNT(*) as count, AVG(price) as avg_price
FROM products
GROUP BY category_id;
```

### HAVING：過濾分組結果

```sql
-- 訂單數超過 10 的用戶
SELECT user_id, COUNT(*) as order_count
FROM orders
GROUP BY user_id
HAVING COUNT(*) > 10;
```

**WHERE vs HAVING**：
- WHERE：過濾原始行（分組前）
- HAVING：過濾聚合結果（分組後）

```sql
-- WHERE 過濾單價 > 100 的訂單
-- HAVING 過濾總金額 > 1000 的用戶
SELECT user_id, SUM(amount) as total
FROM orders
WHERE amount > 100
GROUP BY user_id
HAVING SUM(amount) > 1000;
```

### Prisma 中的聚合

**基礎聚合**：
```typescript
// 統計用戶總數
const count = await prisma.user.count()

// 條件統計
const activeCount = await prisma.user.count({
  where: { status: 'ACTIVE' }
})
```

**聚合函數**：
```typescript
const result = await prisma.order.aggregate({
  _count: true,
  _sum: { amount: true },
  _avg: { amount: true },
  _max: { amount: true },
  _min: { amount: true }
})
// { _count: 100, _sum: { amount: 50000 }, _avg: { amount: 500 }, ... }
```

**分組聚合**：
```typescript
// 按用戶分組統計訂單
const result = await prisma.order.groupBy({
  by: ['userId'],
  _count: true,
  _sum: { amount: true }
})
// [{ userId: 'u1', _count: 5, _sum: { amount: 1000 } }, ...]
```

**分組過濾（having）**：
```typescript
const result = await prisma.order.groupBy({
  by: ['userId'],
  _count: true,
  having: {
    amount: {
      _sum: { gt: 1000 }  // 總金額 > 1000
    }
  }
})
```

### 常見統計場景

**場景一：用戶統計面板**
```typescript
const stats = await prisma.$transaction([
  prisma.user.count(),
  prisma.user.count({ where: { status: 'ACTIVE' } }),
  prisma.order.aggregate({ _sum: { amount: true } })
])
```

**場景二：排行榜**
```typescript
const topSellers = await prisma.order.groupBy({
  by: ['productId'],
  _count: true,
  orderBy: { _count: { productId: 'desc' } },
  take: 10
})
```

### 本節小結

- 聚合函數把多行數據彙總成一個值
- COUNT/SUM/AVG/MAX/MIN 是五大聚合函數
- GROUP BY 按字段分組統計
- HAVING 過濾分組結果
- Prisma 提供 `count()`、`aggregate()`、`groupBy()` 方法
