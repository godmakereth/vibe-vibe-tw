---
title: "4.5.1 開發和生產環境如何同步——遷移策略：開發/測試/生產環境同步"
typora-root-url: ../../public
---

# 4.5.1 開發和生產環境如何同步——遷移策略：開發/測試/生產環境同步

### 一句話破題

環境同步的關鍵是讓遷移文件成爲"唯一真相"——所有環境都通過應用相同的遷移文件來保持一致。

### 多環境架構

```mermaid
graph LR
    A["開發環境"] --> B["遷移文件"]
    B --> C["測試環境"]
    B --> D["預發環境"]
    B --> E["生產環境"]
```

### 環境配置

**.env.development**：
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/myapp_dev"
```

**.env.test**：
```env
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/myapp_test"
```

**.env.production**：
```env
DATABASE_URL="postgresql://user:pass@prod-host:5432/myapp_prod"
```

### 工作流程

**1. 開發環境創建遷移**

```bash
# 修改 schema.prisma 後
npx prisma migrate dev --name add_user_avatar
```

**2. 提交遷移文件到 Git**

```bash
git add prisma/migrations/
git commit -m "feat: add user avatar field"
```

**3. 測試環境驗證**

```bash
# CI/CD 中
DATABASE_URL=$TEST_DATABASE_URL npx prisma migrate deploy
npm run test
```

**4. 生產環境部署**

```bash
# 部署腳本中
DATABASE_URL=$PROD_DATABASE_URL npx prisma migrate deploy
```

### CI/CD 配置示例

```yaml
# .github/workflows/deploy.yml
name: Deploy

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          
      - name: Generate Prisma Client
        run: npx prisma generate
        
      - name: Deploy application
        run: npm run deploy
```

### 環境差異處理

**開發 vs 生產的常見差異**：

| 差異點 | 開發環境 | 生產環境 |
|--------|----------|----------|
| 數據庫 | SQLite / 本地 PostgreSQL | 雲 PostgreSQL |
| 數據量 | 少量測試數據 | 大量真實數據 |
| 遷移速度 | 秒級 | 可能分鐘級 |
| 回滾代價 | 可接受 | 需謹慎 |

**處理方式**：

```prisma
// 生產環境使用 PostgreSQL 特性
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}
```

### 常見問題處理

**問題：遷移狀態不一致**

```bash
# 查看遷移狀態
npx prisma migrate status

# 強制標記遷移爲已應用（謹慎使用）
npx prisma migrate resolve --applied "20240101120000_init"
```

**問題：數據庫 schema 與遷移不匹配**

```bash
# 從數據庫反向生成 schema（不推薦常用）
npx prisma db pull
```

### 最佳實踐

1. **遷移文件必須提交到 Git**
2. **不要手動修改已應用的遷移**
3. **生產環境只用 `migrate deploy`**
4. **團隊成員及時拉取最新遷移**

### 本節小結

- 遷移文件是環境同步的核心
- 開發用 `migrate dev`，生產用 `migrate deploy`
- 在 CI/CD 中自動應用遷移
- 保持遷移文件與代碼同步提交
