---
title: "6.5.4 釘釘登錄怎麼接——釘釘登錄：企業內部應用與第三方應用"
typora-root-url: ../../public
---

# 6.5.4 釘釘登錄：企業內部應用與第三方應用

## 一句話破題

釘釘登錄主要面向 B 端場景，分爲**企業內部應用**（員工登錄）和**第三方應用**（SaaS 產品），接入流程略有不同。

## 核心價值

接入釘釘登錄能讓你：
- 爲企業級產品提供便捷登錄
- 獲取用戶的企業身份信息
- 與釘釘工作臺深度集成

## 兩種應用類型

| 類型 | 適用場景 | 用戶範圍 |
|------|----------|----------|
| 企業內部應用 | 企業自用系統 | 僅本企業員工 |
| 第三方應用 | SaaS 產品 | 所有釘釘用戶 |

## 企業內部應用接入

### 前置條件

1. 登錄[釘釘開放平臺](https://open.dingtalk.com/)
2. 創建企業內部應用
3. 獲取 AppKey 和 AppSecret

### 實現代碼

```typescript
// app/api/auth/dingtalk/route.ts
export async function GET() {
  const state = generateSecureState()
  
  const params = new URLSearchParams({
    appid: process.env.DINGTALK_APP_KEY!,
    response_type: 'code',
    scope: 'openid',
    redirect_uri: 'https://your-site.com/api/auth/dingtalk/callback',
    state,
    prompt: 'consent',
  })
  
  return Response.redirect(
    `https://login.dingtalk.com/oauth2/auth?${params}`
  )
}
```

```typescript
// app/api/auth/dingtalk/callback/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const authCode = searchParams.get('authCode')
  const state = searchParams.get('state')
  
  if (!verifyState(state)) {
    return Response.redirect('/login?error=invalid_state')
  }
  
  // 1. 獲取用戶 access_token
  const tokenRes = await fetch('https://api.dingtalk.com/v1.0/oauth2/userAccessToken', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      clientId: process.env.DINGTALK_APP_KEY,
      clientSecret: process.env.DINGTALK_APP_SECRET,
      code: authCode,
      grantType: 'authorization_code',
    }),
  })
  
  const { accessToken } = await tokenRes.json()
  
  // 2. 獲取用戶信息
  const userRes = await fetch('https://api.dingtalk.com/v1.0/contact/users/me', {
    headers: { 'x-acs-dingtalk-access-token': accessToken },
  })
  
  const userInfo = await userRes.json()
  
  // 3. 創建或關聯用戶
  const user = await findOrCreateUser({
    dingtalkUnionId: userInfo.unionId,
    dingtalkOpenId: userInfo.openId,
    nickname: userInfo.nick,
    avatar: userInfo.avatarUrl,
    mobile: userInfo.mobile,
  })
  
  await createSession(user)
  return Response.redirect('/dashboard')
}
```

## 釘釘的用戶標識

| 標識 | 說明 | 跨應用 |
|------|------|--------|
| `openId` | 應用內唯一 | 否 |
| `unionId` | 企業內唯一 | 是（同企業） |
| `userId` | 企業通訊錄 ID | 需額外權限 |

## 獲取企業信息

如果需要獲取用戶所在企業信息，需要額外調用接口：

```typescript
// 獲取企業 access_token
const corpTokenRes = await fetch(
  `https://oapi.dingtalk.com/gettoken?appkey=${appKey}&appsecret=${appSecret}`
)
const { access_token: corpToken } = await corpTokenRes.json()

// 根據 unionId 獲取 userId
const userIdRes = await fetch(
  `https://oapi.dingtalk.com/topapi/user/getbyunionid?access_token=${corpToken}`,
  {
    method: 'POST',
    body: JSON.stringify({ unionid: userInfo.unionId }),
  }
)

// 獲取用戶詳細信息（包含部門等）
const detailRes = await fetch(
  `https://oapi.dingtalk.com/topapi/v2/user/get?access_token=${corpToken}`,
  {
    method: 'POST',
    body: JSON.stringify({ userid }),
  }
)
```

## 避坑指南

::: danger 新手最容易犯的錯
1. 混淆新版 API 和舊版 API（推薦使用新版 v1.0）
2. 企業內部應用只能本企業員工使用
3. unionId 只在同一企業內相同，不同企業不同
4. 部分接口需要企業管理員授權
:::
