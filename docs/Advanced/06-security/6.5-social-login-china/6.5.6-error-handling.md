---
title: "6.5.6 登錄異常怎麼辦——錯誤處理：登錄失敗與異常情況處理"
typora-root-url: ../../public
---

# 6.5.6 登錄異常怎麼辦——錯誤處理

## 一句話破題

第三方登錄流程涉及多方交互，任何環節都可能出錯。好的錯誤處理能讓用戶**知道發生了什麼、該怎麼做**，而不是面對一個空白頁面。

## 核心價值

完善錯誤處理能讓你：
- 提升用戶體驗，減少流失
- 快速定位問題根源
- 降低客服壓力

## 常見錯誤類型

| 錯誤類型 | 常見原因 | 用戶提示 |
|----------|----------|----------|
| 用戶取消授權 | 點擊了"拒絕" | 您已取消授權，請重試 |
| state 驗證失敗 | CSRF 攻擊/鏈接過期 | 請求已過期，請重新登錄 |
| access_token 獲取失敗 | 網絡問題/密鑰錯誤 | 登錄服務暫時不可用 |
| 用戶信息獲取失敗 | token 過期/權限不足 | 無法獲取您的信息 |

## 統一錯誤處理

```typescript
// lib/oauth-errors.ts
export class OAuthError extends Error {
  constructor(
    public code: string,
    public userMessage: string,
    public debugMessage?: string
  ) {
    super(userMessage)
    this.name = 'OAuthError'
  }
}

export const OAuthErrors = {
  USER_CANCELLED: new OAuthError(
    'user_cancelled',
    '您已取消授權，如需登錄請重試',
    'User denied authorization'
  ),
  STATE_MISMATCH: new OAuthError(
    'state_mismatch',
    '登錄請求已過期，請重新登錄',
    'State parameter validation failed'
  ),
  TOKEN_FAILED: new OAuthError(
    'token_failed',
    '登錄服務暫時不可用，請稍後再試',
    'Failed to exchange code for token'
  ),
  USER_INFO_FAILED: new OAuthError(
    'user_info_failed',
    '無法獲取您的賬號信息，請重試',
    'Failed to fetch user info'
  ),
  BINDING_CONFLICT: new OAuthError(
    'binding_conflict',
    '該賬號已綁定其他用戶',
    'OAuth account already linked to another user'
  ),
}
```

## 回調處理示例

```typescript
// app/api/auth/wechat/callback/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  
  try {
    // 1. 檢查用戶是否取消授權
    const error = searchParams.get('error')
    if (error === 'access_denied') {
      throw OAuthErrors.USER_CANCELLED
    }
    
    // 2. 驗證 state
    const state = searchParams.get('state')
    if (!verifyState(state)) {
      throw OAuthErrors.STATE_MISMATCH
    }
    
    // 3. 獲取 code
    const code = searchParams.get('code')
    if (!code) {
      throw new OAuthError('no_code', '授權失敗', 'No code in callback')
    }
    
    // 4. 換取 token
    const tokenRes = await fetch(TOKEN_URL)
    if (!tokenRes.ok) {
      throw OAuthErrors.TOKEN_FAILED
    }
    
    const tokenData = await tokenRes.json()
    if (tokenData.errcode) {
      console.error('WeChat token error:', tokenData)
      throw OAuthErrors.TOKEN_FAILED
    }
    
    // 5. 獲取用戶信息
    const userRes = await fetch(USER_INFO_URL)
    if (!userRes.ok) {
      throw OAuthErrors.USER_INFO_FAILED
    }
    
    // 6. 登錄成功
    const user = await handleOAuthLogin(userInfo)
    await createSession(user)
    return Response.redirect('/dashboard')
    
  } catch (error) {
    // 記錄詳細錯誤用於調試
    console.error('OAuth callback error:', {
      error,
      url: request.url,
      timestamp: new Date().toISOString(),
    })
    
    // 返回用戶友好的錯誤頁面
    const errorCode = error instanceof OAuthError ? error.code : 'unknown'
    const message = error instanceof OAuthError ? error.userMessage : '登錄失敗'
    
    return Response.redirect(
      `/login?error=${encodeURIComponent(errorCode)}&message=${encodeURIComponent(message)}`
    )
  }
}
```

## 錯誤展示頁面

```tsx
// app/login/page.tsx
export default function LoginPage({ searchParams }) {
  const error = searchParams.error
  const message = searchParams.message
  
  return (
    <div>
      {error && (
        <div className="bg-red-50 border border-red-200 rounded p-4 mb-4">
          <p className="text-red-700">{message || '登錄失敗，請重試'}</p>
          {error === 'user_cancelled' && (
            <p className="text-sm text-red-500 mt-1">
              如果您想使用此服務，需要授權我們獲取基本信息
            </p>
          )}
        </div>
      )}
      
      <div className="space-y-4">
        <button onClick={() => signIn('wechat')}>
          微信登錄
        </button>
      </div>
    </div>
  )
}
```

## 監控與告警

```typescript
// lib/error-reporting.ts
interface OAuthErrorLog {
  code: string
  provider: string
  timestamp: string
  ip?: string
  userAgent?: string
  debugMessage?: string
}

export async function reportOAuthError(
  error: OAuthError,
  request: Request,
  provider: string
) {
  const log: OAuthErrorLog = {
    code: error.code,
    provider,
    timestamp: new Date().toISOString(),
    ip: request.headers.get('x-forwarded-for') || undefined,
    userAgent: request.headers.get('user-agent') || undefined,
    debugMessage: error.debugMessage,
  }
  
  // 發送到日誌服務
  console.error('[OAuth Error]', JSON.stringify(log))
  
  // 如果錯誤率過高，觸發告警
  // await checkErrorRate(provider)
}
```

## 避坑指南

::: danger 新手最容易犯的錯
1. 直接把後端錯誤信息展示給用戶——泄露敏感信息
2. 所有錯誤都顯示"登錄失敗"——用戶不知道如何解決
3. 沒有記錄錯誤日誌——無法排查問題
4. 沒有處理網絡超時——用戶等待後看到空白頁
:::
