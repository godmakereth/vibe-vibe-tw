---
title: "6.5.3 QQ 登錄怎麼接——QQ 互聯平臺接入"
typora-root-url: ../../public
---

# 6.5.3 QQ 登錄：QQ 互聯平臺接入

## 一句話破題

QQ 登錄通過 QQ 互聯平臺接入，流程與標準 OAuth 2.0 一致，是國內接入門檻相對較低的社交登錄方式。

## 核心價值

接入 QQ 登錄能讓你：
- 覆蓋 QQ 生態的用戶羣體
- 相比微信，個人開發者也能申請
- 熟悉標準 OAuth 2.0 流程

## 快速上手

### 前置條件

1. 註冊 [QQ 互聯](https://connect.qq.com/) 開發者賬號
2. 創建應用，配置回調地址
3. 獲取 APP ID 和 APP Key

### 實現代碼

```typescript
// app/api/auth/qq/route.ts
export async function GET() {
  const state = generateSecureState()
  
  const params = new URLSearchParams({
    response_type: 'code',
    client_id: process.env.QQ_APP_ID!,
    redirect_uri: 'https://your-site.com/api/auth/qq/callback',
    state,
    scope: 'get_user_info',
  })
  
  return Response.redirect(
    `https://graph.qq.com/oauth2.0/authorize?${params}`
  )
}
```

```typescript
// app/api/auth/qq/callback/route.ts
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const code = searchParams.get('code')
  const state = searchParams.get('state')
  
  if (!verifyState(state)) {
    return Response.redirect('/login?error=invalid_state')
  }
  
  // 1. 用 code 換 access_token
  const tokenRes = await fetch(
    `https://graph.qq.com/oauth2.0/token?` +
    `grant_type=authorization_code` +
    `&client_id=${process.env.QQ_APP_ID}` +
    `&client_secret=${process.env.QQ_APP_KEY}` +
    `&code=${code}` +
    `&redirect_uri=${encodeURIComponent('https://your-site.com/api/auth/qq/callback')}`
  )
  
  // QQ 返回的是 query string 格式
  const tokenText = await tokenRes.text()
  const tokenParams = new URLSearchParams(tokenText)
  const accessToken = tokenParams.get('access_token')
  
  // 2. 獲取 OpenID
  const openidRes = await fetch(
    `https://graph.qq.com/oauth2.0/me?access_token=${accessToken}`
  )
  const openidText = await openidRes.text()
  // 返回格式: callback( {"client_id":"...","openid":"..."} );
  const openidJson = JSON.parse(openidText.match(/\{.*\}/)?.[0] || '{}')
  const openid = openidJson.openid
  
  // 3. 獲取用戶信息
  const userRes = await fetch(
    `https://graph.qq.com/user/get_user_info?` +
    `access_token=${accessToken}` +
    `&oauth_consumer_key=${process.env.QQ_APP_ID}` +
    `&openid=${openid}`
  )
  
  const userInfo = await userRes.json()
  
  // 4. 創建或關聯用戶
  const user = await findOrCreateUser({
    qqOpenid: openid,
    nickname: userInfo.nickname,
    avatar: userInfo.figureurl_qq_2 || userInfo.figureurl_qq_1,
  })
  
  await createSession(user)
  return Response.redirect('/dashboard')
}
```

## QQ 登錄的特殊之處

### 1. 返回格式非標準 JSON

QQ 的某些接口返回的不是標準 JSON，需要特殊處理：

```typescript
// access_token 返回格式
access_token=xxx&expires_in=7776000&refresh_token=xxx

// me 接口返回格式
callback( {"client_id":"xxx","openid":"xxx"} );
```

### 2. 沒有 unionid

QQ 登錄目前不提供類似微信 unionid 的跨應用統一標識，只有 openid。

## 避坑指南

::: danger 新手最容易犯的錯
1. 沒有正確解析非標準 JSON 響應
2. 回調地址必須與註冊時完全一致（包括協議）
3. scope 參數使用下劃線：`get_user_info`
:::
