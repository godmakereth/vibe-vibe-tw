---
title: "6.4.4 同源策略：瀏覽器安全基礎"
typora-root-url: ../../public
---

# 6.4.4 同源策略：瀏覽器安全基礎

## 一句話破題

同源策略是瀏覽器的默認安全機制：**只有來自同一個"源"的腳本，才能讀取對方的數據**。它是 Web 安全的第一道防線。

## 核心價值

理解同源策略能讓你：
- 明白爲什麼需要 CORS
- 理解前後端分離時的跨域問題
- 知道哪些操作會被瀏覽器阻止

## 什麼是"同源"？

一個 URL 由協議、域名、端口組成。只有三者完全相同，纔算"同源"。

| URL A | URL B | 是否同源 | 原因 |
|-------|-------|----------|------|
| `https://example.com` | `https://example.com/page` | ✅ 同源 | 路徑不影響 |
| `https://example.com` | `http://example.com` | ❌ 不同源 | 協議不同 |
| `https://example.com` | `https://api.example.com` | ❌ 不同源 | 域名不同 |
| `https://example.com` | `https://example.com:8080` | ❌ 不同源 | 端口不同 |

## 同源策略限制什麼？

### 被限制的操作

```javascript
// ❌ 不能讀取跨域請求的響應
fetch('https://other-site.com/api')
  .then(res => res.json())  // 被阻止

// ❌ 不能讀取跨域 iframe 的內容
const iframe = document.querySelector('iframe')
iframe.contentDocument  // 被阻止

// ❌ 不能讀取跨域頁面的 Cookie/Storage
localStorage.getItem('other-site-data')  // 只能讀本站的
```

### 不被限制的操作

```html
<!-- ✅ 可以加載跨域資源 -->
<img src="https://other-site.com/image.png" />
<script src="https://cdn.example.com/lib.js"></script>
<link href="https://fonts.googleapis.com/css" rel="stylesheet" />

<!-- ✅ 可以發送跨域請求（但不能讀響應） -->
<form action="https://other-site.com/submit" method="POST">
```

## 繞過同源策略的合法方式

### 1. CORS（推薦）

服務端返回允許跨域的響應頭：

```http
Access-Control-Allow-Origin: https://your-site.com
```

### 2. 代理

通過同源的服務端轉發請求：

```typescript
// 前端請求同源 API
fetch('/api/proxy?url=https://other-site.com/data')

// 服務端代理轉發
export async function GET(request: Request) {
  const url = new URL(request.url).searchParams.get('url')
  const res = await fetch(url!)
  return Response.json(await res.json())
}
```

### 3. JSONP（過時）

利用 `<script>` 標籤不受同源限制的特性，現已不推薦使用。

## 避坑指南

::: tip 開發時的常見困惑
**問題**：本地開發時 `localhost:3000` 調用 `localhost:8000` 的 API 被阻止

**原因**：端口不同 = 不同源

**解決**：
1. 後端配置 CORS 允許 `localhost:3000`
2. 或使用 Next.js 的 API Routes 作爲代理
:::
