---
title: "6.4.5 輸入驗證：防止注入攻擊"
typora-root-url: ../../public
---

# 6.4.5 輸入驗證：防止注入攻擊

## 一句話破題

注入攻擊的本質是：**攻擊者的輸入被當作代碼執行了**。防禦的關鍵是：把數據和代碼嚴格分開。

## 核心價值

掌握輸入驗證能讓你：
- 防止 SQL 注入導致數據泄露
- 防止命令注入導致服務器被控
- 通過安全審計

## 快速上手

### 使用 Zod 驗證輸入

```typescript
import { z } from 'zod'

const UserSchema = z.object({
  email: z.string().email(),
  name: z.string().min(1).max(100),
  age: z.number().int().min(0).max(150),
})

export async function POST(request: Request) {
  const body = await request.json()
  
  const result = UserSchema.safeParse(body)
  if (!result.success) {
    return Response.json({ error: result.error.issues }, { status: 400 })
  }
  
  // 使用 result.data，類型安全
}
```

### 使用 Prisma 防止 SQL 注入

```typescript
// ✅ 安全：Prisma 自動參數化
const user = await prisma.user.findUnique({
  where: { email: userInput }
})

// ✅ 安全：使用 $queryRaw 的模板字符串
const users = await prisma.$queryRaw`
  SELECT * FROM users WHERE name = ${userInput}
`

// ❌ 危險：使用 $queryRawUnsafe
const users = await prisma.$queryRawUnsafe(
  `SELECT * FROM users WHERE name = '${userInput}'`
)
```

### 常見驗證規則

```typescript
const schemas = {
  // ID 格式
  id: z.string().uuid(),
  
  // 只允許字母數字
  slug: z.string().regex(/^[a-zA-Z0-9-]+$/),
  
  // 手機號
  phone: z.string().regex(/^1[3-9]\d{9}$/),
  
  // 限制長度
  bio: z.string().max(500),
  
  // 枚舉值
  role: z.enum(['user', 'admin', 'editor']),
  
  // 數字範圍
  page: z.coerce.number().int().min(1).default(1),
}
```

### 文件上傳驗證

```typescript
const allowedTypes = ['image/jpeg', 'image/png', 'image/webp']
const maxSize = 5 * 1024 * 1024 // 5MB

export async function POST(request: Request) {
  const formData = await request.formData()
  const file = formData.get('file') as File
  
  if (!allowedTypes.includes(file.type)) {
    return Response.json({ error: '不支持的文件類型' }, { status: 400 })
  }
  
  if (file.size > maxSize) {
    return Response.json({ error: '文件太大' }, { status: 400 })
  }
  
  // 處理上傳
}
```

## 避坑指南

::: danger 新手最容易犯的錯
1. 只在前端驗證，後端不驗證——前端驗證可以被繞過
2. 使用正則匹配"危險字符"——容易遺漏，應該用白名單
3. 拼接 SQL 語句——永遠使用參數化查詢
4. 信任文件擴展名——應該驗證 MIME 類型
:::
