---
title: "6.1.4 用戶登錄狀態怎麼保持——會話管理：用戶狀態持久化與路由保護"
typora-root-url: ../../public
---

# 6.1.4 用戶登錄狀態怎麼保持——會話管理

## 本質還原

用戶登錄後，服務器需要一種方式來"記住"這個用戶。這就是**會話（Session）**的作用。NextAuth 提供了兩種會話策略：

```mermaid
flowchart LR
    subgraph JWT["JWT 策略"]
        J1["用戶登錄"] --> J2["生成 JWT"]
        J2 --> J3["存儲在 Cookie"]
        J3 --> J4["每次請求攜帶"]
        J4 --> J5["服務端驗證簽名"]
    end
    
    subgraph DB["Database 策略"]
        D1["用戶登錄"] --> D2["創建 Session 記錄"]
        D2 --> D3["Session ID 存 Cookie"]
        D3 --> D4["每次請求攜帶"]
        D4 --> D5["服務端查詢數據庫"]
    end
```

## JWT vs Database 策略對比

| 特性 | JWT | Database |
|------|-----|----------|
| 無狀態 | ✅ 服務端不存儲 | ❌ 需要數據庫 |
| 可擴展性 | ✅ 更好 | ⚠️ 需要共享存儲 |
| 即時失效 | ❌ 無法立即失效 | ✅ 刪除記錄即可 |
| 配置複雜度 | 簡單 | 需要 Adapter |

**推薦**：對於大多數應用，使用 JWT 策略即可。

## 配置 SessionProvider

要在客戶端組件中使用 `useSession`，必須用 `SessionProvider` 包裹應用：

```typescript
// app/providers.tsx
"use client"

import { SessionProvider } from "next-auth/react"

export function Providers({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>
}
```

```typescript
// app/layout.tsx
import { Providers } from "./providers"

export default function RootLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <html>
      <body>
        <Providers>{children}</Providers>
      </body>
    </html>
  )
}
```

## 在客戶端獲取 Session

```typescript
"use client"

import { useSession } from "next-auth/react"

export function UserProfile() {
  const { data: session, status } = useSession()

  if (status === "loading") {
    return <div>加載中...</div>
  }

  if (status === "unauthenticated") {
    return <div>請先登錄</div>
  }

  return (
    <div>
      <p>歡迎, {session?.user?.name}</p>
      <p>郵箱: {session?.user?.email}</p>
    </div>
  )
}
```

## 在服務端獲取 Session

### Server Component

```typescript
// app/dashboard/page.tsx
import { getServerSession } from "next-auth"
import { authOptions } from "@/app/api/auth/[...nextauth]/route"
import { redirect } from "next/navigation"

export default async function DashboardPage() {
  const session = await getServerSession(authOptions)

  if (!session) {
    redirect("/login")
  }

  return <div>歡迎, {session.user?.name}</div>
}
```

### API Route

```typescript
// app/api/user/route.ts
import { getServerSession } from "next-auth"
import { authOptions } from "@/app/api/auth/[...nextauth]/route"
import { NextResponse } from "next/server"

export async function GET() {
  const session = await getServerSession(authOptions)

  if (!session) {
    return NextResponse.json({ error: "未授權" }, { status: 401 })
  }

  return NextResponse.json({ user: session.user })
}
```

## 路由保護

### 方式一：頁面級保護

```typescript
// app/dashboard/page.tsx
import { getServerSession } from "next-auth"
import { authOptions } from "@/app/api/auth/[...nextauth]/route"
import { redirect } from "next/navigation"

export default async function DashboardPage() {
  const session = await getServerSession(authOptions)

  if (!session) {
    redirect("/login")
  }

  return <div>受保護的內容</div>
}
```

### 方式二：Middleware 保護

```typescript
// middleware.ts
import { withAuth } from "next-auth/middleware"

export default withAuth({
  pages: {
    signIn: "/login",
  },
})

export const config = {
  matcher: ["/dashboard/:path*", "/profile/:path*"],
}
```

### 方式三：自定義 Middleware

```typescript
// middleware.ts
import { getToken } from "next-auth/jwt"
import { NextResponse } from "next/server"
import type { NextRequest } from "next/server"

export async function middleware(request: NextRequest) {
  const token = await getToken({
    req: request,
    secret: process.env.NEXTAUTH_SECRET,
  })

  const isAuthPage = request.nextUrl.pathname.startsWith("/login")

  if (isAuthPage) {
    if (token) {
      return NextResponse.redirect(new URL("/dashboard", request.url))
    }
    return NextResponse.next()
  }

  if (!token) {
    return NextResponse.redirect(new URL("/login", request.url))
  }

  return NextResponse.next()
}

export const config = {
  matcher: ["/dashboard/:path*", "/login"],
}
```

## 自定義 Session 數據

默認 session 只包含 `name`、`email`、`image`。如需添加更多字段：

```typescript
// types/next-auth.d.ts
import { DefaultSession } from "next-auth"

declare module "next-auth" {
  interface Session {
    user: {
      id: string
      role: string
    } & DefaultSession["user"]
  }
}
```

```typescript
// NextAuth 配置
callbacks: {
  async jwt({ token, user }) {
    if (user) {
      token.id = user.id
      token.role = "user" // 或從數據庫獲取
    }
    return token
  },
  async session({ session, token }) {
    if (session.user) {
      session.user.id = token.id as string
      session.user.role = token.role as string
    }
    return session
  },
}
```

## 會話配置選項

```typescript
session: {
  strategy: "jwt",
  maxAge: 30 * 24 * 60 * 60, // 30 天
  updateAge: 24 * 60 * 60,   // 24 小時刷新一次
}
```

::: tip 安全建議
- 生產環境中，`maxAge` 不要設置過長
- 敏感操作前，考慮要求用戶重新驗證身份
- 定期輪換 `NEXTAUTH_SECRET`
:::
