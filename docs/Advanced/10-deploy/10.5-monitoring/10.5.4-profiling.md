---
title: "10.5.4 性能瓶頸在哪——性能分析：響應時間與資源使用監控"
typora-root-url: ../../public
---

# 10.5.4 性能瓶頸在哪——性能分析：響應時間與資源使用監控

用戶說"慢"，你要能說出具體慢在哪。

## 性能指標

### 用戶體驗指標

| 指標 | 說明 | 目標值 |
|------|------|--------|
| TTFB | 首字節時間 | < 200ms |
| FCP | 首次內容繪製 | < 1.8s |
| LCP | 最大內容繪製 | < 2.5s |
| TTI | 可交互時間 | < 3.8s |

### 服務端指標

| 指標 | 說明 | 目標值 |
|------|------|--------|
| 響應時間 | API 平均響應時間 | < 200ms |
| P95 延遲 | 95% 請求的最大延遲 | < 500ms |
| P99 延遲 | 99% 請求的最大延遲 | < 1s |
| 吞吐量 | 每秒處理請求數 | 根據業務 |

## 響應時間監控

### 請求計時中間件

```typescript
// NestJS 中間件
@Injectable()
export class TimingMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    const start = Date.now();
    
    res.on('finish', () => {
      const duration = Date.now() - start;
      
      console.log(JSON.stringify({
        level: 'info',
        event: 'request_completed',
        method: req.method,
        path: req.path,
        status: res.statusCode,
        duration,
        slow: duration > 1000,  // 標記慢請求
      }));
      
      // 慢請求告警
      if (duration > 3000) {
        this.alertSlowRequest(req.path, duration);
      }
    });
    
    next();
  }
}
```

### 數據庫查詢監控

```typescript
// Prisma 查詢日誌
const prisma = new PrismaClient({
  log: [
    { emit: 'event', level: 'query' },
  ],
});

prisma.$on('query', (e) => {
  if (e.duration > 100) {  // 慢查詢閾值 100ms
    console.log(JSON.stringify({
      level: 'warn',
      event: 'slow_query',
      query: e.query,
      params: e.params,
      duration: e.duration,
    }));
  }
});
```

## 資源使用監控

### 內存監控

```typescript
// 定期記錄內存使用
setInterval(() => {
  const usage = process.memoryUsage();
  
  console.log(JSON.stringify({
    level: 'info',
    event: 'memory_usage',
    heapUsed: Math.round(usage.heapUsed / 1024 / 1024),  // MB
    heapTotal: Math.round(usage.heapTotal / 1024 / 1024),
    rss: Math.round(usage.rss / 1024 / 1024),
  }));
  
  // 內存泄漏警告
  if (usage.heapUsed > 500 * 1024 * 1024) {  // > 500MB
    console.warn('High memory usage detected');
  }
}, 60000);  // 每分鐘
```

### CPU 監控

```typescript
import * as os from 'os';

function getCpuUsage() {
  const cpus = os.cpus();
  let totalIdle = 0, totalTick = 0;
  
  cpus.forEach(cpu => {
    for (const type in cpu.times) {
      totalTick += cpu.times[type];
    }
    totalIdle += cpu.times.idle;
  });
  
  return 1 - totalIdle / totalTick;
}
```

## 性能分析工具

### Node.js 內置工具

```bash
# 啓動時開啓性能分析
node --prof app.js

# 生成可讀報告
node --prof-process isolate-*.log > profile.txt
```

### Chrome DevTools

```typescript
// 在開發環境啓用調試
if (process.env.NODE_ENV === 'development') {
  require('inspector').open(9229, 'localhost', true);
}
```

### 火焰圖

```bash
# 使用 0x 生成火焰圖
npx 0x app.js

# 打開生成的 HTML 文件查看火焰圖
```

## 常見性能問題

### N+1 查詢問題

```typescript
// 問題代碼 - N+1 查詢
const users = await prisma.user.findMany();
for (const user of users) {
  const orders = await prisma.order.findMany({
    where: { userId: user.id }
  });
}

// 優化後 - 使用 include
const users = await prisma.user.findMany({
  include: { orders: true }
});
```

### 內存泄漏

```typescript
// 問題代碼 - 事件監聽器泄漏
class Service {
  constructor() {
    eventEmitter.on('data', this.handleData);  // 每次實例化都添加
  }
}

// 優化後 - 清理監聽器
class Service {
  constructor() {
    eventEmitter.on('data', this.handleData);
  }
  
  destroy() {
    eventEmitter.off('data', this.handleData);
  }
}
```

### 同步阻塞

```typescript
// 問題代碼 - 同步文件操作
const data = fs.readFileSync('large-file.txt');

// 優化後 - 異步操作
const data = await fs.promises.readFile('large-file.txt');
```

## 性能優化清單

### 數據庫層

- [ ] 添加必要的索引
- [ ] 使用 `include` 代替多次查詢
- [ ] 分頁查詢大數據集
- [ ] 使用 Redis 緩存熱點數據

### 應用層

- [ ] 啓用 Gzip 壓縮
- [ ] 使用連接池
- [ ] 避免同步操作
- [ ] 優化大循環

### 網絡層

- [ ] 使用 CDN
- [ ] 啓用 HTTP/2
- [ ] 合理設置緩存頭
- [ ] 圖片壓縮/WebP

## 壓力測試

### 使用 k6

```javascript
// load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  vus: 100,         // 100 個虛擬用戶
  duration: '30s',  // 持續 30 秒
};

export default function() {
  const res = http.get('http://localhost:3000/api/health');
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 200ms': (r) => r.timings.duration < 200,
  });
  
  sleep(1);
}
```

```bash
# 運行測試
k6 run load-test.js
```

### 使用 wrk

```bash
# 簡單壓測
wrk -t12 -c400 -d30s http://localhost:3000/api/health

# 輸出示例
Running 30s test @ http://localhost:3000/api/health
  12 threads and 400 connections
  Thread Stats   Avg      Stdev     Max   +/- Stdev
    Latency    50ms    10ms    200ms   85%
    Req/Sec   500      50       600    90%
  Requests/sec: 6000
```

## 性能基準

| 規模 | 預期 QPS | 響應時間 |
|------|----------|----------|
| 小型項目 | 100-500 | < 200ms |
| 中型項目 | 500-2000 | < 100ms |
| 大型項目 | 2000+ | < 50ms |

## 常見問題

| 問題 | 可能原因 | 解決方案 |
|------|----------|----------|
| 響應時間波動大 | GC 暫停/慢查詢 | 優化內存使用/添加索引 |
| CPU 持續高 | 密集計算/死循環 | 火焰圖分析定位 |
| 內存持續增長 | 內存泄漏 | 堆快照分析 |
| 偶發超時 | 連接池耗盡 | 增加連接池大小 |
