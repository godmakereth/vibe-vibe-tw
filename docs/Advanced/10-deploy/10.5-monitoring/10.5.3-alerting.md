---
title: "10.5.3 ä¸€å‡ºéŒ¯å°±é€šçŸ¥æˆ‘â€”â€”éŒ¯èª¤è¿½è¹¤ï¼šç•°å¸¸æ•ç²èˆ‡å‘Šè­¦æ©Ÿåˆ¶"
typora-root-url: ../../public
---

# 10.5.3 ä¸€å‡ºéŒ¯å°±é€šçŸ¥æˆ‘â€”â€”éŒ¯èª¤è¿½è¹¤ï¼šç•°å¸¸æ•ç²èˆ‡å‘Šè­¦æ©Ÿåˆ¶

éŒ¯èª¤ç™¼ç”Ÿäº†ä¸å¯æ€•ï¼Œå¯æ€•çš„æ˜¯ä½ ä¸çŸ¥é“ã€‚

## éŒ¯èª¤è¿½è¹¤ vs æ—¥èªŒ

| å°æ¯”é … | æ—¥èªŒ | éŒ¯èª¤è¿½è¹¤ |
|--------|------|----------|
| ä¿¡æ¯é‡ | ä¸€è¡Œæ–‡æœ¬ | å®Œæ•´ä¸Šä¸‹æ–‡ |
| å †æ£§ | å¯èƒ½æœ‰ | å®Œæ•´å †æ£§ |
| èšåˆ | ç„¡ | ç›¸åŒéŒ¯èª¤è‡ªå‹•èšåˆ |
| é€šçŸ¥ | éœ€è¦é¡å¤–é…ç½® | å…§ç½®å‘Šè­¦ |
| ç”¨æˆ¶ä¿¡æ¯ | æ‰‹å‹•è¨˜éŒ„ | è‡ªå‹•é—œè¯ |

## Sentry é›†æˆ

Sentry æ˜¯æœ€æµè¡Œçš„éŒ¯èª¤è¿½è¹¤æœå‹™ï¼Œå…è²»ç‰ˆå¤ ç”¨ã€‚

### å¾Œç«¯é›†æˆï¼ˆNestJSï¼‰

```bash
npm install @sentry/node
```

```typescript
// main.ts
import * as Sentry from '@sentry/node';

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 0.1,  // æ¡æ¨£ 10% çš„è«‹æ±‚
});

// å…¨å±€ç•°å¸¸éæ¿¾å™¨
@Catch()
export class SentryExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    Sentry.captureException(exception);
    
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    
    response.status(500).json({
      message: 'Internal server error',
    });
  }
}
```

### å‰ç«¯é›†æˆï¼ˆNext.jsï¼‰

```bash
npm install @sentry/nextjs
npx @sentry/wizard@latest -i nextjs
```

```typescript
// sentry.client.config.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  tracesSampleRate: 0.1,
});
```

### æ•ç²è‡ªå®šç¾©éŒ¯èª¤

```typescript
try {
  await processPayment(order);
} catch (error) {
  Sentry.captureException(error, {
    extra: {
      orderId: order.id,
      amount: order.total,
    },
    tags: {
      payment_gateway: 'stripe',
    },
    user: {
      id: user.id,
      email: user.email,
    },
  });
  throw error;
}
```

## å‘Šè­¦é…ç½®

### å‘Šè­¦æ¸ é“

| æ¸ é“ | å„ªé» | ç¼ºé» |
|------|------|------|
| éƒµä»¶ | è©³ç´°ã€å¯è¿½æº¯ | å®¹æ˜“è¢«å¿½ç•¥ |
| é‡˜é‡˜/é£›æ›¸ | å³æ™‚ã€åœ˜éšŠå¯è¦‹ | å¯èƒ½æ‰“æ“¾ |
| çŸ­ä¿¡ | ç·Šæ€¥é€šçŸ¥ | æˆæœ¬é«˜ |
| é›»è©± | æœ€ç·Šæ€¥ | æˆæœ¬æœ€é«˜ |

### é‡˜é‡˜æ©Ÿå™¨äººå‘Šè­¦

```typescript
async function sendDingTalkAlert(message: string) {
  const webhook = process.env.DINGTALK_WEBHOOK;
  
  await fetch(webhook, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      msgtype: 'markdown',
      markdown: {
        title: 'æœå‹™å‘Šè­¦',
        text: `## æœå‹™å‘Šè­¦\n\n${message}\n\næ™‚é–“ï¼š${new Date().toLocaleString()}`,
      },
    }),
  });
}
```

### é£›æ›¸æ©Ÿå™¨äººå‘Šè­¦

```typescript
async function sendFeishuAlert(title: string, content: string) {
  const webhook = process.env.FEISHU_WEBHOOK;
  
  await fetch(webhook, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      msg_type: 'interactive',
      card: {
        header: {
          title: { content: title, tag: 'plain_text' },
          template: 'red',
        },
        elements: [{
          tag: 'div',
          text: { content, tag: 'plain_text' },
        }],
      },
    }),
  });
}
```

## å‘Šè­¦è¦å‰‡è¨­è¨ˆ

### åˆ†ç´šå‘Šè­¦

```mermaid
flowchart TB
    A[éŒ¯èª¤ç™¼ç”Ÿ] --> B{éŒ¯èª¤ç´šåˆ¥?}
    B -->|P0 ç·Šæ€¥| C[é›»è©± + çŸ­ä¿¡ + ç¾£æ¶ˆæ¯]
    B -->|P1 é‡è¦| D[çŸ­ä¿¡ + ç¾£æ¶ˆæ¯]
    B -->|P2 ä¸€èˆ¬| E[ç¾£æ¶ˆæ¯]
    B -->|P3 ä½å„ª| F[éƒµä»¶]
```

| ç´šåˆ¥ | å®šç¾© | éŸ¿æ‡‰æ™‚é–“ |
|------|------|----------|
| P0 | æœå‹™å®Œå…¨ä¸å¯ç”¨ | 5 åˆ†é˜ |
| P1 | æ ¸å¿ƒåŠŸèƒ½å—æ | 30 åˆ†é˜ |
| P2 | éæ ¸å¿ƒåŠŸèƒ½å•é¡Œ | 4 å°æ™‚ |
| P3 | ç”¨æˆ¶å¯æ¥å—çš„å•é¡Œ | 1 å¤© |

### é¿å…å‘Šè­¦ç–²å‹

```typescript
// éŒ¯èª¤èšåˆ - ç›¸åŒéŒ¯èª¤ 5 åˆ†é˜å…§åªå‘Šè­¦ä¸€æ¬¡
const alertCache = new Map<string, number>();

function shouldAlert(errorKey: string): boolean {
  const lastAlert = alertCache.get(errorKey);
  const now = Date.now();
  
  if (lastAlert && now - lastAlert < 5 * 60 * 1000) {
    return false;
  }
  
  alertCache.set(errorKey, now);
  return true;
}
```

## UptimeRobot å‘Šè­¦

### é…ç½®å‘Šè­¦è¯ç¹«äºº

1. è¨­ç½® â†’ Alert Contacts
2. æ·»åŠ è¯ç¹«æ–¹å¼ï¼š
   - Email
   - Webhookï¼ˆæ¨è–¦ï¼Œå¯é›†æˆé‡˜é‡˜/é£›æ›¸ï¼‰
   - Slack/Discord

### Webhook è½‰ç™¼åˆ°é‡˜é‡˜

```javascript
// æ¥æ”¶ UptimeRobot webhookï¼Œè½‰ç™¼åˆ°é‡˜é‡˜
app.post('/webhook/uptime', async (req, res) => {
  const { monitorFriendlyName, alertType, alertDetails } = req.body;
  
  const isDown = alertType === '1';
  const message = isDown 
    ? `ğŸ”´ æœå‹™å®•æ©Ÿï¼š${monitorFriendlyName}\n${alertDetails}`
    : `ğŸŸ¢ æœå‹™æ¢å¾©ï¼š${monitorFriendlyName}`;
  
  await sendDingTalkAlert(message);
  res.send('ok');
});
```

## éŒ¯èª¤è™•ç†æœ€ä½³å¯¦è¸

### å…¨å±€ç•°å¸¸è™•ç†

```typescript
// NestJS å…¨å±€ç•°å¸¸éæ¿¾å™¨
@Catch()
export class GlobalExceptionFilter implements ExceptionFilter {
  catch(exception: any, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();
    
    // è¨˜éŒ„éŒ¯èª¤
    console.error(JSON.stringify({
      level: 'error',
      message: exception.message,
      stack: exception.stack,
      path: request.url,
      method: request.method,
      userId: request.user?.id,
    }));
    
    // ç™¼é€åˆ° Sentry
    Sentry.captureException(exception);
    
    // è¿”å›ç”¨æˆ¶å‹å¥½çš„éŒ¯èª¤
    response.status(500).json({
      statusCode: 500,
      message: 'Something went wrong',
    });
  }
}
```

### ä¸è¦æš´éœ²æ•æ„Ÿä¿¡æ¯

```typescript
// éŒ¯èª¤çš„åšæ³•
res.status(500).json({ error: exception.message }); // å¯èƒ½æ³„éœ²æ•¸æ“šåº«ä¿¡æ¯

// æ­£ç¢ºçš„åšæ³•
res.status(500).json({ message: 'Internal server error' });
```

## å¸¸è¦‹å•é¡Œ

| å•é¡Œ | åŸå›  | è§£æ±ºæ–¹æ¡ˆ |
|------|------|----------|
| å‘Šè­¦å¤ªå¤š | é–¾å€¼å¤ªæ•æ„Ÿ | èª¿æ•´é–¾å€¼ï¼ŒéŒ¯èª¤èšåˆ |
| å‘Šè­¦å¤ªå°‘ | éŒ¯èª¤æœªæ•ç² | å®Œå–„å…¨å±€ç•°å¸¸è™•ç† |
| å‘Šè­¦å»¶é² | æª¢æŸ¥é–“éš”å¤ªé•· | ç¸®çŸ­æª¢æŸ¥é–“éš” |
| é‡è¤‡å‘Šè­¦ | æœªåšå»é‡ | æ·»åŠ å‘Šè­¦èšåˆé‚è¼¯ |
