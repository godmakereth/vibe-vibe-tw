---
title: "10.2.2 部署到底要填什麼——配置要素：鏡像/啓動命令/端口/卷/環境變量"
typora-root-url: ../../public
---

# 10.2.2 部署到底要填什麼——配置要素：鏡像/啓動命令/端口/卷/環境變量

Docker 配置看起來複雜，其實就五個核心要素。

## 五大核心配置要素

```mermaid
flowchart TB
    A[Docker 容器配置] --> B[鏡像]
    A --> C[端口映射]
    A --> D[卷掛載]
    A --> E[環境變量]
    A --> F[啓動命令]
    
    B --> B1[用什麼軟件包]
    C --> C1[怎麼訪問容器]
    D --> D1[數據存在哪]
    E --> E1[運行時參數]
    F --> F1[啓動時幹什麼]
```

## 1. 鏡像（Image）

鏡像是容器的"安裝包"，包含了運行應用所需的一切：代碼、運行時、庫、配置文件。

### 鏡像命名規則

```
[倉庫地址/]鏡像名[:標籤]
```

| 示例 | 說明 |
|------|------|
| `node:18` | Docker Hub 官方 Node.js 18 |
| `node:18-alpine` | 輕量版，體積更小 |
| `postgres:15` | PostgreSQL 15 |
| `my-app:v1.0.0` | 自定義應用指定版本 |

### 鏡像選擇建議

| 場景 | 推薦鏡像 | 理由 |
|------|----------|------|
| Node.js 應用 | `node:18-alpine` | 體積小（~120MB vs ~1GB） |
| Python 應用 | `python:3.11-slim` | 精簡版，夠用 |
| 生產數據庫 | `postgres:15` | 穩定版本 |

## 2. 端口映射（Port Mapping）

端口映射讓外部能夠訪問容器內的服務。

### 格式說明

```
宿主機端口:容器端口
```

| 配置 | 含義 |
|------|------|
| `3000:3000` | 用 3000 訪問容器的 3000 端口 |
| `8080:3000` | 用 8080 訪問容器的 3000 端口 |
| `127.0.0.1:3000:3000` | 只允許本機訪問 |

### 常見端口規劃

| 服務 | 容器端口 | 建議宿主機端口 |
|------|----------|----------------|
| Next.js | 3000 | 3000 |
| NestJS | 3001 | 3001 |
| PostgreSQL | 5432 | 5432 |
| Redis | 6379 | 6379 |
| Nginx | 80/443 | 80/443 |

::: warning 端口衝突
同一宿主機端口只能被一個容器佔用。如果端口已被佔用，需要修改映射端口。
:::

## 3. 卷掛載（Volume Mount）

容器刪除後，裏面的數據默認會丟失。卷掛載將數據保存到宿主機。

### 格式說明

```
宿主機路徑:容器路徑[:權限]
```

| 配置 | 含義 |
|------|------|
| `/data/postgres:/var/lib/postgresql/data` | 數據庫文件持久化 |
| `/app/logs:/app/logs` | 日誌文件持久化 |
| `/config:/app/config:ro` | 只讀掛載配置文件 |

### 必須掛載的數據

| 服務 | 容器路徑 | 數據類型 |
|------|----------|----------|
| PostgreSQL | `/var/lib/postgresql/data` | 數據庫文件 |
| MySQL | `/var/lib/mysql` | 數據庫文件 |
| Redis | `/data` | 持久化數據 |
| 應用 | `/app/uploads` | 用戶上傳文件 |
| 應用 | `/app/logs` | 日誌文件 |

## 4. 環境變量（Environment Variables）

環境變量是傳遞配置給應用的標準方式，比硬編碼更安全、更靈活。

### 常用環境變量

| 變量名 | 作用 | 示例值 |
|--------|------|--------|
| `NODE_ENV` | 運行環境 | `production` |
| `DATABASE_URL` | 數據庫連接串 | `postgresql://user:pass@host:5432/db` |
| `REDIS_URL` | Redis 連接串 | `redis://localhost:6379` |
| `JWT_SECRET` | JWT 密鑰 | `your-secret-key` |
| `PORT` | 應用監聽端口 | `3000` |

### 環境變量安全實踐

```mermaid
flowchart LR
    A[敏感信息] --> B{存放位置}
    B -->|開發環境| C[.env.local 文件]
    B -->|生產環境| D[1Panel 環境變量]
    B -->|團隊協作| E[密鑰管理服務]
    
    style C fill:#ffffcc
    style D fill:#ccffcc
    style E fill:#ccccff
```

::: danger 安全警告
絕對不要在代碼倉庫中提交真實的數據庫密碼、API 密鑰等敏感信息！
:::

## 5. 啓動命令（Command）

啓動命令決定容器啓動後執行什麼操作。

### 常見啓動命令

| 應用類型 | 啓動命令 |
|----------|----------|
| Next.js 生產 | `npm run start` 或 `node server.js` |
| NestJS 生產 | `node dist/main.js` |
| 開發調試 | `npm run dev`（不推薦生產使用） |

### Dockerfile 中的 CMD vs ENTRYPOINT

| 指令 | 特點 |
|------|------|
| `CMD` | 可被運行時命令覆蓋 |
| `ENTRYPOINT` | 固定執行，運行時參數追加 |

## 完整配置示例

以 Next.js 應用爲例：

```yaml
# docker-compose.yml 等效配置
services:
  nextjs:
    image: node:18-alpine
    container_name: my-nextjs-app
    ports:
      - "3000:3000"
    volumes:
      - ./app:/app
      - /app/node_modules  # 排除 node_modules
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/mydb
    command: npm run start
    restart: always
```

對應 1Panel 配置：

| 配置項 | 值 |
|--------|-----|
| 鏡像 | `node:18-alpine` |
| 容器名 | `my-nextjs-app` |
| 端口 | `3000:3000` |
| 掛載 | `./app:/app` |
| 環境變量 | `NODE_ENV=production` |
| 命令 | `npm run start` |
| 重啓策略 | `always` |

## 配置驗證清單

部署前檢查：

- [ ] 鏡像版本是否正確
- [ ] 端口是否衝突
- [ ] 數據目錄是否掛載
- [ ] 敏感信息是否使用環境變量
- [ ] 重啓策略是否設置爲 always
