---
title: "10.2.4 NestJS 項目怎麼部署——NestJS 部署示例：API 服務與數據庫連接"
typora-root-url: ../../public
---

# 10.2.4 NestJS 項目怎麼部署——NestJS 部署示例：API 服務與數據庫連接

NestJS 部署的核心：編譯 TypeScript，連接數據庫。

## 部署流程概覽

```mermaid
flowchart LR
    A[TypeScript源碼] --> B[編譯爲JS]
    B --> C[構建Docker鏡像]
    C --> D[部署到服務器]
    D --> E[連接數據庫]
    E --> F[運行遷移]
    F --> G[服務就緒]
```

## 步驟一：編寫 Dockerfile

在項目根目錄創建 `Dockerfile`：

```dockerfile
# 構建階段
FROM node:18-alpine AS builder
WORKDIR /app

# 安裝依賴
COPY package*.json ./
RUN npm ci

# 複製源碼並編譯
COPY . .
RUN npm run build

# 生產階段
FROM node:18-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# 只複製生產依賴
COPY package*.json ./
RUN npm ci --only=production

# 複製編譯產物
COPY --from=builder /app/dist ./dist

# 複製 Prisma 相關文件（如果使用 Prisma）
COPY --from=builder /app/prisma ./prisma
RUN npx prisma generate

EXPOSE 3001
CMD ["node", "dist/main.js"]
```

### 與 Next.js Dockerfile 的區別

| 差異點 | Next.js | NestJS |
|--------|---------|--------|
| 輸出目錄 | `.next/standalone` | `dist` |
| 啓動命令 | `node server.js` | `node dist/main.js` |
| ORM 配置 | 通常無 | 需要 Prisma generate |
| 端口 | 3000 | 3001 |

## 步驟二：配置數據庫連接

### 環境變量設置

```env
# .env.production
DATABASE_URL="postgresql://user:password@postgres:5432/mydb?schema=public"
REDIS_URL="redis://redis:6379"
JWT_SECRET="your-production-secret"
PORT=3001
```

### 容器網絡配置

在 1Panel 中，確保 NestJS 容器和數據庫容器在同一網絡：

```mermaid
flowchart TB
    subgraph Docker網絡
        A[NestJS容器] --> B[PostgreSQL容器]
        A --> C[Redis容器]
    end
    D[外部請求] --> A
```

::: tip 容器間通信
在同一 Docker 網絡中，可以用**容器名**作爲主機名。例如數據庫容器名爲 `postgres`，連接地址就是 `postgres:5432`。
:::

## 步驟三：在 1Panel 中部署

### 容器配置

| 配置項 | 值 | 說明 |
|--------|-----|------|
| 鏡像 | `registry.cn-hangzhou.aliyuncs.com/xxx/my-nestjs-api:v1.0.0` | 完整鏡像地址 |
| 容器名 | `nestjs-api` | 便於識別 |
| 端口映射 | `3001:3001` | 外部:內部 |
| 網絡 | `1panel-network` | 與數據庫同網絡 |
| 重啓策略 | `always` | 崩潰自動重啓 |

### 環境變量配置

| 變量名 | 值 | 說明 |
|--------|-----|------|
| `NODE_ENV` | `production` | 生產模式 |
| `DATABASE_URL` | `postgresql://...` | 數據庫連接串 |
| `REDIS_URL` | `redis://redis:6379` | Redis 連接串 |
| `JWT_SECRET` | `xxx` | JWT 密鑰 |
| `PORT` | `3001` | 監聽端口 |

### 啓動順序配置

NestJS 依賴數據庫，需要確保數據庫先啓動：

```yaml
# docker-compose.yml 示例
services:
  api:
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
```

## 步驟四：數據庫遷移

### 方式一：啓動時自動遷移

修改啓動命令：

```dockerfile
CMD ["sh", "-c", "npx prisma migrate deploy && node dist/main.js"]
```

### 方式二：手動執行遷移

進入容器執行：

```bash
# 進入容器
docker exec -it nestjs-api sh

# 執行遷移
npx prisma migrate deploy

# 可選：執行種子數據
npx prisma db seed
```

::: warning 生產環境遷移注意
- 始終使用 `migrate deploy` 而非 `migrate dev`
- 遷移前備份數據庫
- 破壞性遷移需要維護窗口
:::

## 步驟五：配置反向代理

在 1Panel 的 **網站** 中配置 API 子域名：

| 配置項 | 值 |
|--------|-----|
| 域名 | `api.example.com` |
| 代理地址 | `127.0.0.1:3001` |
| HTTPS | 開啓 |

### Nginx 配置示例

```nginx
server {
    listen 443 ssl http2;
    server_name api.example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:3001;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 支持 WebSocket（如果需要）
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

## 健康檢查

### 添加健康檢查端點

```typescript
// src/health/health.controller.ts
@Controller('health')
export class HealthController {
  @Get()
  check() {
    return { status: 'ok', timestamp: new Date().toISOString() };
  }
}
```

### Docker 健康檢查配置

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3001/health || exit 1
```

## 常見問題

| 問題 | 原因 | 解決方案 |
|------|------|----------|
| 數據庫連接失敗 | 網絡不通或憑證錯誤 | 檢查容器網絡和環境變量 |
| Prisma Client 未生成 | 鏡像構建時未執行 generate | Dockerfile 中添加 `prisma generate` |
| 啓動超時 | 等待數據庫就緒 | 添加健康檢查和重試邏輯 |
| 內存不足 | Node.js 默認內存限制 | 設置 `NODE_OPTIONS=--max-old-space-size=2048` |

## AI 協作指南

向 AI 描述 NestJS 部署問題時：

```
我的 NestJS + Prisma 應用部署後無法連接數據庫，
使用 PostgreSQL，部署在 1Panel，
錯誤信息：Can't reach database server at 'postgres:5432'
請幫我排查原因。
```

**關鍵術語**：Prisma migrate deploy、Docker 網絡、容器間通信、健康檢查
