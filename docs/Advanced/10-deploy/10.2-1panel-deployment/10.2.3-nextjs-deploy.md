---
title: "10.2.3 Next.js 項目怎麼部署——Next.js 部署示例：生產構建與端口配置"
typora-root-url: ../../public
---

# 10.2.3 Next.js 項目怎麼部署——Next.js 部署示例：生產構建與端口配置

Next.js 部署的核心：先構建，後運行。

## 部署流程概覽

```mermaid
flowchart LR
    A[本地代碼] --> B[構建Docker鏡像]
    B --> C[推送到鏡像倉庫]
    C --> D[1Panel拉取鏡像]
    D --> E[配置並啓動]
    E --> F[反向代理]
    F --> G[用戶訪問]
```

## 步驟一：編寫 Dockerfile

在項目根目錄創建 `Dockerfile`：

```dockerfile
# 構建階段
FROM node:18-alpine AS builder
WORKDIR /app

# 安裝依賴
COPY package*.json ./
RUN npm ci

# 複製源碼並構建
COPY . .
RUN npm run build

# 生產階段
FROM node:18-alpine AS runner
WORKDIR /app

ENV NODE_ENV=production

# 複製構建產物
COPY --from=builder /app/.next/standalone ./
COPY --from=builder /app/.next/static ./.next/static
COPY --from=builder /app/public ./public

EXPOSE 3000
CMD ["node", "server.js"]
```

### 關鍵配置說明

| 配置 | 作用 |
|------|------|
| `AS builder` | 多階段構建，減小最終鏡像體積 |
| `npm ci` | 比 `npm install` 更快更可靠 |
| `standalone` | Next.js 13+ 的獨立輸出模式 |

### 啓用 Standalone 模式

在 `next.config.js` 中添加：

```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  output: 'standalone',
}

module.exports = nextConfig
```

## 步驟二：構建並推送鏡像

### 本地構建

```bash
# 構建鏡像
docker build -t my-nextjs-app:v1.0.0 .

# 測試運行
docker run -p 3000:3000 my-nextjs-app:v1.0.0
```

### 推送到鏡像倉庫

```bash
# 登錄阿里雲鏡像倉庫
docker login registry.cn-hangzhou.aliyuncs.com

# 打標籤
docker tag my-nextjs-app:v1.0.0 registry.cn-hangzhou.aliyuncs.com/your-namespace/my-nextjs-app:v1.0.0

# 推送
docker push registry.cn-hangzhou.aliyuncs.com/your-namespace/my-nextjs-app:v1.0.0
```

::: tip 鏡像倉庫選擇
- **阿里雲 ACR**：國內訪問快，免費額度
- **騰訊雲 TCR**：與騰訊雲服務集成好
- **Docker Hub**：國際通用，國內訪問慢
:::

## 步驟三：在 1Panel 中部署

### 創建容器配置

| 配置項 | 值 | 說明 |
|--------|-----|------|
| 鏡像 | `registry.cn-hangzhou.aliyuncs.com/xxx/my-nextjs-app:v1.0.0` | 完整鏡像地址 |
| 容器名 | `nextjs-frontend` | 便於識別 |
| 端口映射 | `3000:3000` | 外部:內部 |
| 重啓策略 | `always` | 崩潰自動重啓 |

### 環境變量配置

| 變量名 | 值 | 說明 |
|--------|-----|------|
| `NODE_ENV` | `production` | 生產模式 |
| `NEXT_PUBLIC_API_URL` | `https://api.example.com` | 後端 API 地址 |

### 健康檢查配置

| 配置項 | 值 |
|--------|-----|
| 檢查方式 | HTTP GET |
| 路徑 | `/api/health` 或 `/` |
| 端口 | `3000` |
| 間隔 | `30s` |
| 超時 | `10s` |

## 步驟四：配置反向代理

在 1Panel 的 **網站** → **網站** 中創建反向代理：

| 配置項 | 值 |
|--------|-----|
| 域名 | `www.example.com` |
| 代理地址 | `127.0.0.1:3000` |
| HTTPS | 開啓，申請免費證書 |

### Nginx 配置示例

```nginx
server {
    listen 80;
    server_name www.example.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name www.example.com;
    
    ssl_certificate /path/to/cert.pem;
    ssl_certificate_key /path/to/key.pem;
    
    location / {
        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }
}
```

## 驗證部署

### 檢查容器狀態

```bash
# 查看容器日誌
docker logs nextjs-frontend

# 查看容器狀態
docker ps | grep nextjs
```

### 測試訪問

```bash
# 本地測試
curl http://localhost:3000

# 域名測試
curl https://www.example.com
```

## 常見問題

| 問題 | 原因 | 解決方案 |
|------|------|----------|
| 啓動失敗 | 缺少 standalone 配置 | 添加 `output: 'standalone'` |
| 靜態資源 404 | 未複製 static 目錄 | 檢查 Dockerfile COPY 命令 |
| 環境變量不生效 | 使用了 NEXT_PUBLIC_ 前綴 | 構建時注入，或改用服務端變量 |
| 內存溢出 | 內存不足 | 增加服務器內存或優化代碼 |

## AI 協作指南

向 AI 描述 Next.js 部署問題時：

```
我的 Next.js 應用部署後訪問顯示 502，
使用 App Router，Next.js 版本 14.x，
容器日誌顯示：[具體錯誤信息]
請幫我分析原因。
```

**關鍵術語**：standalone、多階段構建、反向代理、NEXT_PUBLIC_ 環境變量
