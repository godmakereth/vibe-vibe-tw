---
title: "10.3.1 編排文件怎麼寫——Compose 文件結構：服務定義與依賴關係"
typora-root-url: ../../public
---

# 10.3.1 編排文件怎麼寫——Compose 文件結構：服務定義與依賴關係

一個 YAML 文件，定義整個應用棧。

## 文件結構概覽

```yaml
# docker-compose.yml 基本結構
services:     # 服務定義（必需）
  web:
    ...
  api:
    ...

volumes:      # 數據卷定義（可選）
  db-data:

networks:     # 網絡定義（可選）
  app-network:
```

## 完整示例：全棧應用

```yaml
services:
  # Next.js 前端
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://api:3001
    depends_on:
      - api

  # NestJS 後端
  api:
    build: ./api
    ports:
      - "3001:3001"
    environment:
      - DATABASE_URL=postgresql://postgres:password@postgres:5432/mydb
      - REDIS_URL=redis://redis:6379
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started

  # PostgreSQL 數據庫
  postgres:
    image: postgres:15
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=password
      - POSTGRES_DB=mydb
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis 緩存
  redis:
    image: redis:7-alpine
    volumes:
      - redis-data:/data

volumes:
  postgres-data:
  redis-data:
```

## 服務配置詳解

### 鏡像來源

```yaml
services:
  # 方式一：使用現有鏡像
  postgres:
    image: postgres:15

  # 方式二：從 Dockerfile 構建
  api:
    build: ./api
    # 或詳細配置
    build:
      context: ./api
      dockerfile: Dockerfile.prod
      args:
        - NODE_ENV=production
```

### 端口映射

```yaml
services:
  api:
    ports:
      - "3001:3001"           # 宿主機:容器
      - "127.0.0.1:3001:3001" # 僅本機訪問
    expose:
      - "3001"                # 僅容器間訪問，不對外
```

### 環境變量

```yaml
services:
  api:
    # 方式一：直接定義
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://...
    
    # 方式二：從文件加載
    env_file:
      - .env
      - .env.production
```

### 數據卷

```yaml
services:
  postgres:
    volumes:
      # 命名卷（推薦，Docker 管理）
      - postgres-data:/var/lib/postgresql/data
      # 綁定掛載（直接映射主機目錄）
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql:ro

volumes:
  postgres-data:  # 聲明命名卷
```

## 依賴關係配置

### 基本依賴

```yaml
services:
  api:
    depends_on:
      - postgres
      - redis
```

問題：`depends_on` 只保證啓動順序，不保證服務就緒。

### 帶健康檢查的依賴

```yaml
services:
  api:
    depends_on:
      postgres:
        condition: service_healthy  # 等待健康檢查通過
      redis:
        condition: service_started  # 只等待啓動
```

```mermaid
flowchart LR
    A[postgres 啓動] --> B[健康檢查通過]
    B --> C[api 啓動]
    D[redis 啓動] --> C
```

## 重啓策略

```yaml
services:
  api:
    restart: always  # 總是重啓

# 可選值
# no          - 不重啓（默認）
# always      - 總是重啓
# on-failure  - 僅失敗時重啓
# unless-stopped - 除非手動停止
```

## 資源限制

```yaml
services:
  api:
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
```

## 文件組織最佳實踐

```
project/
├── docker-compose.yml          # 基礎配置
├── docker-compose.override.yml # 開發環境覆蓋（自動加載）
├── docker-compose.prod.yml     # 生產環境配置
├── .env                        # 環境變量
├── frontend/
│   └── Dockerfile
└── api/
    └── Dockerfile
```

## 常見錯誤

| 錯誤 | 原因 | 解決方案 |
|------|------|----------|
| `service "api" depends on undefined service` | 依賴的服務名拼寫錯誤 | 檢查服務名 |
| `port is already allocated` | 端口被佔用 | 修改端口或停止佔用進程 |
| `volume "xxx" not found` | 卷未聲明 | 在 volumes 頂級鍵中聲明 |

## AI 協作指南

向 AI 描述需求時：

```
請幫我生成一個 docker-compose.yml，包含：
- Next.js 前端（端口 3000）
- NestJS 後端（端口 3001）
- PostgreSQL 數據庫
- Redis 緩存
要求：後端等待數據庫健康後再啓動，數據需要持久化
```

**關鍵術語**：services、depends_on、healthcheck、volumes、networks
