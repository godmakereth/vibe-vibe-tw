---
title: "10.3.3 開發和生產用一套配置嗎——環境隔離：開發/測試/生產配置差異"
typora-root-url: ../../public
---

# 10.3.3 開發和生產用一套配置嗎——環境隔離：開發/測試/生產配置差異

一套基礎配置 + 環境覆蓋 = 多環境部署。

## 多環境策略

```mermaid
flowchart LR
    A[docker-compose.yml] --> B[基礎配置]
    B --> C[開發環境]
    B --> D[測試環境]
    B --> E[生產環境]
    
    C --> C1[熱重載\n調試端口\n本地卷]
    D --> D1[測試數據庫\n隔離網絡]
    E --> E1[優化鏡像\n資源限制\n健康檢查]
```

## 文件組織

```
project/
├── docker-compose.yml          # 基礎配置
├── docker-compose.override.yml # 開發環境（自動加載）
├── docker-compose.prod.yml     # 生產環境
├── docker-compose.test.yml     # 測試環境
├── .env                        # 通用環境變量
├── .env.development            # 開發環境變量
├── .env.production             # 生產環境變量
└── .env.test                   # 測試環境變量
```

## 基礎配置

```yaml
# docker-compose.yml - 所有環境共享的基礎配置
services:
  api:
    image: my-api:${TAG:-latest}
    environment:
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_URL=${REDIS_URL}
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
    volumes:
      - postgres-data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine

volumes:
  postgres-data:
```

## 開發環境覆蓋

```yaml
# docker-compose.override.yml - 自動與 docker-compose.yml 合併
services:
  api:
    build: ./api              # 開發時從本地構建
    volumes:
      - ./api:/app            # 代碼熱重載
      - /app/node_modules
    command: npm run dev      # 開發模式啓動
    ports:
      - "3001:3001"
      - "9229:9229"           # Node.js 調試端口

  postgres:
    ports:
      - "5432:5432"           # 開發時暴露端口，方便調試
```

::: tip 自動加載
運行 `docker compose up` 時，如果存在 `docker-compose.override.yml`，會自動與 `docker-compose.yml` 合併。
:::

## 生產環境配置

```yaml
# docker-compose.prod.yml
services:
  api:
    image: registry.cn-hangzhou.aliyuncs.com/xxx/my-api:${TAG}
    restart: always
    deploy:
      resources:
        limits:
          cpus: '1'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    # 生產環境不映射端口，通過反向代理訪問

  postgres:
    restart: always
    # 生產環境不暴露數據庫端口
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
```

## 啓動不同環境

```bash
# 開發環境（默認加載 override）
docker compose up

# 生產環境
docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

# 測試環境
docker compose -f docker-compose.yml -f docker-compose.test.yml up
```

## 環境變量管理

### .env 文件

```env
# .env - 通用配置
COMPOSE_PROJECT_NAME=myapp
```

```env
# .env.development
DATABASE_URL=postgresql://postgres:devpass@postgres:5432/mydb
REDIS_URL=redis://redis:6379
POSTGRES_PASSWORD=devpass
NODE_ENV=development
```

```env
# .env.production
DATABASE_URL=postgresql://postgres:${POSTGRES_PASSWORD}@postgres:5432/mydb
REDIS_URL=redis://redis:6379
NODE_ENV=production
# POSTGRES_PASSWORD 從密鑰管理服務獲取，不寫在文件中
```

### 使用環境變量文件

```bash
# 開發環境
docker compose --env-file .env.development up

# 生產環境
docker compose --env-file .env.production -f docker-compose.yml -f docker-compose.prod.yml up -d
```

## 配置差異對比

| 配置項 | 開發環境 | 生產環境 |
|--------|----------|----------|
| 鏡像來源 | 本地構建 | 遠程倉庫 |
| 代碼掛載 | 是（熱重載） | 否 |
| 端口暴露 | 全部暴露 | 僅必要端口 |
| 調試端口 | 開啓 | 關閉 |
| 日誌級別 | debug | info/warn |
| 資源限制 | 無 | 有 |
| 健康檢查 | 可選 | 必須 |
| 重啓策略 | no | always |

## 配置覆蓋規則

當多個 Compose 文件合併時：

```yaml
# docker-compose.yml
services:
  api:
    image: my-api:latest
    environment:
      - NODE_ENV=development

# docker-compose.prod.yml
services:
  api:
    image: my-api:v1.0.0     # 覆蓋鏡像
    environment:
      - NODE_ENV=production  # 覆蓋環境變量
      - LOG_LEVEL=info       # 新增環境變量
```

合併結果：
```yaml
services:
  api:
    image: my-api:v1.0.0
    environment:
      - NODE_ENV=production
      - LOG_LEVEL=info
```

## 最佳實踐

1. **敏感信息不入庫**：`.env.production` 只放模板，真實值通過 CI/CD 注入
2. **使用變量替換**：`${VAR:-default}` 提供默認值
3. **環境標識清晰**：通過 `COMPOSE_PROJECT_NAME` 區分環境
4. **配置版本化**：所有 compose 文件都納入版本控制（除了包含密碼的 .env）
