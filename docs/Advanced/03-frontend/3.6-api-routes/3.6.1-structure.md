---
title: "3.6.1 你的 API 長啥樣——API Route 結構：GET/POST/PUT/DELETE 處理"
typora-root-url: ../../public
---

# 3.6.1 你的 API 長啥樣——API Route 結構

### 一句話破題

在 App Router 中，`route.ts` 文件通過導出命名函數來定義 API 端點，函數名即 HTTP 方法。

### 核心價值

Next.js Route Handler 讓你無需搭建獨立的後端服務器，就能在同一個項目中實現 API。這對於全棧應用和快速原型開發非常便利。

### 創建 Route Handler

在 `app` 目錄下創建 `route.ts` 文件：

```
app/
└── api/
    └── posts/
        ├── route.ts          # /api/posts
        └── [id]/
            └── route.ts      # /api/posts/:id
```

### 基礎語法

```tsx
// app/api/posts/route.ts

// GET /api/posts - 獲取列表
export async function GET(request: Request) {
  const posts = await prisma.post.findMany()
  return Response.json(posts)
}

// POST /api/posts - 創建資源
export async function POST(request: Request) {
  const body = await request.json()
  const post = await prisma.post.create({ data: body })
  return Response.json(post, { status: 201 })
}
```

```tsx
// app/api/posts/[id]/route.ts

// GET /api/posts/:id - 獲取單個資源
export async function GET(
  request: Request,
  { params }: { params: { id: string } }
) {
  const post = await prisma.post.findUnique({
    where: { id: params.id }
  })
  
  if (!post) {
    return Response.json({ error: 'Not found' }, { status: 404 })
  }
  
  return Response.json(post)
}

// PUT /api/posts/:id - 更新資源
export async function PUT(
  request: Request,
  { params }: { params: { id: string } }
) {
  const body = await request.json()
  const post = await prisma.post.update({
    where: { id: params.id },
    data: body
  })
  return Response.json(post)
}

// DELETE /api/posts/:id - 刪除資源
export async function DELETE(
  request: Request,
  { params }: { params: { id: string } }
) {
  await prisma.post.delete({ where: { id: params.id } })
  return new Response(null, { status: 204 })
}
```

### HTTP 方法對照表

| 方法 | 用途 | 冪等性 | 請求體 |
|------|------|--------|--------|
| **GET** | 讀取資源 | 是 | 否 |
| **POST** | 創建資源 | 否 | 是 |
| **PUT** | 完整更新 | 是 | 是 |
| **PATCH** | 部分更新 | 是 | 是 |
| **DELETE** | 刪除資源 | 是 | 否 |

### 讀取請求數據

**獲取 JSON 請求體**：

```tsx
export async function POST(request: Request) {
  const body = await request.json()
  // body = { title: "Hello", content: "World" }
}
```

**獲取 URL 查詢參數**：

```tsx
export async function GET(request: Request) {
  const { searchParams } = new URL(request.url)
  const page = searchParams.get('page') || '1'
  const limit = searchParams.get('limit') || '10'
  // /api/posts?page=2&limit=20
}
```

**獲取請求頭**：

```tsx
export async function GET(request: Request) {
  const authHeader = request.headers.get('Authorization')
  const contentType = request.headers.get('Content-Type')
}
```

**獲取路由參數**：

```tsx
export async function GET(
  request: Request,
  { params }: { params: { id: string; slug: string } }
) {
  // /api/posts/123/comments/abc
  // params = { id: '123', slug: 'abc' }
}
```

### 返回響應

**JSON 響應**：

```tsx
// 簡寫
return Response.json({ data: posts })

// 完整寫法（可設置更多選項）
return new Response(JSON.stringify({ data: posts }), {
  status: 200,
  headers: {
    'Content-Type': 'application/json',
  },
})
```

**狀態碼規範**：

| 狀態碼 | 含義 | 使用場景 |
|--------|------|----------|
| 200 | OK | GET 成功、PUT/PATCH 成功 |
| 201 | Created | POST 創建成功 |
| 204 | No Content | DELETE 成功 |
| 400 | Bad Request | 請求參數錯誤 |
| 401 | Unauthorized | 未認證 |
| 403 | Forbidden | 無權限 |
| 404 | Not Found | 資源不存在 |
| 409 | Conflict | 資源衝突 |
| 500 | Internal Error | 服務器錯誤 |

### 配置路由行爲

```tsx
// 強制動態渲染（每次請求都執行）
export const dynamic = 'force-dynamic'

// 設置緩存時間
export const revalidate = 60 // 秒

// 允許的 HTTP 方法（其他方法返回 405）
export async function GET() { ... }
export async function POST() { ... }
```

### RESTful 設計最佳實踐

**URL 設計**：

```
GET    /api/posts          # 列表
POST   /api/posts          # 創建
GET    /api/posts/:id      # 詳情
PUT    /api/posts/:id      # 更新
DELETE /api/posts/:id      # 刪除

GET    /api/posts/:id/comments    # 嵌套資源
POST   /api/posts/:id/comments
```

**響應格式統一**：

```tsx
// 成功響應
{
  "data": { ... },
  "meta": { "total": 100, "page": 1 }
}

// 錯誤響應
{
  "error": {
    "code": "VALIDATION_ERROR",
    "message": "標題不能爲空"
  }
}
```

### AI 協作指南

**核心意圖**：讓 AI 生成符合 RESTful 規範的 API。

**需求定義公式**：
- 功能描述：創建 [資源名] 的 CRUD API
- URL 規範：遵循 RESTful 設計
- 響應格式：統一的 JSON 結構

**關鍵術語**：`Route Handler`、`params`、`searchParams`、`Response.json`

**示例 Prompt**：

```
請創建一個 /api/users 的 CRUD API：
- GET /api/users - 分頁列表，支持 ?page 和 ?limit
- POST /api/users - 創建用戶
- GET /api/users/:id - 獲取用戶詳情
- PUT /api/users/:id - 更新用戶
- DELETE /api/users/:id - 刪除用戶
使用統一的響應格式和錯誤處理
```

### 避坑指南

1. **route.ts 和 page.tsx 不能共存**：同一目錄下只能有其中一個
2. **動態參數是字符串**：`params.id` 是字符串，需要時要轉換類型
3. **注意緩存行爲**：GET 請求默認可能被緩存，需要動態數據時設置 `dynamic = 'force-dynamic'`
4. **處理 CORS**：跨域請求需要設置響應頭

```tsx
const headers = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
}
```

### 驗收清單

- [ ] API 路徑遵循 RESTful 規範
- [ ] HTTP 方法使用正確
- [ ] 狀態碼符合語義
- [ ] 響應格式統一
