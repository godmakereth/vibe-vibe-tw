---
title: "5.3.3 代碼中的安全隱患"
order: 5
---

# 5.3.3 代碼中的安全隱患

經過本節學習，你將掌握：
- AI 常犯的 5 類安全錯誤
- 如何識別代碼中的硬編碼密鑰
- .env 文件的正確使用方法
- .gitignore 的配置技巧

## AI 常犯的 5 類安全錯誤

根據 Veracode 2025 報告和安全社區的分析，AI 生成的代碼最常出現以下安全問題：

### 1. 硬編碼密鑰

這是最常見也最危險的問題。

```javascript
// ❌ 危險：密鑰直接寫在代碼裏
const API_KEY = "sk-proj-abc123xyz...";
const DB_PASSWORD = "SuperSecret123";

// ✅ 安全：使用環境變量
const API_KEY = process.env.API_KEY;
const DB_PASSWORD = process.env.DB_PASSWORD;
```

### 2. 跳過輸入驗證

AI 生成的代碼往往假設輸入是"正常"的，不做驗證。

```javascript
// ❌ 危險：直接使用用戶輸入
function searchUser(username) {
  return db.query(`SELECT * FROM users WHERE name = '${username}'`);
}
// 攻擊者可以輸入：' OR '1'='1  來獲取所有用戶數據

// ✅ 安全：使用參數化查詢
function searchUser(username) {
  return db.query('SELECT * FROM users WHERE name = $1', [username]);
}
```

### 3. 使用不安全的默認配置

```javascript
// ❌ 危險：允許所有來源的跨域請求
app.use(cors({ origin: '*' }));

// ✅ 安全：只允許特定來源
app.use(cors({ origin: 'https://yoursite.com' }));
```

### 4. 信息過度暴露

```javascript
// ❌ 危險：向用戶暴露詳細錯誤信息
app.use((err, req, res, next) => {
  res.status(500).json({ 
    error: err.message,
    stack: err.stack,  // 暴露了代碼結構
    dbQuery: err.query // 暴露了數據庫查詢
  });
});

// ✅ 安全：只返回必要信息
app.use((err, req, res, next) => {
  console.error(err);  // 在服務器端記錄詳細信息
  res.status(500).json({ error: '服務器錯誤，請稍後重試' });
});
```

### 5. 使用過時或存在漏洞的庫

AI 可能推薦一些過時的、存在已知漏洞的庫。這個問題我們會在 5.3.5 節詳細討論。

## 如何識別硬編碼的密鑰

在代碼中搜索這些關鍵詞：

| 關鍵詞 | 可能是什麼 |
|--------|-----------|
| `password`、`passwd`、`pwd` | 密碼 |
| `secret`、`api_key`、`apikey` | API 密鑰 |
| `token`、`auth`、`bearer` | 認證令牌 |
| `sk-`、`pk-`、`AKIA` | 特定服務的密鑰（OpenAI、AWS 等） |
| `-----BEGIN` | 私鑰或證書 |

**快速檢查方法**：

在你的項目文件夾中搜索這些模式。如果看到後面跟着一串看起來像真實密鑰的字符串（而不是 `process.env.XXX`），就需要警惕。

## 使用 .env 文件存放敏感信息

`.env` 文件是存放敏感配置的標準方式。

### 創建 .env 文件

在項目根目錄創建 `.env` 文件：

```bash
# .env 文件示例
# API 密鑰
OPENAI_API_KEY=sk-proj-你的真實密鑰
STRIPE_SECRET_KEY=sk_test_你的真實密鑰

# 數據庫連接
DATABASE_URL=postgres://user:password@localhost:5432/mydb

# 其他配置
NODE_ENV=development
```

### 在代碼中讀取環境變量

```javascript
// JavaScript/Node.js
const apiKey = process.env.OPENAI_API_KEY;
```

```python
# Python
import os
api_key = os.environ.get('OPENAI_API_KEY')
```

### 創建 .env.example 文件

爲了讓其他人（或未來的你）知道需要配置哪些環境變量，創建一個 `.env.example` 文件：

```bash
# .env.example - 這個文件可以提交到 Git
# 複製此文件爲 .env，然後填入真實值

OPENAI_API_KEY=在這裏填入你的密鑰
STRIPE_SECRET_KEY=在這裏填入你的密鑰
DATABASE_URL=在這裏填入數據庫連接字符串
```

## 配置 .gitignore 防止泄露

`.gitignore` 文件告訴 Git 哪些文件不應該被上傳。

在項目根目錄創建或編輯 `.gitignore` 文件：

```bash
# 環境變量文件 - 最重要！
.env
.env.local
.env.development
.env.production
.env*.local

# 依賴文件夾
node_modules/
venv/
__pycache__/

# 編輯器和系統文件
.DS_Store
Thumbs.db
.vscode/
.idea/

# 構建產物
dist/
build/
*.log
```

::: warning 注意
如果你在添加 `.gitignore` 之前已經提交過 `.env` 文件，僅僅添加 `.gitignore` 是不夠的。

你需要：
1. 從 Git 歷史中刪除該文件
2. **立即更換所有已泄露的密鑰**

因爲 Git 歷史是可以被查看的，即使文件被刪除。
:::

## 檢查你的待辦清單項目

回顧你在第四章做的待辦清單，檢查以下幾點：

- [ ] 代碼中沒有硬編碼的密鑰或密碼
- [ ] 如果有 API 調用，密鑰是從環境變量讀取的
- [ ] `.env` 文件（如果有）已經加入 `.gitignore`
- [ ] 沒有在 console.log 中輸出敏感信息

如果只是一個純前端的待辦清單（使用 localStorage），通常不會有這些問題。但養成檢查習慣很重要，因爲你以後的項目會越來越複雜。

→ [5.3.4 初學者安全檢查清單](./5.3.4-checklist.md)
